import{_ as Ge,k as Xe,u as Ke,a as qe,J as Qe,K as fe,o as We,L as et,r as g,b as y,c as E,d as t,w as a,n as o,g as _,e as m,m as A,a5 as p,a6 as x,z as I,a7 as me,x as tt,P as lt,H as ve,I as pe,f as P,a8 as he,a9 as B,A as Y,aa as at,ab as ye,ac as ot,ad as nt,ae as T,af as st,ag as it,ah as rt,E as d,h as ut}from"./index-86929dc7.js";import{m as R}from"./editor-d0af8eeb.js";import{A as dt}from"./AIModuleButton-8aa27d40.js";const ct={class:"mindmap-editor"},ft={class:"editor-header"},mt={class:"header-left"},vt={class:"header-right"},pt={class:"operation-buttons"},ht={class:"mindmap-container"},yt=["x1","y1","x2","y2"],gt=["transform","onMousedown","onDblclick"],_t=["width","height","fill","stroke"],St=["x","y","fill","font-size"],xt={key:0,class:"node-edit-panel"},wt={class:"edit-buttons"},kt={class:"style-buttons"},bt={key:0,class:"editor-footer"},Ct={class:"save-status"},Nt={style:{display:"flex","align-items":"center",gap:"8px"}},It=["href"],Vt=50,Mt={__name:"MindmapEditor",props:{isNew:{type:Boolean,default:!1},mindmapId:{type:Number,default:null},isShared:{type:Boolean,default:!1},sharePermission:{type:String,default:"view"},sharedMindmap:{type:Object,default:null}},setup(u){const z=u,ge=Xe(),le=Ke(),ae=z.mindmapId||ge.params.id,_e=qe(),h=_({id:null,title:"",data:{},is_public:!1}),c=_([{id:1,text:"中心主题",x:400,y:300,width:120,height:40,parentId:null}]),w=_([]),s=_(null),J=_(""),S=_({fontSize:14,fontColor:"#333",bgColor:"#fff"}),j=_(null),G=_(null),U=_("未保存"),b=_(1),V=_([]),M=_(-1),X=_(!1),O=_({permission:"view",expire_at:""}),K=Qe();fe(()=>K.hasNewContent,e=>{if(e){try{let l=K.generatedContent,r=l;const v=l.match(/```json[\s\S]*?```/);if(v)r=v[0].replace(/```json\s*/,"").replace(/\s*```/,"");else{const i=l.match(/```[\s\S]*?```/);i&&(r=i[0].replace(/```\s*/,"").replace(/\s*```/,""))}if(r=r.trim(),!r){d.error("AI未生成有效的脑图数据");return}try{const i=JSON.parse(r);i.nodes&&Array.isArray(i.nodes)&&i.edges&&Array.isArray(i.edges)?(c.value=i.nodes,w.value=i.edges,D=Math.max(...c.value.map(f=>f.id),1)+1,F(!0),d.success("AI生成的脑图已成功加载")):d.error("AI生成的脑图格式不正确")}catch(i){console.error("JSON解析失败:",i),console.error("原始JSON内容:",r);try{const C=r.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,""),f=JSON.parse(C);if(f.nodes&&Array.isArray(f.nodes)&&f.edges&&Array.isArray(f.edges)){c.value=f.nodes,w.value=f.edges,D=Math.max(...c.value.map(te=>te.id),1)+1,F(!0),d.success("AI生成的脑图已成功加载（已修复格式）");return}}catch(C){console.error("修复JSON格式失败:",C)}d.error("解析AI生成的脑图失败，JSON格式不正确")}}catch(l){console.error("解析AI脑图数据失败:",l),d.error("解析AI生成的脑图失败")}K.resetGeneratedContent()}});const oe=_([]);let D=2,$=!1,L=null,q={x:0,y:0};function Se(){M.value<V.value.length-1&&(V.value=V.value.slice(0,M.value+1));const e={nodes:JSON.parse(JSON.stringify(c.value)),edges:JSON.parse(JSON.stringify(w.value))};V.value.push(e),V.value.length>Vt?V.value.shift():M.value++}function xe(){if(M.value>0){M.value--;const e=V.value[M.value];c.value=JSON.parse(JSON.stringify(e.nodes)),w.value=JSON.parse(JSON.stringify(e.edges)),k()}}function we(){if(M.value<V.value.length-1){M.value++;const e=V.value[M.value];c.value=JSON.parse(JSON.stringify(e.nodes)),w.value=JSON.parse(JSON.stringify(e.edges)),k()}}function ke(){if(!s.value){d.warning("请先选择一个节点");return}const e=s.value;e.y-=50,k()}function be(){if(!s.value){d.warning("请先选择一个节点");return}const e=s.value;e.y+=50,k()}function Ce(){b.value<2&&(b.value+=.1,Q())}function Ne(){b.value>.5&&(b.value-=.1,Q())}function Ie(){b.value=1,Q()}function Q(){G.value&&G.value.setAttribute("transform",`scale(${b.value})`)}async function Ve(){if(!z.isNew)try{let e;z.isShared&&z.sharedMindmap?e=z.sharedMindmap:z.isShared?e=(await R.getShared(ae)).data:e=(await R.get(ae)).data,h.value=e,e.data&&e.data.nodes&&(c.value=e.data.nodes,w.value=e.data.edges||[],Array.isArray(c.value)&&c.value.length>0?D=Math.max(...c.value.map(l=>l.id))+1:D=1)}catch(e){console.error("Load mindmap error:",e)}}function k(){Se(),U.value="正在保存...",setTimeout(()=>{F(!0)},2e3)}async function F(e=!1){try{if(!localStorage.getItem("token")){U.value="保存失败",e||d.error("请先登录"),le.push("/login");return}const r={title:h.value.title||"新脑图",data:{nodes:JSON.parse(JSON.stringify(c.value)),edges:JSON.parse(JSON.stringify(w.value))},is_public:h.value.is_public};if(h.value.id)await R.update(h.value.id,r);else{const v=await R.create(r);h.value.id=v.data.id,h.value.title=v.data.title}U.value="已保存",e||d.success("保存成功")}catch(l){console.error("Save mindmap error:",l),U.value="保存失败",l.response&&l.response.status===401?(localStorage.removeItem("token"),localStorage.removeItem("user"),e||d.error("登录已过期，请重新登录"),le.push("/login")):e||d.error("保存失败")}}function H(e){const l=c.value.find(r=>r.id===e);return l?{x:l.x+l.width/2,y:l.y+l.height/2}:{x:0,y:0}}function Me(){let e=s.value;e||(e=c.value.find(N=>N.parentId===null),e||(e={id:D++,text:"中心主题",x:400,y:100,width:120,height:40,parentId:null},c.value.push(e)));const l=c.value.filter(N=>N.parentId===e.id),r=l.length,v=60,i=180;let C=e.y-r*v/2;r>0&&(C=l[l.length-1].y+v);const f={id:D++,text:"新节点",x:e.x+i,y:C,width:100,height:40,parentId:e.id};c.value.push(f),w.value.push({from:e.id,to:f.id}),k()}function Oe(){if(!s.value){d.warning("请先选择一个节点");return}const e=s.value.id;function l(v){const i=[];return c.value.filter(f=>f.parentId===v).forEach(f=>{i.push(f.id),i.push(...l(f.id))}),i}const r=[e,...l(e)];c.value=c.value.filter(v=>!r.includes(v.id)),w.value=w.value.filter(v=>!r.includes(v.from)&&!r.includes(v.to)),s.value=null,k()}function Ee(e,l){s.value=e,$=!0,L=e;const r=j.value.getBoundingClientRect();q={x:l.clientX-r.left-e.x*b.value,y:l.clientY-r.top-e.y*b.value}}function Ae(e){s.value=e,J.value=e.text}function Je(){if(s.value){s.value.text=J.value;const e=J.value.length;s.value.width=Math.max(100,e*10),k()}}function Re(){s.value&&(s.value.fontSize=S.value.fontSize,s.value.fontColor=S.value.fontColor,s.value.bgColor=S.value.bgColor,k())}function ze(){s.value&&(J.value=s.value.text,ne())}function ne(){s.value&&(S.value.fontSize=s.value.fontSize||14,S.value.fontColor=s.value.fontColor||"#333",S.value.bgColor=s.value.bgColor||"#fff")}fe(s,e=>{e&&(J.value=e.text,ne())},{immediate:!0});function De(e){e.target.tagName==="svg"&&(s.value=null)}function se(e){if(!$||!L)return;const l=j.value.getBoundingClientRect();L.x=(e.clientX-l.left-q.x)/b.value,L.y=(e.clientY-l.top-q.y)/b.value}function ie(){$&&($=!1,L=null,k())}We(()=>{_e.initFromStorage(),Ve(),document.addEventListener("mousemove",se),document.addEventListener("mouseup",ie)});async function Pe(){if(!h.value.id){d.error("请先保存脑图");return}X.value=!0,await W()}async function Ue(){if(!h.value.id){d.error("请先保存脑图");return}try{const e=await R.share(h.value.id,{permission:O.value.permission,expire_at:O.value.expire_at});d.success("分享链接创建成功"),await W(),O.value={permission:"view",expire_at:""}}catch(e){console.error("创建分享链接失败:",e),d.error("创建分享链接失败")}}async function W(){if(h.value.id)try{const e=await R.getShares(h.value.id);oe.value=e}catch(e){console.error("加载分享链接失败:",e),d.error("加载分享链接失败")}}async function Le(e){try{await R.deleteShare(e),d.success("分享链接已删除"),await W()}catch(l){console.error("删除分享链接失败:",l),d.error("删除分享链接失败")}}function ee(e){return window.location.origin+e}async function Be(e){const l=ee(e);try{await navigator.clipboard.writeText(l),d.success("分享链接已复制到剪贴板")}catch(r){console.error("复制失败:",r),d.error("复制失败，请手动复制")}}return et(()=>{document.removeEventListener("mousemove",se),document.removeEventListener("mouseup",ie)}),(e,l)=>{const r=g("el-input"),v=g("Plus"),i=g("el-tooltip"),C=g("Top"),f=g("Bottom"),N=g("el-divider"),te=g("RefreshLeft"),Ye=g("RefreshRight"),Te=g("ZoomIn"),$e=g("ZoomOut"),Fe=g("Refresh"),He=g("el-input-number"),re=g("el-color-picker"),Ze=g("el-switch"),je=g("el-card");return y(),E("div",ct,[t(je,{class:"mindmap-editor"},{header:a(()=>[m("div",ft,[m("div",mt,[t(r,{modelValue:h.value.title,"onUpdate:modelValue":l[0]||(l[0]=n=>h.value.title=n),placeholder:"请输入脑图标题",style:{width:"300px","margin-left":"20px"},onInput:k},null,8,["modelValue"])]),m("div",vt,[m("div",pt,[!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:0,content:"添加子节点",placement:"top"},{default:a(()=>[t(o(p),{onClick:Me},{default:a(()=>[t(o(x),null,{default:a(()=>[t(v)]),_:1})]),_:1})]),_:1})):I("",!0),!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:1,content:"删除节点",placement:"top"},{default:a(()=>[t(o(p),{onClick:Oe},{default:a(()=>[t(o(x),null,{default:a(()=>[t(o(me))]),_:1})]),_:1})]),_:1})):I("",!0),!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:2,content:"节点上移",placement:"top"},{default:a(()=>[t(o(p),{onClick:ke},{default:a(()=>[t(o(x),null,{default:a(()=>[t(C)]),_:1})]),_:1})]),_:1})):I("",!0),!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:3,content:"节点下移",placement:"top"},{default:a(()=>[t(o(p),{onClick:be},{default:a(()=>[t(o(x),null,{default:a(()=>[t(f)]),_:1})]),_:1})]),_:1})):I("",!0),t(N,{direction:"vertical"}),!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:4,content:"撤销",placement:"top"},{default:a(()=>[t(o(p),{onClick:xe},{default:a(()=>[t(o(x),null,{default:a(()=>[t(te)]),_:1})]),_:1})]),_:1})):I("",!0),!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:5,content:"重做",placement:"top"},{default:a(()=>[t(o(p),{onClick:we},{default:a(()=>[t(o(x),null,{default:a(()=>[t(Ye)]),_:1})]),_:1})]),_:1})):I("",!0),t(N,{direction:"vertical"}),t(i,{content:"放大",placement:"top"},{default:a(()=>[t(o(p),{onClick:Ce},{default:a(()=>[t(o(x),null,{default:a(()=>[t(Te)]),_:1})]),_:1})]),_:1}),t(i,{content:"缩小",placement:"top"},{default:a(()=>[t(o(p),{onClick:Ne},{default:a(()=>[t(o(x),null,{default:a(()=>[t($e)]),_:1})]),_:1})]),_:1}),t(i,{content:"重置缩放",placement:"top"},{default:a(()=>[t(o(p),{onClick:Ie},{default:a(()=>[t(o(x),null,{default:a(()=>[t(Fe)]),_:1})]),_:1})]),_:1}),t(N,{direction:"vertical"}),u.isShared?I("",!0):(y(),A(i,{key:6,content:"分享",placement:"top"},{default:a(()=>[t(o(p),{onClick:Pe},{default:a(()=>[t(o(x),null,{default:a(()=>[t(o(tt))]),_:1})]),_:1})]),_:1})),t(N,{direction:"vertical"}),t(dt),!u.isShared||u.sharePermission==="edit"?(y(),A(i,{key:7,content:"保存",placement:"top"},{default:a(()=>[t(o(p),{type:"primary",onClick:F},{default:a(()=>[t(o(x),null,{default:a(()=>[t(o(lt))]),_:1})]),_:1})]),_:1})):I("",!0)])])])]),default:a(()=>[m("div",ht,[(y(),E("svg",{ref_key:"svgRef",ref:j,class:"mindmap-svg",onMousedown:De},[m("g",{ref_key:"zoomGroupRef",ref:G},[(y(!0),E(ve,null,pe(w.value,n=>(y(),E("line",{key:`${n.from}-${n.to}`,x1:H(n.from).x,y1:H(n.from).y,x2:H(n.to).x,y2:H(n.to).y,stroke:"#999","stroke-width":"2"},null,8,yt))),128)),(y(!0),E(ve,null,pe(c.value,n=>{var Z,ue,de;return y(),E("g",{key:n.id,transform:`translate(${n.x}, ${n.y})`,class:"node-group",onMousedown:ut(ce=>!u.isShared||u.sharePermission==="edit"?Ee(n,ce):null,["stop"]),onDblclick:ce=>!u.isShared||u.sharePermission==="edit"?Ae(n):null},[m("rect",{width:n.width,height:n.height,fill:((Z=s.value)==null?void 0:Z.id)===n.id?"#409eff":n.bgColor||"#fff",stroke:((ue=s.value)==null?void 0:ue.id)===n.id?"#409eff":"#333","stroke-width":"2",rx:"5"},null,8,_t),m("text",{x:n.width/2,y:n.height/2,"text-anchor":"middle","dominant-baseline":"middle",fill:((de=s.value)==null?void 0:de.id)===n.id?"#fff":n.fontColor||"#333","font-size":n.fontSize||14},Y(n.text),9,St)],40,gt)}),128))],512)],544)),s.value&&(!u.isShared||u.sharePermission==="edit")?(y(),E("div",xt,[l[12]||(l[12]=m("h4",null,"编辑节点",-1)),t(r,{modelValue:J.value,"onUpdate:modelValue":l[1]||(l[1]=n=>J.value=n),placeholder:"输入节点文本",type:"textarea",rows:3,style:{"margin-bottom":"10px"}},null,8,["modelValue"]),m("div",wt,[t(o(p),{type:"primary",onClick:Je},{default:a(()=>[...l[9]||(l[9]=[P("保存",-1)])]),_:1}),t(o(p),{onClick:ze},{default:a(()=>[...l[10]||(l[10]=[P("取消",-1)])]),_:1})]),l[13]||(l[13]=m("h4",{style:{"margin-top":"20px"}},"文字样式",-1)),t(o(he),{model:S.value,"label-width":"80px"},{default:a(()=>[t(o(B),{label:"字体大小"},{default:a(()=>[t(He,{modelValue:S.value.fontSize,"onUpdate:modelValue":l[2]||(l[2]=n=>S.value.fontSize=n),min:12,max:36,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(o(B),{label:"字体颜色"},{default:a(()=>[t(re,{modelValue:S.value.fontColor,"onUpdate:modelValue":l[3]||(l[3]=n=>S.value.fontColor=n),"show-alpha":""},null,8,["modelValue"])]),_:1}),t(o(B),{label:"背景颜色"},{default:a(()=>[t(re,{modelValue:S.value.bgColor,"onUpdate:modelValue":l[4]||(l[4]=n=>S.value.bgColor=n),"show-alpha":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),m("div",kt,[t(o(p),{type:"primary",onClick:Re},{default:a(()=>[...l[11]||(l[11]=[P("应用样式",-1)])]),_:1})])])):I("",!0)]),u.isShared?I("",!0):(y(),E("div",bt,[m("span",Ct,Y(U.value),1),t(Ze,{modelValue:h.value.is_public,"onUpdate:modelValue":l[5]||(l[5]=n=>h.value.is_public=n),"active-text":"公开","inactive-text":"私有",onChange:k},null,8,["modelValue"])]))]),_:1}),t(o(rt),{modelValue:X.value,"onUpdate:modelValue":l[8]||(l[8]=n=>X.value=n),title:"分享脑图",width:"600px"},{default:a(()=>[m("div",null,[l[15]||(l[15]=m("h4",null,"创建新分享链接",-1)),t(o(he),{model:O.value,"label-width":"100px",style:{"margin-bottom":"20px"}},{default:a(()=>[t(o(B),{label:"权限"},{default:a(()=>[t(o(at),{modelValue:O.value.permission,"onUpdate:modelValue":l[6]||(l[6]=n=>O.value.permission=n),placeholder:"请选择权限",style:{width:"200px"}},{default:a(()=>[t(o(ye),{label:"只读",value:"view"}),t(o(ye),{label:"可编辑",value:"edit"})]),_:1},8,["modelValue"])]),_:1}),t(o(B),{label:"过期时间"},{default:a(()=>[t(o(ot),{modelValue:O.value.expire_at,"onUpdate:modelValue":l[7]||(l[7]=n=>O.value.expire_at=n),type:"datetime",placeholder:"选择过期时间",style:{width:"200px"},format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),t(o(p),{type:"primary",onClick:Ue},{default:a(()=>[...l[14]||(l[14]=[P("创建分享链接",-1)])]),_:1}),l[16]||(l[16]=m("h4",{style:{"margin-top":"30px"}},"已创建的分享链接",-1)),t(o(nt),{data:oe.value,style:{width:"100%"}},{default:a(()=>[t(o(T),{prop:"share_url",label:"分享链接","min-width":"250"},{default:a(n=>[m("div",Nt,[m("a",{href:ee(n.row.share_url),target:"_blank",style:{flex:"1",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},Y(ee(n.row.share_url)),9,It),t(o(p),{size:"small",onClick:Z=>Be(n.row.share_url)},{default:a(()=>[t(o(x),null,{default:a(()=>[t(o(st))]),_:1})]),_:1},8,["onClick"])])]),_:1}),t(o(T),{prop:"permission",label:"权限",width:"100"},{default:a(n=>[t(o(it),{type:n.row.permission==="view"?"info":"success"},{default:a(()=>[P(Y(n.row.permission==="view"?"只读":"可编辑"),1)]),_:2},1032,["type"])]),_:1}),t(o(T),{prop:"expire_at",label:"过期时间",width:"180"},{default:a(n=>[P(Y(n.row.expire_at||"永不过期"),1)]),_:1}),t(o(T),{prop:"created_at",label:"创建时间",width:"180"}),t(o(T),{label:"操作",width:"100"},{default:a(n=>[t(o(p),{type:"danger",size:"small",onClick:Z=>Le(n.row.token)},{default:a(()=>[t(o(x),null,{default:a(()=>[t(o(me))]),_:1})]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1},8,["modelValue"])])}}},Jt=Ge(Mt,[["__scopeId","data-v-401a9b62"]]);export{Jt as default};

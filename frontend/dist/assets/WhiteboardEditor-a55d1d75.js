import{_ as G,k as H,J as R,K as j,l as J,o as O,L as P,r as s,b as g,c as V,d as a,w as r,g as d,e as l,f as v,A,H as q,I as Q,E as c,m as X}from"./index-86929dc7.js";import{w as _}from"./editor-d0af8eeb.js";import{A as Y}from"./AIModuleButton-8aa27d40.js";const Z={class:"whiteboard-editor"},ee={class:"editor-header"},te={class:"header-left"},oe={class:"header-right"},ae={class:"whiteboard-container"},re=["src"],ne={class:"editor-footer"},se={class:"save-status"},le={class:"version-item"},ie={class:"version-content"},de={class:"version-actions"},ce={__name:"WhiteboardEditor",props:{isNew:{type:Boolean,default:!1}},setup(x){const I=x,B=H().params.id,o=d({id:null,title:"",room_key:"",data:{}}),f=d([]),w=d(!1),S=d(null),k=d(""),m=d("未保存");let i=null;const h=R();j(()=>h.hasNewContent,t=>{if(t){try{const e=h.generatedContent;o.value.title||(o.value.title="AI生成的白板"),ElMessageBox.alert(`<div style="max-height: 300px; overflow-y: auto;">
          <h4>AI生成的白板内容</h4>
          <pre style="white-space: pre-wrap; word-break: break-all;">${e}</pre>
          <p style="margin-top: 10px; color: #666;">请在白板中手动创建相关内容</p>
        </div>`,"AI内容提示",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",type:"success"}),c.success("AI生成的白板内容已准备就绪")}catch(e){console.error("处理AI白板内容失败:",e),c.error("处理AI生成的白板内容失败")}h.resetGeneratedContent()}});const T=J(()=>{let e=`http://localhost:8080/boards/${o.value.room_key||"new-whiteboard-"+Date.now()}`;return k.value&&(e+=`?token=${k.value}`),e});async function E(){try{const t=await fetch("/api/whiteboards/wbo-token",{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const e=await t.json();k.value=e.token}}catch(t){console.error("Failed to get WBO token:",t)}}async function $(){if(!I.isNew)try{const t=await _.get(B);o.value=t.data,await y()}catch(t){console.error("Load whiteboard error:",t)}}async function y(){if(o.value.id)try{const t=await _.getVersions(o.value.id);f.value=t.data||[]}catch(t){console.error("Load versions error:",t),f.value=[]}}function N(){m.value="正在保存...",i&&clearTimeout(i),i=setTimeout(()=>{C(!0)},2e3)}async function C(t=!1){i&&clearTimeout(i);try{const e={title:o.value.title||"新白板",room_key:o.value.room_key,data:{room_key:o.value.room_key}};if(o.value.id)await _.update(o.value.id,e);else{const u=await _.create(e);o.value.id=u.data.id,o.value.room_key=u.data.room_key,o.value.title=u.data.title}await y(),m.value="已保存",t||c.success("保存成功")}catch(e){console.error("Save whiteboard error:",e),m.value="保存失败",t||c.error("保存失败")}}async function M(t){try{await _.rollbackVersion(o.value.id,t.id),o.value.data=t.data,await y(),c.success("回滚成功")}catch(e){console.error("Rollback version error:",e),c.error("回滚失败")}}return O(async()=>{await E(),await $(),I.isNew&&!o.value.room_key&&(o.value.room_key="wb-"+Math.random().toString(36).substr(2,9))}),P(()=>{i&&clearTimeout(i)}),(t,e)=>{const u=s("Back"),b=s("el-icon"),p=s("el-button"),W=s("el-input"),L=s("Clock"),U=s("Check"),K=s("el-card"),z=s("el-timeline-item"),D=s("el-timeline"),F=s("el-drawer");return g(),V("div",Z,[a(K,null,{header:r(()=>[l("div",ee,[l("div",te,[a(p,{link:"",onClick:e[0]||(e[0]=n=>t.$router.back())},{default:r(()=>[a(b,null,{default:r(()=>[a(u)]),_:1}),e[4]||(e[4]=v(" 返回 ",-1))]),_:1}),a(W,{modelValue:o.value.title,"onUpdate:modelValue":e[1]||(e[1]=n=>o.value.title=n),placeholder:"请输入白板标题",style:{width:"300px","margin-left":"20px"},onInput:N},null,8,["modelValue"])]),l("div",oe,[a(Y),a(p,{link:"",onClick:e[2]||(e[2]=n=>w.value=!0)},{default:r(()=>[a(b,null,{default:r(()=>[a(L)]),_:1}),e[5]||(e[5]=v(" 版本历史 ",-1))]),_:1}),a(p,{type:"primary",onClick:C},{default:r(()=>[a(b,null,{default:r(()=>[a(U)]),_:1}),e[6]||(e[6]=v(" 保存 ",-1))]),_:1})])])]),default:r(()=>[l("div",ae,[l("iframe",{ref_key:"wboIframe",ref:S,class:"wbo-iframe",src:T.value,frameborder:"0",allowfullscreen:""},null,8,re)]),l("div",ne,[l("span",se,A(m.value),1)])]),_:1}),a(F,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=n=>w.value=n),title:"版本历史",size:"40%"},{default:r(()=>[a(D,null,{default:r(()=>[(g(!0),V(q,null,Q(f.value,n=>(g(),X(z,{key:n.id,timestamp:n.updated_at,placement:"top"},{default:r(()=>[l("div",le,[l("div",ie,"版本: "+A(n.id),1),l("div",de,[a(p,{link:"",type:"warning",onClick:_e=>M(n)},{default:r(()=>[...e[7]||(e[7]=[v(" 回滚 ",-1)])]),_:1},8,["onClick"])])])]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1},8,["modelValue"])])}}},fe=G(ce,[["__scopeId","data-v-66a5641b"]]);export{fe as default};

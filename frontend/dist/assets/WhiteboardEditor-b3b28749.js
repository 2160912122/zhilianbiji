import{_ as Y,k as Z,g as v,J as ee,K as te,l as oe,o as ae,L as re,r as d,b as M,c as U,d as n,w as i,e as u,f as x,A as j,H as se,I as ne,E as _,D as le,m as ie}from"./index-911a223c.js";import{w}from"./editor-cbc213f0.js";import{A as ce}from"./AIModuleButton-5b08fb21.js";const de={class:"whiteboard-editor"},ue={class:"editor-header"},me={class:"header-left"},pe={class:"header-right"},fe={class:"whiteboard-container"},_e=["src"],he={class:"editor-footer"},ve={class:"save-status"},ye={class:"version-item"},we={class:"version-content"},ke={class:"version-actions"},ge={__name:"WhiteboardEditor",props:{isNew:{type:Boolean,default:!1}},setup(D){const S=D,K=Z().params.id,a=v({id:null,title:(()=>`新白板_${new Date().getTime()}`)(),room_key:"",data:{}}),I=v([]),$=v(!1),W=v(null),A=v(""),k=v("未保存");let p=null;const T=ee();te(()=>T.hasNewContent,t=>{if(t){try{const e=T.generatedContent;a.value.title||(a.value.title="AI生成的白板"),G(e),_.success("AI生成的白板内容已准备就绪")}catch(e){console.error("处理AI白板内容失败:",e),_.error("处理AI生成的白板内容失败")}T.resetGeneratedContent()}});const L={红色:"#FF0000",红:"#FF0000",绿色:"#00FF00",绿:"#00FF00",蓝色:"#0000FF",蓝:"#0000FF",黄色:"#FFFF00",黄:"#FFFF00",橙色:"#FFA500",橙:"#FFA500",紫色:"#800080",紫:"#800080",黑色:"#000000",黑:"#000000",白色:"#FFFFFF",白:"#FFFFFF",棕色:"#8B4513",棕:"#8B4513",灰色:"#808080",灰:"#808080"},O={小:2,中:4,大:6},R={上:{x:300,y:200},下:{x:300,y:400},左:{x:200,y:300},右:{x:400,y:300},中心:{x:300,y:300},中间:{x:300,y:300}};function q(t){const e=["画","绘制","画一个","绘制一个","画一条","绘制一条","画一个圆","绘制一个圆","画一个矩形","绘制一个矩形","画一条线","绘制一条线","写","标注","添加文字","写上","画出","画成","画好","画完","画出来"],o={圆:"circle",圆形:"circle",椭圆:"circle",椭圆形:"circle",矩形:"rectangle",正方形:"rectangle",线:"line",直线:"line",竖线:"line",曲线:"line",三角形:"triangle",文字:"text"},m=[],h=t.split(/[。！？；;.!?]/);for(const V of h){const s=V.trim();if(!s)continue;console.log("检查句子:",s);const g=e.some(c=>s.includes(c));if(console.log("包含绘制关键词:",g),g){let c="line";for(const[r,f]of Object.entries(o))if(s.includes(r)){c=f;break}console.log("识别为图形类型:",c);let b="#000000";for(const[r,f]of Object.entries(L))if(s.includes(r)){b=f;break}let F=3;for(const[r,f]of Object.entries(O))if(s.includes(r)){F=f;break}let y={x:300,y:300};for(const[r,f]of Object.entries(R))if(s.includes(r)){y=f;break}let l=50;if(c==="circle"&&s.includes("半径")){const r=s.match(/半径(\d+)/);r&&(l=parseInt(r[1]))}let C=100,z=80;if(c==="rectangle"){if(s.includes("宽")){const r=s.match(/宽(\d+)/);r&&(C=parseInt(r[1]))}if(s.includes("高")){const r=s.match(/高(\d+)/);r&&(z=parseInt(r[1]))}}let N="文字";if(c==="text"){const r=s.match(/写(.+)/);r&&(N=r[1].trim())}m.push({text:s,type:c,params:{color:b,size:F,x:y.x,y:y.y,radius:l,width:C,height:z,text:N}})}}return console.log("提取的步骤:",m),m}async function G(t){console.log("开始处理AI生成的绘制步骤:",t);const e=q(t);console.log("提取的绘制步骤:",e),le.alert(`<div style="max-height: 400px; overflow-y: auto;">
      <h4>AI生成的绘制步骤</h4>
      <pre style="white-space: pre-wrap; word-break: break-all;">${t}</pre>
      <h4>提取的详细步骤</h4>
      <ul>
        ${e.map((o,m)=>`
          <li style="margin: 5px 0;">
            <strong>步骤 ${m+1}:</strong> ${o.text}
            ${o.params?`<br><small style="color: #666;">
              类型: ${o.type}
              ${o.params.color?`, 颜色: ${o.params.color}`:""}
              ${o.params.size?`, 大小: ${o.params.size}`:""}
              ${o.params.x&&o.params.y?`, 位置: (${o.params.x}, ${o.params.y})`:""}
            </small>`:""}
          </li>
        `).join("")}
      </ul>
      <p style="margin-top: 10px; color: #666;">请根据以上步骤手动绘制白板内容。</p>
    </div>`,"AI绘制步骤提示",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",type:"info"}),_.success("AI生成的绘制步骤已准备就绪")}const H=oe(()=>{let e=`http://localhost:8080/boards/${a.value.room_key||"new-whiteboard-"+Date.now()}`;return A.value&&(e+=`?token=${A.value}`),e});async function J(){try{const t=await fetch("/api/whiteboards/wbo-token",{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const e=await t.json();A.value=e.token}}catch(t){console.error("Failed to get WBO token:",t)}}async function P(){if(!S.isNew)try{const t=await w.get(K);console.log("加载白板详情结果:",t),a.value=t.code===200?t.data:{},await B()}catch(t){console.error("Load whiteboard error:",t)}}async function B(){if(a.value.id)try{const t=await w.getVersions(a.value.id);console.log("加载版本历史结果:",t),I.value=t.code===200&&Array.isArray(t.data)?t.data:[]}catch(t){console.error("Load versions error:",t),I.value=[]}}function Q(){k.value="正在保存...",p&&clearTimeout(p),p=setTimeout(()=>{E(!0)},2e3)}async function E(t=!1){p&&clearTimeout(p);try{const e={title:a.value.title||"新白板",room_key:a.value.room_key,data:{room_key:a.value.room_key}};if(a.value.id){const o=await w.update(a.value.id,e);console.log("更新白板结果:",o)}else{const o=await w.create(e);if(console.log("创建白板结果:",o),o.code===201&&o.data)a.value.id=o.data.id,a.value.room_key=o.data.room_key,a.value.title=o.data.title;else throw new Error("创建白板失败: "+(o.message||"未知错误"))}await B(),k.value="已保存",t||_.success("保存成功")}catch(e){console.error("Save whiteboard error:",e),k.value="保存失败",t||_.error("保存失败: "+(e.message||"服务器错误"))}}async function X(t){try{await w.rollbackVersion(a.value.id,t.id),a.value.data=t.data,await B(),_.success("回滚成功")}catch(e){console.error("Rollback version error:",e),_.error("回滚失败")}}return ae(async()=>{await J(),await P(),S.isNew&&!a.value.room_key&&(a.value.room_key="wb-"+Math.random().toString(36).substr(2,9))}),re(()=>{p&&clearTimeout(p)}),(t,e)=>{const o=d("Back"),m=d("el-icon"),h=d("el-button"),V=d("el-input"),s=d("Clock"),g=d("Check"),c=d("el-card"),b=d("el-timeline-item"),F=d("el-timeline"),y=d("el-drawer");return M(),U("div",de,[n(c,null,{header:i(()=>[u("div",ue,[u("div",me,[n(h,{link:"",onClick:e[0]||(e[0]=l=>t.$router.push("/whiteboards"))},{default:i(()=>[n(m,null,{default:i(()=>[n(o)]),_:1}),e[4]||(e[4]=x(" 返回 ",-1))]),_:1}),n(V,{modelValue:a.value.title,"onUpdate:modelValue":e[1]||(e[1]=l=>a.value.title=l),placeholder:"请输入白板标题",style:{width:"300px","margin-left":"20px"},onInput:Q},null,8,["modelValue"])]),u("div",pe,[n(ce),n(h,{link:"",onClick:e[2]||(e[2]=l=>$.value=!0)},{default:i(()=>[n(m,null,{default:i(()=>[n(s)]),_:1}),e[5]||(e[5]=x(" 版本历史 ",-1))]),_:1}),n(h,{type:"primary",onClick:E},{default:i(()=>[n(m,null,{default:i(()=>[n(g)]),_:1}),e[6]||(e[6]=x(" 保存 ",-1))]),_:1})])])]),default:i(()=>[u("div",fe,[u("iframe",{ref_key:"wboIframe",ref:W,class:"wbo-iframe",src:H.value,frameborder:"0",allowfullscreen:""},null,8,_e)]),u("div",he,[u("span",ve,j(k.value),1)])]),_:1}),n(y,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=l=>$.value=l),title:"版本历史",size:"40%"},{default:i(()=>[n(F,null,{default:i(()=>[(M(!0),U(se,null,ne(I.value,l=>(M(),ie(b,{key:l.id,timestamp:l.updated_at,placement:"top"},{default:i(()=>[u("div",ye,[u("div",we,"版本: "+j(l.id),1),u("div",ke,[n(h,{link:"",type:"warning",onClick:C=>X(l)},{default:i(()=>[...e[7]||(e[7]=[x(" 回滚 ",-1)])]),_:1},8,["onClick"])])])]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1},8,["modelValue"])])}}},Ae=Y(ge,[["__scopeId","data-v-d4119c7c"]]);export{Ae as default};

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>{{ mindmap.name }} - æ™ºè”ç¬”è®°</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='jsmind.css') }}">
    <!-- æ·»åŠ ç¼–è¾‘åŠŸèƒ½æ‰€éœ€çš„å›¾æ ‡ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='all.min.css') }}">
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei"}
        body{background:#f5f7fa;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
        .header{margin-bottom:20px;text-align:center;position:relative}
        .permission-badge{
            position:absolute;
            top:10px;
            right:10px;
            padding:4px 8px;
            border-radius:12px;
            font-size:12px;
            font-weight:500;
        }
        .permission-readonly{background:#e6f7ff;color:#1890ff;}
        .permission-editable{background:#f6ffed;color:#52c41a;}
        .mind-container{height:600px;border:1px solid #e4e7ed;border-radius:4px;position:relative}
        .toolbar{
            position:absolute;
            top:10px;
            left:10px;
            background:rgba(255,255,255,0.9);
            padding:8px;
            border-radius:4px;
            box-shadow:0 2px 8px rgba(0,0,0,0.1);
            z-index:100;
            display:flex;
            gap:5px;
        }
        .toolbar button{
            padding:6px;
            border:1px solid #d9d9d9;
            background:#fff;
            border-radius:4px;
            cursor:pointer;
            font-size:14px;
        }
        .toolbar button:hover{
            border-color:#409eff;
            color:#409eff;
        }
        .save-notice{
            position:absolute;
            top:10px;
            right:10px;
            background:#f6ffed;
            border:1px solid #b7eb8f;
            padding:8px 12px;
            border-radius:4px;
            font-size:14px;
            display:none;
        }
        .error-message{
            text-align:center;
            padding:50px;
            color:#f56c6c;
            background:#fef0f0;
            border:1px solid #fbc4c4;
            border-radius:4px;
            margin:20px 0;
        }

        .expired-message {
            text-align: center;
            padding: 50px;
            color: #fa541c;
            background: #fff2e8;
            border: 1px solid #ffbb96;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- åœ¨ header éƒ¨åˆ†æ·»åŠ æ—¶é—´ä¿¡æ¯ -->
        <div class="header">
            <h1>{{ mindmap.name }}</h1>
            <p>åˆ†äº«è‡ª æ™ºè”ç¬”è®°</p>
            <div id="permissionBadge" class="permission-badge"></div>
            <div id="timeInfo" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
        </div>
        <div class="mind-container">
            <div id="toolbar" class="toolbar" style="display:none;">
                <button onclick="addChild()" title="æ·»åŠ å­èŠ‚ç‚¹">+å­èŠ‚ç‚¹</button>
                <button onclick="addBrother()" title="æ·»åŠ å…„å¼ŸèŠ‚ç‚¹">+å…„å¼ŸèŠ‚ç‚¹</button>
                <button onclick="editNode()" title="ç¼–è¾‘èŠ‚ç‚¹">ç¼–è¾‘</button>
                <button onclick="removeNode()" title="åˆ é™¤èŠ‚ç‚¹">åˆ é™¤</button>
                <button onclick="saveMap()" title="ä¿å­˜">ä¿å­˜</button>
                <!-- åœ¨åˆ†äº«é¡µé¢çš„å·¥å…·æ ä¸­æ·»åŠ è¯„è®ºæŒ‰é’® -->
                <button onclick="toggleCommentsView()" title="æŸ¥çœ‹è¯„è®º">ğŸ’¬ è¯„è®º</button>

            </div>
            <div id="saveNotice" class="save-notice">ä¿å­˜æˆåŠŸ</div>
            <div id="jsmind_container" style="width:100%;height:100%"></div>
            <div id="errorContainer" style="display:none;"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='jsmind.js') }}"></script>
    <script>
        let jm = null;
        let isEditable = false;
        const shareType = '{{ share_type }}';
        const mindmapId = {{ mindmap.id }};

        // åŠ è½½åˆ†äº«çš„è„‘å›¾æ•°æ®
        // åŠ è½½åˆ†äº«çš„è„‘å›¾æ•°æ®
        fetch('/api/share/{{ share_type }}/{{ mindmap.id }}')
            .then(res => {
                if (!res.ok) {
                    // é’ˆå¯¹410çŠ¶æ€ç çš„ç‰¹æ®Šå¤„ç†
                    if (res.status === 410) {
                        throw new Error('SHARE_EXPIRED');
                    } else if (res.status === 403) {
                        throw new Error('è¯¥è„‘å›¾ä¸æ”¯æŒç¼–è¾‘æƒé™ï¼Œè¯·ä½¿ç”¨åªè¯»é“¾æ¥è®¿é—®');
                    } else {
                        throw new Error('åŠ è½½å¤±è´¥: ' + res.status);
                    }
                }
                return res.json();
            })
            .then(data => {
                // æ˜¾ç¤ºæƒé™æ ‡è¯†
                const badge = document.getElementById('permissionBadge');
                if (data.share_type === 'editable') {
                    badge.textContent = 'å¯ç¼–è¾‘';
                    badge.className = 'permission-badge permission-editable';
                    isEditable = true;
                    document.getElementById('toolbar').style.display = 'flex';
                } else {
                    badge.textContent = 'åªè¯»';
                    badge.className = 'permission-badge permission-readonly';
                    isEditable = false;
                }

                // æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
                const timeInfo = document.getElementById('timeInfo');
                if (data.is_expired) {
                    timeInfo.innerHTML = '<span style="color: #ff4d4f;">âŒ åˆ†äº«é“¾æ¥å·²è¿‡æœŸ</span>';
                } else if (data.remaining_time) {
                    timeInfo.innerHTML = `<span style="color: #52c41a;">â° å‰©ä½™æ—¶é—´: ${data.remaining_time}</span>`;

                    // å¦‚æœå‰©ä½™æ—¶é—´å¾ˆçŸ­ï¼Œæ·»åŠ è­¦å‘Šæ ·å¼
                    if (data.remaining_time.includes('ç§’') || data.remaining_time.includes('åˆ†é’Ÿ')) {
                        timeInfo.innerHTML = `<span style="color: #fa8c16;">âš ï¸ å‰©ä½™æ—¶é—´: ${data.remaining_time}</span>`;
                    }
                } else {
                    timeInfo.innerHTML = '<span style="color: #1890ff;">âœ… æ°¸ä¹…æœ‰æ•ˆ</span>';
                }

                // åˆå§‹åŒ–è„‘å›¾
                jm = new jsMind({
                    container: 'jsmind_container',
                    theme: 'primary',
                    editable: isEditable,
                    view: {
                        hmargin: 100,
                        vmargin: 50,
                        line_width: 2,
                        line_color: '#409eff'
                    }
                });

                // å¤„ç†æ•°æ®æ ¼å¼
                let mindData = data.data;

                // å¦‚æœæ•°æ®æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                if (typeof mindData === 'string') {
                    try {
                        mindData = JSON.parse(mindData);
                    } catch (e) {
                        console.error('Parse data error:', e);
                    }
                }

                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                if (mindData && mindData.format === 'node_tree') {
                    // å·²ç»æ˜¯å®Œæ•´æ ¼å¼
                    jm.show(mindData);
                } else if (mindData && mindData.id) {
                    // åªæœ‰èŠ‚ç‚¹æ•°æ®ï¼ŒåŒ…è£…æˆå®Œæ•´æ ¼å¼
                    const wrappedData = {
                        "meta": {
                            "name": data.name,
                            "author": data.author,
                            "version": "1.0"
                        },
                        "format": "node_tree",
                        "data": mindData
                    };
                    jm.show(wrappedData);
                } else {
                    throw new Error('æ— æ•ˆçš„è„‘å›¾æ•°æ®æ ¼å¼');
                }

            })
            .catch(err => {
                console.error('åŠ è½½è„‘å›¾å¤±è´¥:', err);
                const errorContainer = document.getElementById('errorContainer');

                // é’ˆå¯¹åˆ†äº«è¿‡æœŸçš„ç‰¹æ®Šå¤„ç†
                if (err.message === 'SHARE_EXPIRED') {
                    errorContainer.innerHTML = `
                        <div class="error-message">
                            <h3>åˆ†äº«é“¾æ¥å·²è¿‡æœŸ</h3>
                            <p>è¯¥åˆ†äº«é“¾æ¥å·²è¶…è¿‡æœ‰æ•ˆæœŸï¼Œæ— æ³•è®¿é—®ã€‚</p>
                            <p style="margin-top: 10px; font-size: 14px;">
                                è¯·è”ç³»åˆ†äº«è€…é‡æ–°ç”Ÿæˆåˆ†äº«é“¾æ¥ã€‚
                            </p>
                            <p style="margin-top: 20px; font-size: 14px; color: #666;">
                                <a href="/" style="color: #409eff;">è¿”å›é¦–é¡µ</a>
                            </p>
                        </div>
                    `;
                } else {
                    // å…¶ä»–é”™è¯¯å¤„ç†
                    errorContainer.innerHTML = `
                        <div class="error-message">
                            <h3>åŠ è½½å¤±è´¥</h3>
                            <p>${err.message}</p>
                            <p style="margin-top: 20px; font-size: 14px; color: #666;">
                                <a href="/" style="color: #409eff;">è¿”å›é¦–é¡µ</a>
                            </p>
                        </div>
                    `;
                }

                errorContainer.style.display = 'block';
                document.getElementById('jsmind_container').style.display = 'none';
                document.getElementById('toolbar').style.display = 'none';
            });


        // ç¼–è¾‘åŠŸèƒ½
        function addChild() {
            if (!isEditable || !jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            const newId = 'node_' + Date.now();
            jm.add_node(node, newId, 'æ–°èŠ‚ç‚¹');
        }

        function addBrother() {
            if (!isEditable || !jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            const newId = 'node_' + Date.now();
            jm.insert_node_after(node, newId, 'å…„å¼ŸèŠ‚ç‚¹');
        }

        function editNode() {
            if (!isEditable || !jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            jm.begin_edit(node);
        }

        function removeNode() {
            if (!isEditable || !jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            jm.remove_node(node);
        }

        async function saveMap() {
            if (!isEditable || !jm) return;

            try {
                const res = await fetch('/api/share/mindmaps/' + mindmapId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({data: jm.get_data()})
                });

                if (!res.ok) {
                    if (res.status === 403) {
                        throw new Error('è¯¥è„‘å›¾ä¸å…è®¸é€šè¿‡åˆ†äº«é“¾æ¥ç¼–è¾‘');
                    } else {
                        throw new Error('ä¿å­˜å¤±è´¥: ' + res.status);
                    }
                }

                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                const notice = document.getElementById('saveNotice');
                notice.style.display = 'block';
                setTimeout(() => {
                    notice.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Save error:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // åˆ†äº«é¡µé¢çš„è¯„è®ºåŠŸèƒ½
        function toggleCommentsView() {
            // åœ¨åˆ†äº«é¡µé¢ä¸­åªæ˜¾ç¤ºè¯„è®ºï¼Œä¸èƒ½ç¼–è¾‘
            alert('è¯„è®ºåŠŸèƒ½åœ¨åˆ†äº«é¡µé¢ä¸­ä¸ºåªè¯»æ¨¡å¼');
            // è¿™é‡Œå¯ä»¥å®ç°åœ¨åˆ†äº«é¡µé¢ä¸­æŸ¥çœ‹è¯„è®ºçš„åŠŸèƒ½
        }
    </script>
</body>
</html>
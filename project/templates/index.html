<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºè”ç¬”è®° - è„‘å›¾</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='jsmind.css') }}">
    <!-- FontAwesome 6 å›¾æ ‡ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='all.min.css') }}">
    <style>
       *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei"}

        /* æ·»åŠ ç¼©æ”¾å®¹å™¨ */
        #zoom-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transform-origin: 0 0;
            transition: transform 0.3s ease;
        }

        body{
            display:flex;
            flex-direction:column;
            height:100vh;
            background:#f5f7fa;
            min-width: 1024px; /* è®¾ç½®æœ€å°å®½åº¦é˜²æ­¢è¿‡åº¦å‹ç¼© */
            overflow: hidden;
        }
        header{
            height:56px;
            background:#409eff;
            color:#fff;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 24px;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }
        header .btn{
            padding:6px 14px;
            border:none;
            border-radius:4px;
            background:#fff;
            color:#409eff;
            cursor:pointer;
            font-size:14px;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }
        .toolbar{
            height:48px;
            background:#fff;
            border-bottom:1px solid #e4e7ed;
            display:flex;
            align-items:center;
            padding:0 16px;
            gap:10px;
            flex-shrink: 0; /* é˜²æ­¢å·¥å…·æ è¢«å‹ç¼© */
        }
        .toolbar .btn{
            padding:7px 12px;
            border:1px solid #409eff;
            background:#fff;
            color:#409eff;
            border-radius:4px;
            cursor:pointer;
            font-size:14px;
            flex-shrink: 0;
        }
        .btn.primary {
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(64, 158, 255, 0.2);
            flex-shrink: 0;
        }

        .btn.primary:hover {
            background: #66b1ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(64, 158, 255, 0.3);
        }

        .btn.primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(64, 158, 255, 0.2);
        }

        main{
            flex:1;
            display:flex;
            overflow:hidden;
            min-height: 0; /* å…è®¸flexå­å…ƒç´ ç¼©å° */
        }
        aside{
            width:260px;
            background:#fff;
            border-right:1px solid #e4e7ed;
            display:flex;
            flex-direction:column;
            flex-shrink: 0; /* é˜²æ­¢ä¾§è¾¹æ è¢«å‹ç¼© */
        }
        aside h3{
            padding:16px;
            font-weight:500;
            border-bottom:1px solid #e4e7ed;
        }
        #fileList{
            flex:1;
            overflow-y:auto;
            padding:8px;
            list-style:none;
        }

        /* æ–‡ä»¶åˆ—è¡¨é¡¹æ ·å¼è°ƒæ•´ */
        #fileList li {
            padding: 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border: 1px solid #f0f0f0;
            transition: all 0.2s;
        }

        #fileList li:hover {
            background: #f0f9ff;
            border-color: #c6e2ff;
        }

        #fileList li.active {
            background: #e6f7ff;
            color: #409eff;
            border-color: #91d5ff;
        }

        .mindbox{
            flex:1;
            position:relative;
            background:#fff;
            min-width: 0; /* å…è®¸flexå­å…ƒç´ ç¼©å° */
        }
        #jsmind_container{
            width:100%;
            height:100%;
        }
        .modal{
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.45);
            z-index:999;
        }
        .modal>div{
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            background:#fff;
            padding:28px;
            border-radius:8px;
            width:360px;
            box-shadow:0 4px 20px rgba(0,0,0,.15);
            max-width: 90vw; /* é™åˆ¶æ¨¡æ€æ¡†æœ€å¤§å®½åº¦ */
        }
        .modal h4{
            margin-bottom:16px;
            font-size:18px;
        }
        .modal input{
            width:100%;
            padding:10px 12px;
            margin-bottom:14px;
            border:1px solid #dcdfe6;
            border-radius:4px;
        }
        .modal footer{
            display:flex;
            justify-content:flex-end;
            gap:10px;
        }
        .modal footer button{
            padding:6px 14px;
            border:none;
            border-radius:4px;
            cursor:pointer;
        }
        .modal footer .ok{
            background:#409eff;
            color:#fff;
        }
        .editbar{
          height: 40px;
          background: #ffffff;
          border-bottom: 1px solid #e4e7ed;
          display: flex;
          align-items: center;
          padding: 0 12px;
          gap: 6px;
          flex-shrink: 0;
        }
        .icon-btn{
          position: relative;
          width: 32px;
          height: 32px;
          border: none;
          background: transparent;
          color: #606266;
          font-size: 18px;
          cursor: pointer;
          border-radius: 4px;
          transition: background .2s, color .2s;
          flex-shrink: 0;
        }
        .icon-btn:hover{
          background: #f0f9ff;
          color: #409eff;
        }
        .divider{
          width: 1px;
          height: 18px;
          background: #dcdfe6;
          margin: 0 4px;
          flex-shrink: 0;
        }
        /* ---------- æç®€ tooltip ---------- */
        .icon-btn::after{
          content: attr(data-tooltip);
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          margin-top: 6px;
          padding: 4px 8px;
          font-size: 12px;
          color: #fff;
          background: #303133;
          border-radius: 4px;
          white-space: nowrap;
          opacity: 0;
          pointer-events: none;
          transition: opacity .2s;
          z-index: 10000; /* æ·»åŠ è¿™ä¸€è¡Œï¼Œæé«˜å±‚çº§ */
        }
        .icon-btn:hover::after{
          opacity: 1;
          transition-delay: .2s;
        }
        /* æ–‡ä»¶æ“ä½œæŒ‰é’® */
        .file-actions {
            padding: 12px 16px;
            border-bottom: 1px solid #e4e7ed;
        }
        .file-actions .btn {
            width: 100%;
            margin-bottom: 8px;
        }
        /* åˆ†äº«æ¨¡æ€æ¡† */
        .share-link {
            background: #f5f7fa;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 14px;
        }

        /* åˆ†äº«çŠ¶æ€æ ·å¼ */
        .share-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        .share-status.loading {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        .share-status.success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .share-status.error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        /* æ·»åŠ æ ‡ç­¾ç›¸å…³æ ·å¼ */
        .tag-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 4px;
            color: white;
            font-weight: 500;
        }

        /* æ ‡ç­¾ç®¡ç†æ¨¡æ€æ¡†ä¸­çš„å¤é€‰æ¡†æ ·å¼ */
        #tagsList input[type="checkbox"] {
            margin-right: 8px;
        }

        /* åˆ†ç±»å’Œæ ‡ç­¾ç­›é€‰å™¨æ ·å¼ */
        .file-actions select {
            margin-bottom: 8px;
            background-color: #fff;
            cursor: pointer;
        }

        .file-actions select:focus {
            border-color: #409eff;
            outline: none;
        }

        .file-actions label {
            font-weight: 500;
        }

        /* AIåŠ©æ‰‹æŒ‰é’®æ ·å¼ */
        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .ai-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .ai-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .ai-btn .btn-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ai-btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .ai-btn.loading .spinner {
            display: block;
        }

        .ai-btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AIåŠ©æ‰‹æŒ‰é’®çš„å‘å…‰æ•ˆæœ */
        .ai-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .ai-btn:hover::before {
            left: 100%;
        }

        /* AIåˆ†æç»“æœæ ·å¼å¢å¼º */
        .ai-result-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ai-suggestion-item {
            background: white;
            padding: 10px 12px;
            margin: 6px 0;
            border-radius: 6px;
            border-left: 3px solid #52c41a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .ai-suggestion-item:hover {
            transform: translateX(5px);
        }

        /* AIå¢å¼ºåŠŸèƒ½æ ·å¼ */
        .ai-feature-btn {
            background: white;
            border: 2px solid #e4e7ed;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #606266;
        }

        .ai-feature-btn:hover {
            border-color: #409eff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(64, 158, 255, 0.15);
        }

        .ai-feature-btn.active {
            border-color: #409eff;
            background: #f0f9ff;
            color: #409eff;
        }

        .ai-feature-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .ai-feature-panel {
            background: #fafafa;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #409eff;
        }

        .ai-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .ai-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-result-section {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e4e7ed;
        }

        .ai-analysis-content {
            line-height: 1.6;
            color: #606266;
        }

        .ai-suggestions-list {
            margin: 0;
            padding-left: 20px;
        }

        .ai-suggestions-list li {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #f6ffed;
            border-left: 3px solid #52c41a;
            border-radius: 4px;
        }

        .ai-changes-list {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #1890ff;
        }

        .ai-apply-btn {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .ai-apply-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
        }

        /* AIåŠŸèƒ½æ ‡ç­¾ */
        .ai-feature-tag {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: 500;
        }

        /* è¯„è®ºåŠŸèƒ½æ ·å¼ */
        .comment-btn {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
        }

        .comment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 196, 26, 0.4);
        }

        .comment-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff4d4f;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .comment-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            max-height: 80vh;
        }

        .comment-panel-header {
            padding: 16px;
            border-bottom: 1px solid #e4e7ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .comment-panel-footer {
            padding: 16px;
            border-top: 1px solid #e4e7ed;
        }

        .comment-item {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid #409eff;
        }

        .comment-item.reply {
            margin-left: 20px;
            background: #f0f9ff;
            border-left-color: #91d5ff;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 500;
            color: #409eff;
        }

        .comment-time {
            font-size: 12px;
            color: #909399;
        }

        .comment-content {
            color: #606266;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }

        .comment-action {
            color: #909399;
            cursor: pointer;
            transition: color 0.2s;
        }

        .comment-action:hover {
            color: #409eff;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .comment-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .comment-form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-count-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4f;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 16px;
            text-align: center;
        }

        /* ç¼©æ”¾æ§åˆ¶æŒ‰é’® */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #409eff;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #66b1ff;
            transform: scale(1.1);
        }

        .zoom-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }




    </style>
</head>
<body>
    <header>
        <span style="font-size:18px;font-weight:500">ğŸ§  æ™ºè”ç¬”è®°</span>
        <div>
            <span id="user" style="margin-right:12px"></span>
            <!-- æ·»åŠ ç®¡ç†å‘˜å…¥å£ -->
            <button class="btn" id="adminBtn" onclick="goToAdmin()" style="display:none; margin-right:8px;">
                ç®¡ç†åå°
            </button>
            <button class="btn" onclick="logout()">é€€å‡º</button>
        </div>
    </header>

    <div class="toolbar">
        <!-- ä¸»å·¥å…·æ  -->
        <button class="btn" onclick="newMap()">æ–°å»º</button>
        <button class="btn" onclick="saveMap()">ä¿å­˜</button>
        <button class="btn" onclick="exportMap()">å¯¼å‡º</button>
        <button class="btn" onclick="shareMap()">åˆ†äº«</button>
        <button class="btn" onclick="manageAllTags()">æ ‡ç­¾ç®¡ç†</button>
        <button class="btn" onclick="showVersionHistory()">ç‰ˆæœ¬å†å²</button>
        <!-- ä¿®æ”¹ä¸»å·¥å…·æ ä¸­çš„AIåŠ©æ‰‹éƒ¨åˆ† -->
        <div style="display: flex; gap: 8px; align-items: center;">
            <button class="ai-btn" onclick="openAIAssistant()">
                <div class="btn-content">
                    <i class="fas fa-robot"></i>
                    <span class="btn-text">AIåŠ©æ‰‹</span>
                </div>
            </button>

            <button class="ai-btn" onclick="openEnhancedAIAssistant()"
                    style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                <div class="btn-content">
                    <i class="fas fa-star"></i>
                    <span class="btn-text">AIé«˜çº§åŠŸèƒ½</span>
                    <span class="ai-feature-tag">NEW</span>
                </div>
            </button>
        </div>

        <!-- åœ¨AIåŠ©æ‰‹æŒ‰é’®åé¢æ·»åŠ è¯„è®ºæŒ‰é’® -->
        <button class="comment-btn" onclick="toggleCommentPanel()">
            <i class="fas fa-comments"></i>
            <span class="btn-text">è¯„è®º</span>
            <span id="commentCountBadge" class="comment-count-badge" style="display: none;">0</span>
        </button>


        <!-- å›¾æ ‡å¼ç¼–è¾‘æ  -->
        <div class="editbar">
          <button class="icon-btn" data-tooltip="æ·»åŠ å­èŠ‚ç‚¹" onclick="addChild()">
            <i class="fas fa-plus-circle"></i>
          </button>
          <button class="icon-btn" data-tooltip="æ·»åŠ å…„å¼ŸèŠ‚ç‚¹" onclick="addBro()">
            <i class="fas fa-plus"></i>
          </button>
          <button class="icon-btn" data-tooltip="ç¼–è¾‘æ–‡å­—" onclick="editNode()">
            <i class="fas fa-edit"></i>
          </button>
          <button class="icon-btn" data-tooltip="åˆ é™¤èŠ‚ç‚¹" onclick="delNode()">
            <i class="fas fa-trash"></i>
          </button>

          <div class="divider"></div>

          <button class="icon-btn" data-tooltip="ä¸Šç§»" onclick="moveUp()">
            <i class="fas fa-chevron-up"></i>
          </button>
          <button class="icon-btn" data-tooltip="ä¸‹ç§»" onclick="moveDown()">
            <i class="fas fa-chevron-down"></i>
          </button>
          <button class="icon-btn" data-tooltip="å±•å¼€/æ”¶èµ·" onclick="toggleNode()">
            <i class="fas fa-folder-open"></i>
          </button>

          <div class="divider"></div>

          <button class="icon-btn" data-tooltip="æ”¾å¤§" onclick="zoomIn()">
            <i class="fas fa-search-plus"></i>
          </button>
          <button class="icon-btn" data-tooltip="ç¼©å°" onclick="zoomOut()">
            <i class="fas fa-search-minus"></i>
          </button>
          <button class="icon-btn" data-tooltip="é‡ç½®ç¼©æ”¾" onclick="resetZoom()">
            <i class="fas fa-expand-arrows-alt"></i>
          </button>

          <div class="divider"></div>

          <button class="icon-btn" data-tooltip="æ’¤é”€" onclick="undo()">
            <i class="fas fa-undo"></i>
          </button>
          <button class="icon-btn" data-tooltip="é‡åš" onclick="redo()">
            <i class="fas fa-redo"></i>
          </button>
        </div>
    </div>

    <main>
        <aside>
            <h3>æˆ‘çš„è„‘å›¾</h3>
            <div class="file-actions">
                <button class="btn primary" onclick="newMap()">æ–°å»ºè„‘å›¾</button>

                <!-- åœ¨ <input type="text" id="searchInp" placeholder="æœç´¢è„‘å›¾..." ...> ä¹‹å‰æ·»åŠ  -->
                <!-- åˆ†ç±»ç­›é€‰ -->
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #606266; margin-bottom: 4px; display: block;">åˆ†ç±»</label>
                    <select id="categoryFilter" onchange="filterByCategory()" style="width: 100%; padding: 6px; border: 1px solid #dcdfe6; border-radius: 4px; font-size: 12px;">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="recent">æœ€è¿‘ä½¿ç”¨</option>
                        <option value="favorite">æ”¶è—</option>
                        <option value="work">å·¥ä½œ</option>
                        <option value="study">å­¦ä¹ </option>
                        <option value="personal">ä¸ªäºº</option>
                    </select>
                </div>

                <!-- æ ‡ç­¾ç­›é€‰ -->
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #606266; margin-bottom: 4px; display: block;">æ ‡ç­¾</label>
                    <select id="tagFilter" onchange="filterByTag()" style="width: 100%; padding: 6px; border: 1px solid #dcdfe6; border-radius: 4px; font-size: 12px;">
                        <option value="all">å…¨éƒ¨</option>
                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ ‡ç­¾é€‰é¡¹ -->
                    </select>
                </div>

                <input type="text" id="searchInp" placeholder="æœç´¢è„‘å›¾..." oninput="searchMap()" style="width:100%;padding:6px;border:1px solid #dcdfe6;border-radius:4px;margin-top:8px">
            </div>
            <ul id="fileList"></ul>
        </aside>
        <div class="mindbox">
            <div id="jsmind_container"></div>
        </div>
    </main>

    <!-- æ–°å»ºè„‘å›¾æ¨¡æ€æ¡† -->
    <div class="modal" id="newModal">
        <div>
            <h4>æ–°å»ºè„‘å›¾</h4>
            <input id="mName" placeholder="è„‘å›¾åç§°">
            <input id="mTopic" placeholder="ä¸­å¿ƒä¸»é¢˜">
            <footer>
                <button onclick="closeModal('newModal')">å–æ¶ˆ</button>
                <button class="ok" onclick="createMap()">åˆ›å»º</button>
            </footer>
        </div>
    </div>

    <!-- åˆ†äº«æ¨¡æ€æ¡† -->
    <div class="modal" id="shareModal">
        <div style="width: 500px;">
            <h4>åˆ†äº«è„‘å›¾</h4>
            <div id="shareContent">
                <div style="margin-bottom: 16px;">
                    <label>åˆ†äº«æƒé™ï¼š</label>
                    <select id="sharePermission" onchange="updateShareSettings()" style="padding: 6px; border: 1px solid #dcdfe6; border-radius: 4px; margin-left: 10px;">
                        <option value="readonly">åªè¯»</option>
                        <option value="editable">å¯ç¼–è¾‘</option>
                    </select>
                </div>

                <div style="margin-bottom: 16px;">
                    <label>æœ‰æ•ˆæœŸï¼š</label>
                    <select id="shareExpires" onchange="updateShareSettings()" style="padding: 6px; border: 1px solid #dcdfe6; border-radius: 4px; margin-left: 10px;">
                        <option value="">æ°¸ä¹…æœ‰æ•ˆ</option>
                        <option value="0.0167">1åˆ†é’Ÿ</option>
                        <option value="0.0833">5åˆ†é’Ÿ</option>
                        <option value="0.1667">10åˆ†é’Ÿ</option>
                        <option value="0.5">30åˆ†é’Ÿ</option>
                        <option value="1">1å°æ—¶</option>
                        <option value="6">6å°æ—¶</option>
                        <option value="24">24å°æ—¶</option>
                        <option value="168">7å¤©</option>
                        <option value="720">30å¤©</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                    <div id="customExpires" style="display: none; margin-top: 8px;">
                        <input type="number" id="customHours" placeholder="è¾“å…¥å°æ—¶æ•°" min="0.0167" step="0.0167" style="padding: 6px; border: 1px solid #dcdfe6; border-radius: 4px; width: 120px;">
                        <span style="margin-left: 8px;">å°æ—¶ (æœ€å°0.0167å°æ—¶â‰ˆ1åˆ†é’Ÿ)</span>
                    </div>
                </div>

                <div style="background: #f0f9ff; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #606266; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-right: 8px; color: #409eff;"></i>
                        <span id="shareInfoText">è®¾ç½®åˆ†äº«æƒé™å’Œæœ‰æ•ˆæœŸåç”Ÿæˆé“¾æ¥</span>
                    </p>
                </div>

                <div style="margin-bottom: 16px;">
                    <p><strong>åªè¯»é“¾æ¥ï¼š</strong></p>
                    <div class="share-link" id="readonlyLink"></div>
                    <button class="btn" onclick="copyLink('readonlyLink')" style="width: 100%; margin-top: 8px;">
                        <i class="fas fa-copy"></i> å¤åˆ¶åªè¯»é“¾æ¥
                    </button>
                </div>

                <div style="margin-bottom: 16px;">
                    <p><strong>å¯ç¼–è¾‘é“¾æ¥ï¼š</strong></p>
                    <div class="share-link" id="editableLink"></div>
                    <button class="btn" onclick="copyLink('editableLink')" style="width: 100%; margin-top: 8px;">
                        <i class="fas fa-copy"></i> å¤åˆ¶å¯ç¼–è¾‘é“¾æ¥
                    </button>
                </div>

                <div id="shareStatus" style="display: none; background: #f0f9ff; padding: 12px; border-radius: 4px; margin-top: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #606266;">
                        <i class="fas fa-clock" style="margin-right: 8px;"></i>
                        <span id="statusText"></span>
                    </p>
                </div>

                <div style="background: #fff2e8; padding: 12px; border-radius: 4px; margin-top: 16px;">
                    <p style="margin: 0; font-size: 14px; color: #fa541c;">
                        <strong>æ³¨æ„ï¼š</strong>å¯ç¼–è¾‘é“¾æ¥å…è®¸ä»–äººä¿®æ”¹æ‚¨çš„è„‘å›¾å†…å®¹ï¼Œè¯·è°¨æ…åˆ†äº«ï¼åˆ†äº«é“¾æ¥å°†åœ¨åˆ°æœŸåè‡ªåŠ¨å¤±æ•ˆã€‚
                    </p>
                </div>
            </div>
            <footer>
                <button onclick="closeModal('shareModal')">å…³é—­</button>
            </footer>
        </div>
    </div>

    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div class="modal" id="exportModal">
        <div style="width: 400px;">
            <h4>å¯¼å‡ºè„‘å›¾</h4>
            <div style="margin-bottom:16px">
                <p>é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š</p>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button class="btn primary" onclick="exportAsJson()">
                    <i class="fas fa-file-code"></i> JSON
                </button>
                <button class="btn primary" onclick="exportAsText()">
                    <i class="fas fa-file-alt"></i> æ–‡æœ¬
                </button>
                <button class="btn primary" onclick="exportAsPDF()">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn primary" onclick="exportAsImage()">
                    <i class="fas fa-file-image"></i> å›¾ç‰‡
                </button>
            </div>
            <footer style="margin-top:16px;display:flex;justify-content:flex-end;">
                <button class="btn" onclick="closeModal('exportModal')">å–æ¶ˆ</button>
            </footer>
        </div>
    </div>


    <!-- åœ¨ç°æœ‰çš„æ¨¡æ€æ¡†ä¹‹åæ·»åŠ æ ‡ç­¾ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="tagsModal">
        <div style="width: 500px;">
            <h4>æ ‡ç­¾ç®¡ç†</h4>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input id="newTagName" placeholder="æ–°æ ‡ç­¾åç§°" style="flex: 1; padding: 6px 12px; border: 1px solid #dcdfe6; border-radius: 4px;">
                    <input type="color" id="newTagColor" value="#409EFF" style="width: 40px; height: 32px; border: 1px solid #dcdfe6; border-radius: 4px;">
                    <button class="btn primary" onclick="createTag()">åˆ›å»ºæ ‡ç­¾</button>
                </div>
            </div>

            <div id="tagsList" style="max-height: 300px; overflow-y: auto;">
                <!-- æ ‡ç­¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <footer style="margin-top: 16px;">
                <button onclick="closeModal('tagsModal')">å…³é—­</button>
            </footer>
        </div>
    </div>

    <!-- AIåŠ©æ‰‹æ¨¡æ€æ¡† -->
    <div class="modal" id="aiModal">
        <div style="width: 600px; max-height: 80vh; overflow-y: auto;">
            <h4>ğŸ§  AIè„‘å›¾åŠ©æ‰‹</h4>
            <div style="margin-bottom: 16px;">
                <textarea id="aiInstruction" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦AIå¸®åŠ©çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šå®Œå–„è¿™ä¸ªè„‘å›¾ã€ä¼˜åŒ–ç»“æ„ã€æ·»åŠ ç»†èŠ‚ç­‰..."
                         style="width:100%;height:80px;padding:8px;border:1px solid #dcdfe6;border-radius:4px;resize:vertical"></textarea>
            </div>

            <!-- åœ¨AIåŠ©æ‰‹æ¨¡æ€æ¡†ä¸­æ›¿æ¢åŸæ¥çš„æŒ‰é’® -->
            <button class="ai-btn" id="analyzeBtn" onclick="analyzeWithAI()" style="width:100%;margin-bottom:16px;padding:12px;">
                <div class="btn-content">
                    <i class="fas fa-brain"></i>
                    <span class="btn-text">æ™ºèƒ½åˆ†æ</span>
                    <div class="spinner"></div>
                </div>
            </button>

            <div id="aiResult" style="display:none;">
                <div style="background:#f0f9ff;padding:12px;border-radius:4px;margin-bottom:12px;">
                    <h5 style="margin:0 0 8px 0;color:#409eff;">åˆ†æç»“æœ</h5>
                    <div id="aiAnalysis"></div>
                </div>

                <div style="background:#f6ffed;padding:12px;border-radius:4px;">
                    <h5 style="margin:0 0 8px 0;color:#52c41a;">ä¼˜åŒ–å»ºè®®</h5>
                    <ul id="aiSuggestions" style="margin:0;padding-left:20px;"></ul>
                </div>
            </div>

            <footer style="margin-top:16px;">
                <button onclick="closeModal('aiModal')">å…³é—­</button>
            </footer>
        </div>
    </div>

    <!-- å¢å¼ºçš„AIåŠ©æ‰‹æ¨¡æ€æ¡† -->
    <div class="modal" id="enhancedAIModal">
        <div style="width: 700px; max-height: 85vh; overflow-y: auto;">
            <h4>ğŸ§  AIæ™ºèƒ½åŠ©æ‰‹ - é«˜çº§åŠŸèƒ½</h4>

            <!-- åŠŸèƒ½é€‰æ‹© -->
            <div style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                    <button class="ai-feature-btn" data-feature="expand" onclick="selectAIFeature('expand')">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>æ™ºèƒ½æ‰©å±•</span>
                    </button>
                    <button class="ai-feature-btn" data-feature="optimize" onclick="selectAIFeature('optimize')">
                        <i class="fas fa-sitemap"></i>
                        <span>ç»“æ„ä¼˜åŒ–</span>
                    </button>
                    <button class="ai-feature-btn" data-feature="summarize" onclick="selectAIFeature('summarize')">
                        <i class="fas fa-file-alt"></i>
                        <span>å†…å®¹æ‘˜è¦</span>
                    </button>
                    <button class="ai-feature-btn" data-feature="suggest_topics" onclick="selectAIFeature('suggest_topics')">
                        <i class="fas fa-lightbulb"></i>
                        <span>ä¸»é¢˜æ¨è</span>
                    </button>
                    <button class="ai-feature-btn" data-feature="check_balance" onclick="selectAIFeature('check_balance')">
                        <i class="fas fa-balance-scale"></i>
                        <span>å¹³è¡¡æ£€æŸ¥</span>
                    </button>
                    <button class="ai-feature-btn" data-feature="analyze" onclick="selectAIFeature('analyze')">
                        <i class="fas fa-chart-bar"></i>
                        <span>æ·±åº¦åˆ†æ</span>
                    </button>
                </div>
            </div>

            <!-- åŠŸèƒ½è¯¦æƒ…åŒºåŸŸ -->
            <div id="aiFeatureContent">
                <!-- æ™ºèƒ½æ‰©å±• -->
                <div id="expandFeature" class="ai-feature-panel" style="display: none;">
                    <h5>ğŸ§© æ™ºèƒ½æ‰©å±•</h5>
                    <p style="color: #666; margin-bottom: 12px;">åŸºäºå½“å‰è„‘å›¾å†…å®¹è‡ªåŠ¨æ‰©å±•ç›¸å…³ä¸»é¢˜å’Œå­èŠ‚ç‚¹</p>
                    <textarea id="expandInstruction" placeholder="å‘Šè¯‰AIæ‚¨æƒ³è¦æ‰©å±•çš„æ–¹å‘ï¼ˆå¯é€‰ï¼‰..."
                             style="width:100%;height:60px;padding:8px;border:1px solid #dcdfe6;border-radius:4px;resize:vertical;margin-bottom:12px"></textarea>
                    <button class="ai-action-btn" onclick="enhanceMindmap('expand')">
                        <i class="fas fa-magic"></i> å¼€å§‹æ™ºèƒ½æ‰©å±•
                    </button>
                </div>

                <!-- ç»“æ„ä¼˜åŒ– -->
                <div id="optimizeFeature" class="ai-feature-panel" style="display: none;">
                    <h5>âš¡ ç»“æ„ä¼˜åŒ–</h5>
                    <p style="color: #666; margin-bottom: 12px;">AIå°†åˆ†æå¹¶ä¼˜åŒ–è„‘å›¾ç»“æ„ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°å’Œå¹³è¡¡</p>
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                        <p style="margin: 0; font-size: 14px; color: #409eff;">
                            <i class="fas fa-info-circle"></i>
                            å°†è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤ï¼šèŠ‚ç‚¹åˆ†å¸ƒä¸å‡ã€å±‚æ¬¡è¿‡æ·±ã€ç»“æ„æ··ä¹±ç­‰é—®é¢˜
                        </p>
                    </div>
                    <button class="ai-action-btn" onclick="enhanceMindmap('optimize')">
                        <i class="fas fa-cogs"></i> å¼€å§‹ç»“æ„ä¼˜åŒ–
                    </button>
                </div>

                <!-- å†…å®¹æ‘˜è¦ -->
                <div id="summarizeFeature" class="ai-feature-panel" style="display: none;">
                    <h5>ğŸ“‹ å†…å®¹æ‘˜è¦</h5>
                    <p style="color: #666; margin-bottom: 12px;">ç”Ÿæˆè„‘å›¾çš„æ™ºèƒ½æ‘˜è¦ï¼Œæå–æ ¸å¿ƒå†…å®¹å’Œå…³é”®è¦ç‚¹</p>
                    <button class="ai-action-btn" onclick="enhanceMindmap('summarize')">
                        <i class="fas fa-file-contract"></i> ç”Ÿæˆå†…å®¹æ‘˜è¦
                    </button>
                </div>

                <!-- ä¸»é¢˜æ¨è -->
                <div id="suggest_topicsFeature" class="ai-feature-panel" style="display: none;">
                    <h5>ğŸ’¡ ä¸»é¢˜æ¨è</h5>
                    <p style="color: #666; margin-bottom: 12px;">åŸºäºå½“å‰å†…å®¹æ¨èç›¸å…³ä¸»é¢˜å’Œæ‰©å±•æ–¹å‘</p>
                    <button class="ai-action-btn" onclick="enhanceMindmap('suggest_topics')">
                        <i class="fas fa-bullseye"></i> è·å–ä¸»é¢˜æ¨è
                    </button>
                </div>

                <!-- å¹³è¡¡æ£€æŸ¥ -->
                <div id="check_balanceFeature" class="ai-feature-panel" style="display: none;">
                    <h5>âš–ï¸ å¹³è¡¡æ£€æŸ¥</h5>
                    <p style="color: #666; margin-bottom: 12px;">æ£€æŸ¥è„‘å›¾çš„ç»“æ„å¹³è¡¡æ€§ï¼Œå‘ç°æ½œåœ¨é—®é¢˜</p>
                    <button class="ai-action-btn" onclick="enhanceMindmap('check_balance')">
                        <i class="fas fa-search"></i> å¼€å§‹å¹³è¡¡æ£€æŸ¥
                    </button>
                </div>

                <!-- æ·±åº¦åˆ†æ -->
                <div id="analyzeFeature" class="ai-feature-panel" style="display: none;">
                    <h5>ğŸ” æ·±åº¦åˆ†æ</h5>
                    <p style="color: #666; margin-bottom: 12px;">å…¨é¢åˆ†æè„‘å›¾ç»“æ„ã€å†…å®¹å’Œé€»è¾‘å…³ç³»</p>
                    <textarea id="analyzeInstruction" placeholder="è¾“å…¥æ‚¨æƒ³è¦åˆ†æçš„å…·ä½“æ–¹é¢ï¼ˆå¯é€‰ï¼‰..."
                             style="width:100%;height:60px;padding:8px;border:1px solid #dcdfe6;border-radius:4px;resize:vertical;margin-bottom:12px"></textarea>
                    <button class="ai-action-btn" onclick="analyzeWithAI()">
                        <i class="fas fa-brain"></i> å¼€å§‹æ·±åº¦åˆ†æ
                    </button>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div id="enhancedAIResult" style="display: none; margin-top: 20px;">
                <div class="ai-result-section">
                    <h5>ğŸ“Š åˆ†æç»“æœ</h5>
                    <div id="enhancedAIAnalysis" class="ai-analysis-content"></div>
                </div>

                <div class="ai-result-section">
                    <h5>ğŸ’¡ ä¼˜åŒ–å»ºè®®</h5>
                    <ul id="enhancedAISuggestions" class="ai-suggestions-list"></ul>
                </div>

                <div class="ai-result-section" id="changesSection" style="display: none;">
                    <h5>ğŸ› ï¸ æ‰§è¡Œå˜æ›´</h5>
                    <div id="aiChangesMade" class="ai-changes-list"></div>
                    <button class="ai-apply-btn" onclick="applyAIChanges()" style="margin-top: 12px;">
                        <i class="fas fa-check"></i> åº”ç”¨å˜æ›´åˆ°è„‘å›¾
                    </button>
                </div>
            </div>

            <footer style="margin-top: 20px; display: flex; justify-content: space-between;">
                <button onclick="closeEnhancedAIModal()">å…³é—­</button>
                <button onclick="resetAIFeatures()" class="btn">
                    <i class="fas fa-redo"></i> é‡ç½®
                </button>
            </footer>
        </div>
    </div>

    <!-- åœ¨ç°æœ‰çš„æ¨¡æ€æ¡†ä¹‹åæ·»åŠ ç‰ˆæœ¬å†å²æ¨¡æ€æ¡† -->
    <div class="modal" id="versionHistoryModal">
        <div style="width: 800px; max-height: 80vh; overflow-y: auto;">
            <h4>ğŸ“š ç‰ˆæœ¬å†å² - <span id="versionMindmapName"></span></h4>

            <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center;">
                <button class="btn primary" onclick="createManualVersion()">
                    <i class="fas fa-camera"></i> åˆ›å»ºæ‰‹åŠ¨ç‰ˆæœ¬
                </button>
                <input type="text" id="versionDescription" placeholder="è¾“å…¥ç‰ˆæœ¬æè¿°ï¼ˆå¯é€‰ï¼‰"
                       style="flex: 1; padding: 6px 12px; border: 1px solid #dcdfe6; border-radius: 4px;">
            </div>

            <div id="versionsList" style="border: 1px solid #e4e7ed; border-radius: 4px;">
                <!-- ç‰ˆæœ¬åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <footer style="margin-top: 16px;">
                <button onclick="closeModal('versionHistoryModal')">å…³é—­</button>
            </footer>
        </div>
    </div>

    <!-- ç‰ˆæœ¬è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="versionDetailModal">
        <div style="width: 900px; max-height: 85vh; overflow-y: auto;">
            <h4>ğŸ” ç‰ˆæœ¬è¯¦æƒ… - v<span id="detailVersionNumber"></span></h4>

            <div style="background: #f5f7fa; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <strong>åˆ›å»ºæ—¶é—´:</strong> <span id="detailCreatedAt"></span>
                    </div>
                    <div>
                        <strong>åˆ›å»ºè€…:</strong> <span id="detailCreatedBy"></span>
                    </div>
                    <div>
                        <strong>ç‰ˆæœ¬å·:</strong> v<span id="detailVersionNum"></span>
                    </div>
                    <div>
                        <strong>å˜æ›´æè¿°:</strong> <span id="detailChangeDesc"></span>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <h5>ğŸ“Š ç‰ˆæœ¬é¢„è§ˆ</h5>
                    <div id="versionPreview" style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e4e7ed;">
                        <!-- ç‰ˆæœ¬é¢„è§ˆå†…å®¹ -->
                    </div>
                </div>
                <div>
                    <h5>ğŸ“‹ æ“ä½œ</h5>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn primary" onclick="restoreCurrentVersion()">
                            <i class="fas fa-history"></i> æ¢å¤æ­¤ç‰ˆæœ¬
                        </button>
                        <button class="btn" onclick="compareWithCurrent()">
                            <i class="fas fa-code-compare"></i> ä¸å½“å‰ç‰ˆæœ¬æ¯”è¾ƒ
                        </button>
                        <button class="btn" style="color: #f56c6c;" onclick="deleteCurrentVersion()">
                            <i class="fas fa-trash"></i> åˆ é™¤æ­¤ç‰ˆæœ¬
                        </button>
                    </div>
                </div>
            </div>

            <footer style="margin-top: 16px;">
                <button onclick="closeModal('versionDetailModal')">å…³é—­</button>
            </footer>
        </div>
    </div>

    <!-- è¯„è®ºé¢æ¿ -->
    <div class="comment-panel" id="commentPanel">
        <div class="comment-panel-header">
            <h4 style="margin: 0;">ğŸ’¬ è„‘å›¾è¯„è®º</h4>
            <button class="icon-btn" onclick="toggleCommentPanel()" style="border: none; background: none; color: #606266;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="comment-panel-content" id="commentList">
            <!-- è¯„è®ºåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="comment-panel-footer">
            <div class="comment-form">
                <textarea
                    id="commentInput"
                    class="comment-textarea"
                    placeholder="æ·»åŠ è¯„è®º... (æ”¯æŒ@èŠ‚ç‚¹å…³è”)"
                    onkeydown="handleCommentKeydown(event)"
                ></textarea>
                <div class="comment-form-actions">
                    <div>
                        <button class="btn" onclick="addCommentAtPosition()" style="font-size: 12px;">
                            <i class="fas fa-map-marker-alt"></i> åœ¨å½“å‰ä½ç½®æ·»åŠ 
                        </button>
                        <button class="btn" onclick="addCommentToSelectedNode()" style="font-size: 12px;">
                            <i class="fas fa-crosshairs"></i> å…³è”é€‰ä¸­èŠ‚ç‚¹
                        </button>
                    </div>
                    <button class="btn primary" onclick="submitComment()">
                        <i class="fas fa-paper-plane"></i> å‘é€
                    </button>
                </div>
            </div>
        </div>
    </div>







    <script src="{{ url_for('static', filename='jsmind.js') }}"></script>
    <script src="{{ url_for('static', filename='jsmind.draggable.js') }}"></script>
    <script src="{{ url_for('static', filename='jsmind.undo.js') }}"></script>
    <!-- HTML2Canvas for frontend image export -->
    <!-- æ›¿æ¢åŸæ¥çš„ CDN é“¾æ¥ -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script> -->
    <script src="{{ url_for('static', filename='html2canvas.min.js') }}"></script>
    <script>
        let jm = null, currentId = null, mapList = [];
        // æ·»åŠ æ ‡ç­¾ç›¸å…³å‡½æ•°
        let allTags = [];
        let currentManagingMindmapId = null;
        // AIå¢å¼ºåŠŸèƒ½å˜é‡
        let currentAIFeature = null;
        let lastAIResult = null;
        // ç‰ˆæœ¬å†å²ç›¸å…³å˜é‡
        let currentVersions = [];
        let currentViewingVersion = null;

        // è¯„è®ºåŠŸèƒ½å˜é‡
        let comments = [];
        let commentMarkers = [];
        let isCommentPanelOpen = false;
        let currentCommentPosition = null;
        // æ·»åŠ å½“å‰ç”¨æˆ·å˜é‡
        let currentUser = null; // æ–°å¢è¿™ä¸€è¡Œ


        /* æ ¡éªŒç™»å½• - æ·»åŠ ç®¡ç†å‘˜æ£€æµ‹ */
        (async function checkLogin() {
            const res = await fetch('/api/me', {credentials: 'include'});
            if (!res.ok) return location.href = 'login.html';
            const userData = await res.json();
            document.getElementById('user').textContent = userData.username;

            // è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯
            currentUser = {
                id: userData.id,
                username: userData.username
            };

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼ˆä¼˜åŒ–é”™è¯¯å¤„ç†ï¼‰
            try {
                const adminRes = await fetch('/api/admin/me', {credentials: 'include'});
                if (adminRes.ok) {
                    const adminData = await adminRes.json();
                    document.getElementById('adminBtn').style.display = 'inline-block';
                    currentUser.role = adminData.role;
                } else {
                    // éç®¡ç†å‘˜ï¼Œéšè—æŒ‰é’®ï¼ˆä¸å†æŠ¥é”™ï¼‰
                    document.getElementById('adminBtn').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('adminBtn').style.display = 'none';
            }

            await loadTags();
            await loadList();
            await initTagFilter();
        })();

        // è·³è½¬åˆ°ç®¡ç†åå°
        function goToAdmin() {
            window.location.href = '/admin/index.html';
        }

        // åœ¨ loadList() å‡½æ•°è°ƒç”¨åï¼Œæ·»åŠ æ ‡ç­¾ç­›é€‰å™¨çš„åˆå§‹åŒ–
        async function initTagFilter() {
            await loadTags(); // ç¡®ä¿æ ‡ç­¾å·²åŠ è½½
            const tagFilter = document.getElementById('tagFilter');

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†"å…¨éƒ¨"ï¼‰
            while (tagFilter.children.length > 1) {
                tagFilter.removeChild(tagFilter.lastChild);
            }

            // æ·»åŠ æ ‡ç­¾é€‰é¡¹
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = tag.name;
                option.style.color = tag.color; // å¯é€‰ï¼šç”¨æ ‡ç­¾é¢œè‰²æ˜¾ç¤º
                tagFilter.appendChild(option);
            });
        }

        function filterByCategory() {
            const category = document.getElementById('categoryFilter').value;
            let filteredList = [...mapList];

            switch(category) {
                case 'recent':
                    // æœ€è¿‘ä½¿ç”¨ï¼šæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼Œå–å‰10ä¸ª
                    filteredList = filteredList
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                        .slice(0, 10);
                    break;
                case 'favorite':
                    // æ”¶è—ï¼šéœ€è¦æ·»åŠ æ”¶è—å­—æ®µï¼Œè¿™é‡Œå…ˆç”¨æ ‡ç­¾æ¨¡æ‹Ÿ
                    filteredList = filteredList.filter(m =>
                        m.tags && m.tags.some(tag => tag.name.toLowerCase().includes('æ”¶è—'))
                    );
                    break;
                case 'work':
                    filteredList = filteredList.filter(m =>
                        m.tags && m.tags.some(tag => tag.name.toLowerCase().includes('å·¥ä½œ'))
                    );
                    break;
                case 'study':
                    filteredList = filteredList.filter(m =>
                        m.tags && m.tags.some(tag => tag.name.toLowerCase().includes('å­¦ä¹ '))
                    );
                    break;
                case 'personal':
                    filteredList = filteredList.filter(m =>
                        m.tags && m.tags.some(tag => tag.name.toLowerCase().includes('ä¸ªäºº'))
                    );
                    break;
                // 'all' å’Œå…¶ä»–æƒ…å†µæ˜¾ç¤ºå…¨éƒ¨
            }

            renderList(filteredList);
        }

        function filterByTag() {
            const tagId = document.getElementById('tagFilter').value;

            if (tagId === 'all') {
                renderList(); // æ˜¾ç¤ºå…¨éƒ¨
            } else {
                const filteredList = mapList.filter(mindmap =>
                    mindmap.tags && mindmap.tags.some(tag => tag.id == tagId)
                );
                renderList(filteredList);
            }
        }





        /* åˆ—è¡¨ */
        async function loadList() {
            const res = await fetch('/api/mindmaps', {credentials: 'include'});
            mapList = await res.json();
            renderList();
        }


        // ä¿®æ”¹ renderList å‡½æ•°ï¼Œåœ¨æ–‡ä»¶åˆ—è¡¨é¡¹ä¸­æ·»åŠ æ ‡ç­¾æ˜¾ç¤º
        function renderList(arr = mapList) {
            const box = document.getElementById('fileList');
            if (!arr.length) return box.innerHTML = '<div style="padding:16px;color:#999">æš‚æ— è„‘å›¾</div>';

            box.innerHTML = arr.map(m => {
                // æ ¼å¼åŒ–æ—¶é—´æˆ³ï¼ˆåŸæœ‰ä»£ç ä¿æŒä¸å˜ï¼‰
                let timeDisplay = '';
                if (m.created_at) {
                    const createDate = new Date(m.created_at);
                    const now = new Date();
                    const diffMs = now - createDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    if (diffMins < 1) {
                        timeDisplay = 'åˆšåˆš';
                    } else if (diffMins < 60) {
                        timeDisplay = `${diffMins}åˆ†é’Ÿå‰`;
                    } else if (diffHours < 24) {
                        timeDisplay = `${diffHours}å°æ—¶å‰`;
                    } else if (diffDays < 7) {
                        timeDisplay = `${diffDays}å¤©å‰`;
                    } else {
                        timeDisplay = createDate.toLocaleDateString('zh-CN', {
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                }

                // ç”Ÿæˆæ ‡ç­¾HTML
                const tagsHtml = m.tags && m.tags.length > 0 ?
                    m.tags.map(tag =>
                        `<span class="tag-badge" style="background: ${tag.color}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 4px;">${tag.name}</span>`
                    ).join('') : '';

                return `
                    <li class="${m.id === currentId ? 'active' : ''}" onclick="openMap(${m.id})">
                        <div style="flex:1;">
                            <div style="font-weight:500;margin-bottom:4px;">${m.name}</div>
                            <div style="font-size:12px;color:#909399;margin-bottom:4px;">${timeDisplay}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 2px;">${tagsHtml}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button onclick="manageTags(event, ${m.id})" style="border:none;background:none;color:#409eff;font-size:12px;padding:4px 8px;">
                                <i class="fas fa-tags"></i>
                            </button>
                            <button onclick="delMap(event, ${m.id})" style="border:none;background:none;color:#f56c6c;font-size:12px;padding:4px 8px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>`;
            }).join('');
        }



        /* æ–°å»º */
        function newMap() {
            document.getElementById('newModal').style.display = 'block';
        }

        async function createMap() {
            const name = document.getElementById('mName').value.trim();
            const topic = document.getElementById('mTopic').value.trim();
            if (!name || !topic) return alert('è¯·å¡«å†™å®Œæ•´');

            // ä½¿ç”¨ jsmind å®Œæ•´çš„æ•°æ®æ ¼å¼
            const data = {
                "meta": {
                    "name": name,
                    "author": document.getElementById('user').textContent,
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": "root",
                    "topic": topic,
                    "direction": "right",
                    "expanded": true,
                    "children": []
                }
            };

            try {
                const res = await fetch('/api/mindmaps', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, data}),
                    credentials: 'include'
                });

                if (!res.ok) {
                    throw new Error('åˆ›å»ºå¤±è´¥: ' + res.status);
                }

                const m = await res.json();
                mapList.push(m);
                renderList();
                closeModal('newModal');

                // ç›´æ¥åˆå§‹åŒ–è„‘å›¾ï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                if (!jm) {
                    initMind(m.data);
                } else {
                    jm.show(m.data);
                }
                currentId = m.id;

            } catch (error) {
                console.error('Create map error:', error);
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        /* æ‰“å¼€ / ä¿å­˜ / åˆ é™¤ */
        // åœ¨æ‰“å¼€è„‘å›¾æ—¶åŠ è½½è¯„è®º
        // ä¿®æ”¹ openMap å‡½æ•°ï¼Œåœ¨æˆåŠŸæ‰“å¼€è„‘å›¾åæ·»åŠ ï¼š
        async function openMap(id) {
            try {
                currentId = id;
                renderList();

                const res = await fetch(`/api/mindmaps/${id}`, {credentials: 'include'});
                if (!res.ok) throw new Error('åŠ è½½è„‘å›¾å¤±è´¥: ' + res.status);

                const m = await res.json();
                console.log('Loaded mind map data:', m);

                // å¤„ç†æ•°æ®æ ¼å¼
                let mindData = m.data;

                if (typeof mindData === 'string') {
                    try {
                        mindData = JSON.parse(mindData);
                    } catch (e) {
                        console.error('Parse data error:', e);
                    }
                }

                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                if (mindData && mindData.format === 'node_tree') {
                    if (jm) {
                        jm.show(mindData);
                    } else {
                        initMind(mindData);
                    }
                } else if (mindData && mindData.id) {
                    const wrappedData = {
                        "meta": {
                            "name": m.name,
                            "author": document.getElementById('user').textContent,
                            "version": "1.0"
                        },
                        "format": "node_tree",
                        "data": mindData
                    };
                    if (jm) {
                        jm.show(wrappedData);
                    } else {
                        initMind(wrappedData);
                    }
                } else {
                    throw new Error('æ— æ•ˆçš„è„‘å›¾æ•°æ®æ ¼å¼');
                }

                // åŠ è½½è¯„è®º
                await loadComments();

            } catch (error) {
                console.error('Open map error:', error);
                alert('æ‰“å¼€è„‘å›¾å¤±è´¥: ' + error.message);
                createDefaultMindMap();
            }
        }

        /* åˆ›å»ºé»˜è®¤è„‘å›¾ */
        function createDefaultMindMap() {
            const defaultData = {
                "meta": {
                    "name": "é»˜è®¤è„‘å›¾",
                    "author": document.getElementById('user').textContent,
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": "root",
                    "topic": "ä¸­å¿ƒä¸»é¢˜",
                    "direction": "right",
                    "expanded": true,
                    "children": []
                }
            };

            if (jm) {
                jm.show(defaultData);
            } else {
                initMind(defaultData);
            }
        }

        // ä¿®æ”¹ä¿å­˜å‡½æ•°ï¼Œåœ¨ä¿å­˜æˆåŠŸåæ˜¾ç¤ºç‰ˆæœ¬æç¤º
        async function saveMap() {
            if (!jm || !currentId) return alert('æ— æ­£åœ¨ç¼–è¾‘çš„è„‘å›¾');

            try {
                const res = await fetch(`/api/mindmaps/${currentId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({data: jm.get_data()}),
                    credentials: 'include'
                });

                if (res.ok) {
                    // æ˜¾ç¤ºç‰ˆæœ¬ä¿å­˜æç¤º
                    showVersionToast('å·²ä¿å­˜å¹¶åˆ›å»ºç‰ˆæœ¬å†å²');
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        function showVersionToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                color: white;
                font-weight: 500;
                transition: all 0.3s ease;
                transform: translateX(100%);
                background: linear-gradient(135deg, #409EFF 0%, #69c0ff 100%);
            `;

            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-history"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            // å…¥åœºåŠ¨ç”»
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }



        async function delMap(e, id) {
            if (e) e.stopPropagation();
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            const res = await fetch(`/api/mindmaps/${id}`, {method: 'DELETE', credentials: 'include'});
            if (!res.ok) return alert('åˆ é™¤å¤±è´¥');
            mapList = mapList.filter(m => m.id !== id);
            currentId = null;
            renderList();
            if (jm) jm.clear();
        }

        /* æœç´¢ */
        function searchMap() {
            const kw = document.getElementById('searchInp').value.trim().toLowerCase();
            renderList(kw ? mapList.filter(m => m.name.toLowerCase().includes(kw)) : mapList);
        }

        /* åˆå§‹åŒ–è„‘å›¾ - å‡å°‘é™åˆ¶ */
        function initMind(data) {
            try {
                console.log('Initializing mind map with data:', data);

                jm = new jsMind({
                    container: 'jsmind_container',
                    theme: 'primary',
                    editable: true,
                    view: {
                        hmargin: 100,
                        vmargin: 50,
                        line_width: 2,
                        line_color: '#409eff'
                    },
                    layout: {
                        hspace: 80,
                        vspace: 20,
                        pspace: 13
                    }
                });

                // æ˜¾ç¤ºè„‘å›¾
                jm.show(data);
                console.log('Mind map initialized successfully');

            } catch (error) {
                console.error('Init mind error:', error);
                alert('åˆå§‹åŒ–è„‘å›¾å¤±è´¥: ' + error.message);

                // ä½¿ç”¨æœ€åŸºæœ¬çš„æ•°æ®é‡è¯•
                const basicData = {
                    "id": "root",
                    "topic": "ä¸­å¿ƒä¸»é¢˜",
                    "children": []
                };
                try {
                    jm.show(basicData);
                } catch (e) {
                    console.error('Fallback also failed:', e);
                }
            }
        }

        /* èŠ‚ç‚¹æ“ä½œ - å‡å°‘é™åˆ¶ */
        function addChild() {
            if (!jm) return alert('è„‘å›¾æœªåˆå§‹åŒ–');
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            const newId = 'node_' + Date.now();
            jm.add_node(node, newId, 'æ–°èŠ‚ç‚¹');
        }

        function addBro() {
            if (!jm) return alert('è„‘å›¾æœªåˆå§‹åŒ–');
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            // å…è®¸åœ¨æ ¹èŠ‚ç‚¹æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
            const newId = 'node_' + Date.now();
            jm.insert_node_after(node, newId, 'å…„å¼ŸèŠ‚ç‚¹');
        }

        function editNode() {
            if (!jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            jm.begin_edit(node);
        }

        function delNode() {
            if (!jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            // å…è®¸åˆ é™¤ä»»ä½•èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬æ ¹èŠ‚ç‚¹ï¼‰
            jm.remove_node(node);
        }

        function moveUp() {
            if (!jm) return;
            const node = jm.get_selected_node();
            if (!node) return;
            jm.move_node(node, 'up');
        }

        function moveDown() {
            if (!jm) return;
            const node = jm.get_selected_node();
            if (!node) return;
            jm.move_node(node, 'down');
        }

        function toggleNode() {
            if (!jm) return;
            const node = jm.get_selected_node();
            if (!node) return alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            jm.toggle_node(node);
        }

        function zoomIn() {
            if (!jm) return;
            jm.view.zoomIn();
        }

        function zoomOut() {
            if (!jm) return;
            jm.view.zoomOut();
        }

        function resetZoom() {
            if (!jm) return;
            jm.view.setZoom(1);
        }

        function undo() {
            if (!jm) return;
            if (jm.undo) jm.undo();
        }

        function redo() {
            if (!jm) return;
            if (jm.redo) jm.redo();
        }

        /* å¯¼å‡ºåŠŸèƒ½ */
        /* å¯¼å‡ºåŠŸèƒ½ - åç«¯å¯¼å‡º */
        function exportMap() {
            if (!jm || !currentId) return alert('æ— æ­£åœ¨ç¼–è¾‘çš„è„‘å›¾');
            document.getElementById('exportModal').style.display = 'block';
        }

        async function exportAsJson() {
            if (!currentId) return alert('æ— æ­£åœ¨ç¼–è¾‘çš„è„‘å›¾');

            try {
                showExportStatus('æ­£åœ¨å¯¼å‡ºJSON...');
                const response = await fetch(`/api/mindmaps/${currentId}/export/json`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥: ' + response.status);

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mindmap-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showExportStatus('JSONå¯¼å‡ºæˆåŠŸï¼');
                closeModal('exportModal');
            } catch (error) {
                console.error('Export error:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        async function exportAsText() {
            if (!currentId) return alert('æ— æ­£åœ¨ç¼–è¾‘çš„è„‘å›¾');

            try {
                showExportStatus('æ­£åœ¨å¯¼å‡ºæ–‡æœ¬...');
                const response = await fetch(`/api/mindmaps/${currentId}/export/text`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥: ' + response.status);

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mindmap-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showExportStatus('æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼');
                closeModal('exportModal');
            } catch (error) {
                console.error('Export error:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        async function exportAsImage() {
            if (!currentId) return alert('æ— æ­£åœ¨ç¼–è¾‘çš„è„‘å›¾');

            try {
                showExportStatus('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...');
                const response = await fetch(`/api/mindmaps/${currentId}/export/image`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 500) {
                        const errorData = await response.json();
                        throw new Error(errorData.msg || 'å›¾ç‰‡å¯¼å‡ºæœåŠ¡å¼‚å¸¸');
                    }
                    throw new Error('å¯¼å‡ºå¤±è´¥: ' + response.status);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mindmap-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showExportStatus('å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼');
                closeModal('exportModal');
            } catch (error) {
                console.error('Export error:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);

                // å¦‚æœåç«¯å›¾ç‰‡å¯¼å‡ºå¤±è´¥ï¼Œå°è¯•å‰ç«¯å¯¼å‡º
                if (confirm('åç«¯å›¾ç‰‡å¯¼å‡ºå¤±è´¥ï¼Œæ˜¯å¦å°è¯•å‰ç«¯å¯¼å‡ºï¼Ÿ')) {
                    frontendExportAsImage();
                }
            }
        }


        // å‰ç«¯å›¾ç‰‡å¯¼å‡ºå¤‡ç”¨æ–¹æ¡ˆ
        function frontendExportAsImage() {
            if (typeof html2canvas !== 'undefined') {
                html2canvas(document.getElementById('jsmind_container')).then(canvas => {
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = `mindmap-${Date.now()}.png`;
                    link.href = image;
                    link.click();
                    showExportStatus('å‰ç«¯å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼');
                }).catch(error => {
                    console.error('Frontend export error:', error);
                    alert('å‰ç«¯å›¾ç‰‡å¯¼å‡ºå¤±è´¥');
                });
            } else {
                alert('å›¾ç‰‡å¯¼å‡ºåŠŸèƒ½éœ€è¦é¢å¤–åº“æ”¯æŒ');
            }
        }


        // æ·»åŠ PDFå¯¼å‡ºå‡½æ•°
        async function exportAsPDF() {
            if (!currentId) return alert('æ— æ­£åœ¨ç¼–è¾‘çš„è„‘å›¾');

            try {
                showExportStatus('æ­£åœ¨ç”ŸæˆPDF...');
                const response = await fetch(`/api/mindmaps/${currentId}/export/pdf`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 500) {
                        const errorData = await response.json();
                        throw new Error(errorData.msg || 'PDFå¯¼å‡ºæœåŠ¡å¼‚å¸¸');
                    }
                    throw new Error('å¯¼å‡ºå¤±è´¥: ' + response.status);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mindmap-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showExportStatus('PDFå¯¼å‡ºæˆåŠŸï¼');
                closeModal('exportModal');
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDFå¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å‡ºçŠ¶æ€æç¤º
        function showExportStatus(message) {
            // ç§»é™¤ç°æœ‰çš„çŠ¶æ€æç¤º
            const existingStatus = document.getElementById('exportStatus');
            if (existingStatus) {
                existingStatus.remove();
            }

            const status = document.createElement('div');
            status.id = 'exportStatus';
            status.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #67c23a;
                color: white;
                padding: 10px 16px;
                border-radius: 4px;
                z-index: 10000;
                box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            `;
            status.textContent = message;
            document.body.appendChild(status);

            setTimeout(() => {
                if (document.body.contains(status)) {
                    document.body.removeChild(status);
                }
            }, 3000);
        }



        function extractTextFromMindmap(node, level = 0) {
            let text = '  '.repeat(level) + node.topic + '\n';
            if (node.children) {
                node.children.forEach(child => {
                    text += extractTextFromMindmap(child, level + 1);
                });
            }
            return text;
        }

        /* åˆ†äº«åŠŸèƒ½ */
        /* åˆ†äº«æƒé™åŠŸèƒ½ */
        /* åˆ†äº«åŠŸèƒ½ */
        async function shareMap() {
            if (!currentId) return alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªè„‘å›¾');

            // é‡ç½®è¡¨å•
            document.getElementById('sharePermission').value = 'readonly';
            document.getElementById('shareExpires').value = '';
            document.getElementById('customExpires').style.display = 'none';
            document.getElementById('shareStatus').style.display = 'none';
            document.getElementById('readonlyLink').textContent = '';
            document.getElementById('editableLink').textContent = '';
            document.getElementById('shareInfoText').textContent = 'è®¾ç½®åˆ†äº«æƒé™å’Œæœ‰æ•ˆæœŸåç”Ÿæˆé“¾æ¥';

            document.getElementById('shareModal').style.display = 'block';
        }

        function updateShareSettings() {
            const expiresSelect = document.getElementById('shareExpires');
            const customExpires = document.getElementById('customExpires');

            if (expiresSelect.value === 'custom') {
                customExpires.style.display = 'block';
            } else {
                customExpires.style.display = 'none';
            }

            // è‡ªåŠ¨æ›´æ–°åˆ†äº«è®¾ç½®
            updateSharePermission();
        }


        async function updateSharePermission() {
            if (!currentId) return;

            const permission = document.getElementById('sharePermission').value;
            const expiresSelect = document.getElementById('shareExpires');
            let expiresIn = null;

            if (expiresSelect.value === 'custom') {
                const customHours = document.getElementById('customHours').value;
                if (!customHours || customHours < 0.0167) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è‡ªå®šä¹‰å°æ—¶æ•°ï¼ˆæœ€å°0.0167å°æ—¶â‰ˆ1åˆ†é’Ÿï¼‰');
                    return;
                }
                expiresIn = parseFloat(customHours);
            } else if (expiresSelect.value) {
                expiresIn = parseFloat(expiresSelect.value);
            }

            try {
                showShareStatus('æ­£åœ¨ç”Ÿæˆåˆ†äº«é“¾æ¥...', 'loading');

                const res = await fetch(`/api/mindmaps/${currentId}/share`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        permission: permission,
                        expires_in: expiresIn
                    }),
                    credentials: 'include'
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.msg || 'æ›´æ–°æƒé™å¤±è´¥');
                }

                const data = await res.json();
                document.getElementById('readonlyLink').textContent = data.readonly_url;
                document.getElementById('editableLink').textContent = data.editable_url;

                // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                let statusText = '';
                if (data.expires_at) {
                    const expiresDate = new Date(data.expires_at);
                    const now = new Date();
                    const diffMs = expiresDate - now;
                    const diffMins = Math.floor(diffMs / 60000);

                    if (diffMins < 1) {
                        statusText = `åˆ†äº«é“¾æ¥æœ‰æ•ˆæœŸè‡³: ${expiresDate.toLocaleString()} (çº¦${Math.floor(diffMs/1000)}ç§’)`;
                    } else if (diffMins < 60) {
                        statusText = `åˆ†äº«é“¾æ¥æœ‰æ•ˆæœŸè‡³: ${expiresDate.toLocaleString()} (çº¦${diffMins}åˆ†é’Ÿ)`;
                    } else {
                        statusText = `åˆ†äº«é“¾æ¥æœ‰æ•ˆæœŸè‡³: ${expiresDate.toLocaleString()}`;
                    }
                } else {
                    statusText = 'åˆ†äº«é“¾æ¥æ°¸ä¹…æœ‰æ•ˆ';
                }

                showShareStatus(statusText, 'success');

                // æ›´æ–°ä¿¡æ¯æ–‡æœ¬
                document.getElementById('shareInfoText').textContent =
                    `å·²ç”Ÿæˆ${permission === 'editable' ? 'å¯ç¼–è¾‘' : 'åªè¯»'}åˆ†äº«é“¾æ¥`;

            } catch (error) {
                console.error('Update permission error:', error);
                showShareStatus('ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }


        function showShareStatus(message, type) {
            const statusElement = document.getElementById('shareStatus');
            const statusText = document.getElementById('statusText');

            statusText.textContent = message;
            statusElement.style.display = 'block';

            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            if (type === 'loading') {
                statusElement.style.background = '#e6f7ff';
                statusElement.style.color = '#1890ff';
            } else if (type === 'success') {
                statusElement.style.background = '#f6ffed';
                statusElement.style.color = '#52c41a';
            } else if (type === 'error') {
                statusElement.style.background = '#fff2f0';
                statusElement.style.color = '#ff4d4f';
            }
        }


        function copyLink(linkId) {
            const linkElement = document.getElementById(linkId);
            const linkText = linkElement.textContent;

            if (!linkText) {
                alert('é“¾æ¥æœªç”Ÿæˆï¼Œè¯·å…ˆè®¾ç½®åˆ†äº«æƒé™');
                return;
            }

            navigator.clipboard.writeText(linkText).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            });
        }


        // åŠ è½½æ‰€æœ‰æ ‡ç­¾
        async function loadTags() {
            try {
                const res = await fetch('/api/tags', { credentials: 'include' });
                if (res.ok) {
                    allTags = await res.json();
                }
            } catch (error) {
                console.error('Load tags error:', error);
            }
        }

        // åˆ›å»ºæ–°æ ‡ç­¾
        async function createTag() {
            const nameInput = document.getElementById('newTagName');
            const colorInput = document.getElementById('newTagColor');

            const name = nameInput.value.trim();
            const color = colorInput.value;

            if (!name) {
                alert('è¯·è¾“å…¥æ ‡ç­¾åç§°');
                return;
            }

            try {
                const res = await fetch('/api/tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color }),
                    credentials: 'include'
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.msg || 'åˆ›å»ºå¤±è´¥');
                }

                const newTag = await res.json();
                allTags.push(newTag);
                nameInput.value = '';
                renderTagsList();

                // æ·»åŠ è¿™ä¸€è¡Œï¼šåˆ·æ–°æ ‡ç­¾ç­›é€‰å™¨
                await initTagFilter();

                // å¦‚æœæ­£åœ¨ä¸ºæŸä¸ªè„‘å›¾ç®¡ç†æ ‡ç­¾ï¼Œåˆ·æ–°è„‘å›¾æ ‡ç­¾
                if (currentManagingMindmapId) {
                    renderMindmapTags(currentManagingMindmapId);
                }

            } catch (error) {
                alert('åˆ›å»ºæ ‡ç­¾å¤±è´¥: ' + error.message);
            }
        }


        // æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨
        function renderTagsList() {
            const tagsList = document.getElementById('tagsList');
            tagsList.innerHTML = allTags.map(tag => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${tag.color};"></span>
                        <span>${tag.name}</span>
                    </div>
                    <div>
                        <button onclick="editTag(${tag.id})" style="border: none; background: none; color: #409eff; cursor: pointer; margin-right: 8px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTag(${tag.id})" style="border: none; background: none; color: #f56c6c; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }


        // ç®¡ç†æ‰€æœ‰æ ‡ç­¾
        function manageAllTags() {
            currentManagingMindmapId = null;
            document.getElementById('tagsModal').style.display = 'block';
            renderTagsList();
        }


        // ä¸ºç‰¹å®šè„‘å›¾ç®¡ç†æ ‡ç­¾
        async function manageTags(event, mindmapId) {
            event.stopPropagation();
            currentManagingMindmapId = mindmapId;
            document.getElementById('tagsModal').style.display = 'block';
            renderTagsList();
            renderMindmapTags(mindmapId);
        }

        // æ¸²æŸ“è„‘å›¾æ ‡ç­¾
        async function renderMindmapTags(mindmapId) {
            // è·å–å½“å‰è„‘å›¾çš„æ ‡ç­¾ä¿¡æ¯
            const mindmap = mapList.find(m => m.id === mindmapId);
            if (!mindmap) return;

            const tagsList = document.getElementById('tagsList');

            // ä¸ºæ¯ä¸ªæ ‡ç­¾æ·»åŠ é€‰æ‹©çŠ¶æ€
            tagsList.innerHTML = allTags.map(tag => {
                const isSelected = mindmap.tags && mindmap.tags.some(t => t.id === tag.id);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleMindmapTag(${mindmapId}, ${tag.id}, this.checked)">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${tag.color};"></span>
                            <span>${tag.name}</span>
                        </div>
                        <div>
                            <button onclick="editTag(${tag.id})" style="border: none; background: none; color: #409eff; cursor: pointer; margin-right: 8px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTag(${tag.id})" style="border: none; background: none; color: #f56c6c; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ‡æ¢è„‘å›¾æ ‡ç­¾
        async function toggleMindmapTag(mindmapId, tagId, isChecked) {
            try {
                const url = `/api/mindmaps/${mindmapId}/tags${isChecked ? '' : `/${tagId}`}`;
                const method = isChecked ? 'POST' : 'DELETE';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: isChecked ? JSON.stringify({ tag_id: tagId }) : undefined,
                    credentials: 'include'
                });

                if (!res.ok) {
                    throw new Error('æ“ä½œå¤±è´¥');
                }

                // æ›´æ–°æœ¬åœ°æ•°æ®
                const mindmap = mapList.find(m => m.id === mindmapId);
                if (mindmap) {
                    if (isChecked) {
                        const tag = allTags.find(t => t.id === tagId);
                        if (tag && (!mindmap.tags || !mindmap.tags.some(t => t.id === tagId))) {
                            if (!mindmap.tags) mindmap.tags = [];
                            mindmap.tags.push(tag);
                        }
                    } else {
                        if (mindmap.tags) {
                            mindmap.tags = mindmap.tags.filter(t => t.id !== tagId);
                        }
                    }
                    renderList();
                }

            } catch (error) {
                console.error('Toggle tag error:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘æ ‡ç­¾
        function editTag(tagId) {
            const tag = allTags.find(t => t.id === tagId);
            if (!tag) return;

            const newName = prompt('è¯·è¾“å…¥æ–°çš„æ ‡ç­¾åç§°:', tag.name);
            if (newName === null) return;

            const newColor = prompt('è¯·è¾“å…¥æ–°çš„æ ‡ç­¾é¢œè‰²(åå…­è¿›åˆ¶):', tag.color);
            if (newColor === null) return;

            updateTag(tagId, newName.trim(), newColor);
        }


        // æ›´æ–°æ ‡ç­¾
        async function updateTag(tagId, name, color) {
            if (!name) {
                alert('æ ‡ç­¾åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            try {
                const res = await fetch(`/api/tags/${tagId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color }),
                    credentials: 'include'
                });

                if (!res.ok) {
                    throw new Error('æ›´æ–°å¤±è´¥');
                }

                // æ›´æ–°æœ¬åœ°æ•°æ®
                const tag = allTags.find(t => t.id === tagId);
                if (tag) {
                    tag.name = name;
                    tag.color = color;
                }

                renderTagsList();

                // å¦‚æœæ­£åœ¨ä¸ºæŸä¸ªè„‘å›¾ç®¡ç†æ ‡ç­¾ï¼Œåˆ·æ–°æ˜¾ç¤º
                if (currentManagingMindmapId) {
                    renderMindmapTags(currentManagingMindmapId);
                }

                // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                renderList();

            } catch (error) {
                alert('æ›´æ–°æ ‡ç­¾å¤±è´¥: ' + error.message);
            }
        }


        // åˆ é™¤æ ‡ç­¾
        async function deleteTag(tagId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªæ ‡ç­¾å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/tags/${tagId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!res.ok) {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }

                // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
                allTags = allTags.filter(t => t.id !== tagId);

                // ä»æ‰€æœ‰è„‘å›¾ä¸­ç§»é™¤è¿™ä¸ªæ ‡ç­¾
                mapList.forEach(mindmap => {
                    if (mindmap.tags) {
                        mindmap.tags = mindmap.tags.filter(t => t.id !== tagId);
                    }
                });

                renderTagsList();
                renderList();

                // æ·»åŠ è¿™ä¸€è¡Œï¼šåˆ·æ–°æ ‡ç­¾ç­›é€‰å™¨
                await initTagFilter();

            } catch (error) {
                alert('åˆ é™¤æ ‡ç­¾å¤±è´¥: ' + error.message);
            }
        }


        /* AIåŠ©æ‰‹åŠŸèƒ½ */
        /* AIåŠ©æ‰‹åŠŸèƒ½ */
        // ä¿®æ”¹ç°æœ‰çš„AIåŠ©æ‰‹æŒ‰é’®ï¼Œæ·»åŠ æ–°åŠŸèƒ½å…¥å£
        function openAIAssistant() {
            if (!jm || !currentId) {
                showAIToast('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªè„‘å›¾', 'warning');
                return;
            }

            // æ˜¾ç¤ºåŠŸèƒ½é€‰æ‹©
            const choice = confirm('é€‰æ‹©AIåŠ©æ‰‹æ¨¡å¼ï¼š\n\n"ç¡®å®š" - é«˜çº§åŠŸèƒ½ï¼ˆæ™ºèƒ½æ‰©å±•ã€ç»“æ„ä¼˜åŒ–ç­‰ï¼‰\n"å–æ¶ˆ" - åŸºç¡€åˆ†æ');

            if (choice) {
                openEnhancedAIAssistant();
            } else {
                // åŸæœ‰çš„åŸºç¡€åˆ†æ
                document.getElementById('aiModal').style.display = 'block';
                document.getElementById('aiResult').style.display = 'none';
                document.getElementById('aiInstruction').value = '';
                resetAnalyzeButton();
            }
        }

        function resetAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.classList.remove('loading');
            analyzeBtn.disabled = false;
        }


        async function analyzeWithAI() {
            if (!jm || !currentId) return;

            const instruction = document.getElementById('aiInstruction').value.trim();
            const mindmapData = jm.get_data();
            const analyzeBtn = document.getElementById('analyzeBtn');

            if (!mindmapData) {
                showAIToast('è„‘å›¾æ•°æ®ä¸ºç©º', 'error');
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                analyzeBtn.classList.add('loading');
                analyzeBtn.disabled = true;

                showAIToast('ğŸ§  AIæ­£åœ¨æ·±åº¦åˆ†æè„‘å›¾ç»“æ„...', 'loading');

                const res = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mindmap_data: mindmapData,
                        instruction: instruction
                    }),
                    credentials: 'include'
                });

                if (!res.ok) {
                    throw new Error('AIåˆ†æå¤±è´¥: ' + res.status);
                }

                const result = await res.json();

                if (result.success) {
                    // æ˜¾ç¤ºåˆ†æç»“æœ
                    document.getElementById('aiAnalysis').innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-chart-line" style="color: #409eff;"></i>
                            <strong>ç»“æ„åˆ†æ</strong>
                        </div>
                        <p style="margin: 0; line-height: 1.5;">${result.analysis}</p>
                    `;

                    // æ˜¾ç¤ºå»ºè®®
                    const suggestionsList = document.getElementById('aiSuggestions');
                    suggestionsList.innerHTML = result.suggestions.map(suggestion =>
                        `<li class="ai-suggestion-item">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-lightbulb" style="color: #52c41a;"></i>
                                <span>${suggestion}</span>
                            </div>
                        </li>`
                    ).join('');

                    document.getElementById('aiResult').style.display = 'block';
                    showAIToast('ğŸ‰ åˆ†æå®Œæˆï¼å·²ç”Ÿæˆä¼˜åŒ–å»ºè®®', 'success');

                    // æ·»åŠ æˆåŠŸåŠ¨ç”»
                    analyzeBtn.style.background = 'linear-gradient(135deg, #52c41a 0%, #73d13d 100%)';
                    setTimeout(() => {
                        analyzeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }, 2000);

                } else {
                    throw new Error(result.msg || 'åˆ†æå¤±è´¥');
                }

            } catch (error) {
                console.error('AI analysis error:', error);
                showAIToast('âŒ åˆ†æå¤±è´¥: ' + error.message, 'error');

                // é”™è¯¯çŠ¶æ€
                analyzeBtn.style.background = 'linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%)';
                setTimeout(() => {
                    analyzeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }, 2000);

            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    resetAnalyzeButton();
                }, 1000);
            }
        }



        // æ›¿æ¢åŸæ¥çš„ showAIStatus å‡½æ•°
        function showAIToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                color: white;
                font-weight: 500;
                transition: all 0.3s ease;
                transform: translateX(100%);
            `;

            const colors = {
                info: 'linear-gradient(135deg, #409EFF 0%, #69c0ff 100%)',
                success: 'linear-gradient(135deg, #52c41a 0%, #73d13d 100%)',
                warning: 'linear-gradient(135deg, #faad14 0%, #ffc53d 100%)',
                error: 'linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%)',
                loading: 'linear-gradient(135deg, #722ed1 0%, #eb2f96 100%)'
            };

            toast.style.background = colors[type] || colors.info;
            toast.textContent = message;
            document.body.appendChild(toast);

            // å…¥åœºåŠ¨ç”»
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // æ‰“å¼€å¢å¼ºçš„AIåŠ©æ‰‹
        function openEnhancedAIAssistant() {
            if (!jm || !currentId) {
                showAIToast('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªè„‘å›¾', 'warning');
                return;
            }
            document.getElementById('enhancedAIModal').style.display = 'block';
            resetAIFeatures();
        }

        // é€‰æ‹©AIåŠŸèƒ½
        function selectAIFeature(feature) {
            currentAIFeature = feature;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.ai-feature-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”çš„åŠŸèƒ½é¢æ¿
            document.querySelectorAll('.ai-feature-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            document.getElementById(feature + 'Feature').style.display = 'block';

            // éšè—ä¹‹å‰çš„ç»“æœ
            document.getElementById('enhancedAIResult').style.display = 'none';
        }

        // å¢å¼ºè„‘å›¾å¤„ç†
        async function enhanceMindmap(enhancementType) {
            if (!jm || !currentId) return;

            const mindmapData = jm.get_data();
            let instruction = '';

            if (enhancementType === 'expand') {
                instruction = document.getElementById('expandInstruction').value.trim();
            } else if (enhancementType === 'analyze') {
                instruction = document.getElementById('analyzeInstruction').value.trim();
            }

            try {
                showAIToast('ğŸ§  AIæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...', 'loading');

                const res = await fetch('/api/ai/enhance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mindmap_data: mindmapData,
                        enhancement_type: enhancementType,
                        instruction: instruction
                    }),
                    credentials: 'include'
                });

                if (!res.ok) {
                    throw new Error('AIå¤„ç†å¤±è´¥: ' + res.status);
                }

                const result = await res.json();

                if (result.success) {
                    lastAIResult = result;
                    displayEnhancedAIResult(result, enhancementType);
                    showAIToast('ğŸ‰ AIå¤„ç†å®Œæˆï¼', 'success');
                } else {
                    throw new Error(result.msg || 'å¤„ç†å¤±è´¥');
                }

            } catch (error) {
                console.error('AI enhance error:', error);
                showAIToast('âŒ å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºå¢å¼ºçš„AIç»“æœ
        function displayEnhancedAIResult(result, feature) {
            const resultContainer = document.getElementById('enhancedAIResult');
            const analysisElement = document.getElementById('enhancedAIAnalysis');
            const suggestionsElement = document.getElementById('enhancedAISuggestions');
            const changesSection = document.getElementById('changesSection');
            const changesElement = document.getElementById('aiChangesMade');

            // æ˜¾ç¤ºåˆ†æç»“æœ
            analysisElement.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="fas fa-chart-bar" style="color: #409eff;"></i>
                    <strong>${getFeatureTitle(feature)}ç»“æœ</strong>
                </div>
                <p style="margin: 0; line-height: 1.6;">${result.analysis}</p>
            `;

            // æ˜¾ç¤ºå»ºè®®
            if (result.suggestions && result.suggestions.length > 0) {
                suggestionsElement.innerHTML = result.suggestions.map(suggestion =>
                    `<li>${suggestion}</li>`
                ).join('');
            } else {
                suggestionsElement.innerHTML = '<li>æš‚æ— å…·ä½“å»ºè®®</li>';
            }

            // æ˜¾ç¤ºå˜æ›´å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (result.enhanced_data && result.changes_made && result.changes_made.length > 0) {
                changesSection.style.display = 'block';
                changesElement.innerHTML = result.changes_made.map(change =>
                    `<div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                        <i class="fas fa-check-circle" style="color: #52c41a; margin-right: 8px;"></i>
                        ${change}
                    </div>`
                ).join('');
            } else {
                changesSection.style.display = 'none';
            }

            resultContainer.style.display = 'block';
        }

        // æ•°æ®éªŒè¯å‡½æ•°
        function validateMindmapData(data) {
            if (!data) return false;

            // æ£€æŸ¥å®Œæ•´æ ¼å¼
            if (data.format === 'node_tree' && data.data) {
                return validateNodeData(data.data);
            }

            // æ£€æŸ¥èŠ‚ç‚¹æ•°æ®æ ¼å¼
            if (data.id && data.topic) {
                return validateNodeData(data);
            }

            return false;
        }

        function validateNodeData(node) {
            if (!node || typeof node !== 'object') return false;
            if (!node.id || !node.topic) return false;
            return true;
        }

        // åº”ç”¨AIå˜æ›´åˆ°è„‘å›¾
        // åº”ç”¨AIå˜æ›´åˆ°è„‘å›¾
        function applyAIChanges() {
            if (!lastAIResult || !lastAIResult.enhanced_data) {
                showAIToast('æ²¡æœ‰å¯åº”ç”¨çš„å˜æ›´', 'warning');
                return;
            }

            try {
                const enhancedData = lastAIResult.enhanced_data;

                // éªŒè¯æ•°æ®
                if (!validateMindmapData(enhancedData)) {
                    throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼æ— æ•ˆ');
                }

                // æ›´æ–°è„‘å›¾æ•°æ®
                jm.show(enhancedData);
                showAIToast('âœ… å˜æ›´å·²åº”ç”¨åˆ°è„‘å›¾', 'success');

                // è‡ªåŠ¨ä¿å­˜
                setTimeout(saveMap, 1000);

            } catch (error) {
                console.error('Apply AI changes error:', error);
                showAIToast('åº”ç”¨å˜æ›´å¤±è´¥: ' + error.message, 'error');

                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•
                console.log('=== AI Changes Debug Info ===');
                console.log('Last AI Result:', lastAIResult);
                console.log('Enhanced Data:', lastAIResult?.enhanced_data);
                console.log('Current jm data:', jm?.get_data());
            }
        }

        // è·å–åŠŸèƒ½æ ‡é¢˜
        function getFeatureTitle(feature) {
            const titles = {
                'expand': 'æ™ºèƒ½æ‰©å±•',
                'optimize': 'ç»“æ„ä¼˜åŒ–',
                'summarize': 'å†…å®¹æ‘˜è¦',
                'suggest_topics': 'ä¸»é¢˜æ¨è',
                'check_balance': 'å¹³è¡¡æ£€æŸ¥',
                'analyze': 'æ·±åº¦åˆ†æ'
            };
            return titles[feature] || 'AIåˆ†æ';
        }

        // é‡ç½®AIåŠŸèƒ½
        function resetAIFeatures() {
            currentAIFeature = null;
            lastAIResult = null;

            document.querySelectorAll('.ai-feature-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.querySelectorAll('.ai-feature-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            document.getElementById('enhancedAIResult').style.display = 'none';
            document.getElementById('expandInstruction').value = '';
            document.getElementById('analyzeInstruction').value = '';
        }

        // å…³é—­å¢å¼ºAIæ¨¡æ€æ¡†
        function closeEnhancedAIModal() {
            document.getElementById('enhancedAIModal').style.display = 'none';
            resetAIFeatures();
        }

        // ç‰ˆæœ¬å†å²åŠŸèƒ½
        async function showVersionHistory() {
            if (!currentId) {
                alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªè„‘å›¾');
                return;
            }

            // è·å–å½“å‰è„‘å›¾åç§°
            const currentMindmap = mapList.find(m => m.id === currentId);
            if (currentMindmap) {
                document.getElementById('versionMindmapName').textContent = currentMindmap.name;
            }

            document.getElementById('versionHistoryModal').style.display = 'block';
            await loadVersions();
        }

        async function loadVersions() {
            try {
                const res = await fetch(`/api/mindmaps/${currentId}/versions`, {
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('åŠ è½½ç‰ˆæœ¬å†å²å¤±è´¥');

                currentVersions = await res.json();
                renderVersionsList();

            } catch (error) {
                console.error('Load versions error:', error);
                alert('åŠ è½½ç‰ˆæœ¬å†å²å¤±è´¥: ' + error.message);
            }
        }

        function renderVersionsList() {
            const versionsList = document.getElementById('versionsList');

            if (currentVersions.length === 0) {
                versionsList.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #909399;">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>æš‚æ— ç‰ˆæœ¬å†å²</p>
                    </div>
                `;
                return;
            }

            versionsList.innerHTML = currentVersions.map(version => `
                <div class="version-item" style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;"
                     onclick="showVersionDetail(${version.id})">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <strong style="color: #409eff;">v${version.version_number}</strong>
                                <span style="font-size: 12px; color: #909399;">${formatVersionTime(version.created_at)}</span>
                            </div>
                            <div style="margin-bottom: 4px;">
                                <span style="font-size: 14px;">${version.change_description || 'æ— æè¿°'}</span>
                            </div>
                            <div style="display: flex; gap: 12px; font-size: 12px; color: #909399;">
                                <span><i class="fas fa-user"></i> ${version.created_by}</span>
                                <span><i class="fas fa-sitemap"></i> ${version.preview.child_count} ä¸ªç›´æ¥å­èŠ‚ç‚¹</span>
                                <span><i class="fas fa-circle-nodes"></i> ${version.preview.total_nodes} ä¸ªæ€»èŠ‚ç‚¹</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn" onclick="event.stopPropagation(); restoreVersion(${version.id})"
                                    style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-history"></i> æ¢å¤
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            const versionItems = versionsList.querySelectorAll('.version-item');
            versionItems.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f5f7fa';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'transparent';
                });
            });
        }

        function formatVersionTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;

            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        }

        async function showVersionDetail(versionId) {
            try {
                const res = await fetch(`/api/mindmaps/${currentId}/versions/${versionId}`, {
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('åŠ è½½ç‰ˆæœ¬è¯¦æƒ…å¤±è´¥');

                currentViewingVersion = await res.json();
                renderVersionDetail();
                document.getElementById('versionDetailModal').style.display = 'block';

            } catch (error) {
                console.error('Load version detail error:', error);
                alert('åŠ è½½ç‰ˆæœ¬è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        function renderVersionDetail() {
            if (!currentViewingVersion) return;

            const version = currentViewingVersion;

            document.getElementById('detailVersionNumber').textContent = version.version_number;
            document.getElementById('detailVersionNum').textContent = version.version_number;
            document.getElementById('detailCreatedAt').textContent = formatVersionTime(version.created_at);
            document.getElementById('detailCreatedBy').textContent = version.created_by;
            document.getElementById('detailChangeDesc').textContent = version.change_description || 'æ— æè¿°';

            // æ¸²æŸ“é¢„è§ˆ
            const previewElement = document.getElementById('versionPreview');
            previewElement.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>æ ¹èŠ‚ç‚¹:</strong> ${version.data.data?.topic || version.data.topic || 'æ— æ ‡é¢˜'}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>å­èŠ‚ç‚¹é¢„è§ˆ:</strong>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${renderVersionPreviewTree(version.data.data || version.data)}
                </div>
            `;
        }

        function renderVersionPreviewTree(node, level = 0) {
            let html = '';
            const indent = '  '.repeat(level);

            html += `<div style="padding: 2px 0; margin-left: ${level * 16}px; font-size: 13px;">
                ${level === 0 ? 'â—' : 'â—‹'} ${node.topic || 'æ— æ ‡é¢˜'}
            </div>`;

            if (node.children && node.children.length > 0 && level < 2) { // é™åˆ¶é¢„è§ˆæ·±åº¦
                node.children.forEach(child => {
                    html += renderVersionPreviewTree(child, level + 1);
                });
            }

            return html;
        }

        async function createManualVersion() {
            const description = document.getElementById('versionDescription').value.trim() || 'æ‰‹åŠ¨åˆ›å»ºç‰ˆæœ¬';

            try {
                const res = await fetch(`/api/mindmaps/${currentId}/versions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        change_description: description
                    }),
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('åˆ›å»ºç‰ˆæœ¬å¤±è´¥');

                const result = await res.json();
                alert('ç‰ˆæœ¬åˆ›å»ºæˆåŠŸ');
                document.getElementById('versionDescription').value = '';
                await loadVersions();

            } catch (error) {
                console.error('Create version error:', error);
                alert('åˆ›å»ºç‰ˆæœ¬å¤±è´¥: ' + error.message);
            }
        }

        async function restoreVersion(versionId) {
            if (!confirm('ç¡®å®šè¦æ¢å¤åˆ°è¿™ä¸ªç‰ˆæœ¬å—ï¼Ÿå½“å‰ç‰ˆæœ¬å°†è‡ªåŠ¨ä¿å­˜ã€‚')) {
                return;
            }

            try {
                const res = await fetch(`/api/mindmaps/${currentId}/versions/${versionId}/restore`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('æ¢å¤ç‰ˆæœ¬å¤±è´¥');

                const result = await res.json();
                alert(result.msg);

                // é‡æ–°åŠ è½½å½“å‰è„‘å›¾
                await openMap(currentId);
                await loadVersions();

                // å…³é—­æ¨¡æ€æ¡†
                closeModal('versionDetailModal');

            } catch (error) {
                console.error('Restore version error:', error);
                alert('æ¢å¤ç‰ˆæœ¬å¤±è´¥: ' + error.message);
            }
        }

        async function deleteCurrentVersion() {
            if (!currentViewingVersion || !confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç‰ˆæœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const res = await fetch(`/api/mindmaps/${currentId}/versions/${currentViewingVersion.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('åˆ é™¤ç‰ˆæœ¬å¤±è´¥');

                alert('ç‰ˆæœ¬åˆ é™¤æˆåŠŸ');
                closeModal('versionDetailModal');
                await loadVersions();

            } catch (error) {
                console.error('Delete version error:', error);
                alert('åˆ é™¤ç‰ˆæœ¬å¤±è´¥: ' + error.message);
            }
        }

        function restoreCurrentVersion() {
            if (currentViewingVersion) {
                restoreVersion(currentViewingVersion.id);
            }
        }



        function compareWithCurrent() {
            if (!currentViewingVersion) return;

            // è¿™é‡Œå¯ä»¥å®ç°ç‰ˆæœ¬æ¯”è¾ƒåŠŸèƒ½
            alert('ç‰ˆæœ¬æ¯”è¾ƒåŠŸèƒ½å¼€å‘ä¸­...');
        }

        // è¯„è®ºåŠŸèƒ½
        function toggleCommentPanel() {
            const panel = document.getElementById('commentPanel');
            isCommentPanelOpen = !isCommentPanelOpen;

            if (isCommentPanelOpen) {
                panel.style.display = 'flex';
                loadComments();
            } else {
                panel.style.display = 'none';
                clearCommentMarkers();
            }
        }

        async function loadComments() {
            if (!currentId) return;

            try {
                const res = await fetch(`/api/mindmaps/${currentId}/comments`, {
                    credentials: 'include'
                });

                if (res.ok) {
                    comments = await res.json();
                    renderComments();
                    renderCommentMarkers();
                    updateCommentCount();
                } else {
                    console.error('Failed to load comments:', res.status);
                }
            } catch (error) {
                console.error('Load comments error:', error);
                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                const commentList = document.getElementById('commentList');
                commentList.innerHTML = `
                    <div style="text-align: center; color: #f56c6c; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>åŠ è½½è¯„è®ºå¤±è´¥</p>
                    </div>
                `;
            }
        }


        function renderComments() {
            const commentList = document.getElementById('commentList');

            if (comments.length === 0) {
                commentList.innerHTML = `
                    <div style="text-align: center; color: #909399; padding: 40px;">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>æš‚æ— è¯„è®º</p>
                        <p style="font-size: 14px;">ç‚¹å‡»"åœ¨å½“å‰ä½ç½®æ·»åŠ "æˆ–"å…³è”é€‰ä¸­èŠ‚ç‚¹"æ¥æ·»åŠ è¯„è®º</p>
                    </div>
                `;
                return;
            }

            commentList.innerHTML = comments.map(comment => `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">${comment.username}</span>
                        <span class="comment-time">${formatCommentTime(comment.created_at)}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(comment.content)}</div>
                    <div class="comment-actions">
                        <span class="comment-action" onclick="replyToComment(${comment.id}, '${comment.username}')">
                            <i class="fas fa-reply"></i> å›å¤
                        </span>
                        ${comment.user_id === (currentUser ? currentUser.id : -1) ? `
                            <span class="comment-action" onclick="editComment(${comment.id})">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </span>
                            <span class="comment-action" onclick="deleteComment(${comment.id})" style="color: #f56c6c;">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </span>
                        ` : ''}
                        ${comment.node_id ? `
                            <span class="comment-action" onclick="highlightCommentNode('${comment.node_id}')">
                                <i class="fas fa-crosshairs"></i> å®šä½èŠ‚ç‚¹
                            </span>
                        ` : ''}
                    </div>
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div class="comment-replies">
                            ${comment.replies.map(reply => `
                                <div class="comment-item reply">
                                    <div class="comment-header">
                                        <span class="comment-author">${reply.username}</span>
                                        <span class="comment-time">${formatCommentTime(reply.created_at)}</span>
                                    </div>
                                    <div class="comment-content">${escapeHtml(reply.content)}</div>
                                    <div class="comment-actions">
                                        ${reply.user_id === (currentUser ? currentUser.id : -1) ? `
                                            <span class="comment-action" onclick="editComment(${reply.id})">
                                                <i class="fas fa-edit"></i> ç¼–è¾‘
                                            </span>
                                            <span class="comment-action" onclick="deleteComment(${reply.id})" style="color: #f56c6c;">
                                                <i class="fas fa-trash"></i> åˆ é™¤
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderCommentMarkers() {
            clearCommentMarkers();

            comments.forEach(comment => {
                if (comment.x !== null && comment.y !== null) {
                    createCommentMarker(comment);
                }
            });
        }

        function createCommentMarker(comment) {
            const mindbox = document.querySelector('.mindbox');
            const marker = document.createElement('div');
            marker.className = 'comment-marker';
            marker.style.left = comment.x + 'px';
            marker.style.top = comment.y + 'px';
            marker.title = `${comment.username}: ${comment.content.substring(0, 50)}...`;
            marker.innerHTML = '<i class="fas fa-comment"></i>';

            marker.addEventListener('click', () => {
                showCommentDetails(comment);
            });

            mindbox.appendChild(marker);
            commentMarkers.push(marker);
        }

        function clearCommentMarkers() {
            commentMarkers.forEach(marker => marker.remove());
            commentMarkers = [];
        }

        function showCommentDetails(comment) {
            // é«˜äº®æ˜¾ç¤ºè¯„è®º
            const commentElement = document.querySelector(`[data-comment-id="${comment.id}"]`);
            if (commentElement) {
                commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                commentElement.style.background = '#e6f7ff';
                setTimeout(() => {
                    commentElement.style.background = '';
                }, 2000);
            }
        }

        function addCommentAtPosition() {
            if (!jm) return;

            const view = jm.view;
            const centerX = view.elements.container.clientWidth / 2;
            const centerY = view.elements.container.clientHeight / 2;

            currentCommentPosition = { x: centerX, y: centerY };
            document.getElementById('commentInput').placeholder = "æ·»åŠ è¯„è®º (å°†åœ¨è„‘å›¾ä¸­å¿ƒä½ç½®æ˜¾ç¤ºæ ‡è®°)...";
            document.getElementById('commentInput').focus();
        }

        function addCommentToSelectedNode() {
            if (!jm) return;

            const selectedNode = jm.get_selected_node();
            if (!selectedNode) {
                alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
                return;
            }

            const nodeElement = document.querySelector(`[nodeid="${selectedNode.id}"]`);
            if (nodeElement) {
                const rect = nodeElement.getBoundingClientRect();
                const mindboxRect = document.querySelector('.mindbox').getBoundingClientRect();

                currentCommentPosition = {
                    x: rect.left + rect.width / 2 - mindboxRect.left,
                    y: rect.top + rect.height / 2 - mindboxRect.top,
                    nodeId: selectedNode.id
                };

                document.getElementById('commentInput').placeholder = `æ·»åŠ è¯„è®º (å…³è”èŠ‚ç‚¹: ${selectedNode.topic})...`;
                document.getElementById('commentInput').focus();
            }
        }

        async function submitComment() {
            const content = document.getElementById('commentInput').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            if (!currentId) {
                alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªè„‘å›¾');
                return;
            }

            try {
                const commentData = {
                    content: content,
                    x: currentCommentPosition ? currentCommentPosition.x : null,
                    y: currentCommentPosition ? currentCommentPosition.y : null,
                    node_id: currentCommentPosition ? currentCommentPosition.node_id : null
                };

                const res = await fetch(`/api/mindmaps/${currentId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(commentData),
                    credentials: 'include'
                });

                if (res.ok) {
                    document.getElementById('commentInput').value = '';
                    currentCommentPosition = null;
                    document.getElementById('commentInput').placeholder = "æ·»åŠ è¯„è®º...";
                    await loadComments();
                    showAIToast('è¯„è®ºæ·»åŠ æˆåŠŸ', 'success');
                } else {
                    throw new Error('æ·»åŠ è¯„è®ºå¤±è´¥');
                }
            } catch (error) {
                console.error('Submit comment error:', error);
                alert('æ·»åŠ è¯„è®ºå¤±è´¥: ' + error.message);
            }
        }

        function handleCommentKeydown(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                submitComment();
            }
        }

        function replyToComment(commentId, username) {
            document.getElementById('commentInput').value = `@${username} `;
            document.getElementById('commentInput').focus();

            // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ”¯æŒå›å¤åŠŸèƒ½
            // éœ€è¦ä¿®æ”¹ submitComment å‡½æ•°æ¥å¤„ç† parent_id
        }

        async function editComment(commentId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            const comment = findCommentById(commentId);
            if (!comment) return;

            const newContent = prompt('ç¼–è¾‘è¯„è®º:', comment.content);
            if (newContent === null || newContent.trim() === '') return;

            try {
                const res = await fetch(`/api/mindmaps/${currentId}/comments/${commentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newContent.trim() }),
                    credentials: 'include'
                });

                if (res.ok) {
                    await loadComments();
                    showAIToast('è¯„è®ºæ›´æ–°æˆåŠŸ', 'success');
                } else {
                    throw new Error('æ›´æ–°è¯„è®ºå¤±è´¥');
                }
            } catch (error) {
                console.error('Edit comment error:', error);
                alert('æ›´æ–°è¯„è®ºå¤±è´¥: ' + error.message);
            }
        }

        async function deleteComment(commentId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/mindmaps/${currentId}/comments/${commentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    await loadComments();
                    showAIToast('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
                } else {
                    throw new Error('åˆ é™¤è¯„è®ºå¤±è´¥');
                }
            } catch (error) {
                console.error('Delete comment error:', error);
                alert('åˆ é™¤è¯„è®ºå¤±è´¥: ' + error.message);
            }
        }

        function highlightCommentNode(nodeId) {
            if (!jm) return;

            const node = jm.get_node(nodeId);
            if (node) {
                jm.select_node(node);

                // æ·»åŠ é«˜äº®æ•ˆæœ
                const nodeElement = document.querySelector(`[nodeid="${nodeId}"]`);
                if (nodeElement) {
                    nodeElement.style.boxShadow = '0 0 0 3px #ff4d4f';
                    setTimeout(() => {
                        nodeElement.style.boxShadow = '';
                    }, 3000);
                }
            }
        }

        function findCommentById(commentId) {
            for (let comment of comments) {
                if (comment.id === commentId) {
                    // æ£€æŸ¥æƒé™
                    if (currentUser && comment.user_id === currentUser.id) {
                        return comment;
                    }
                    return null;
                }
                if (comment.replies) {
                    for (let reply of comment.replies) {
                        if (reply.id === commentId) {
                            // æ£€æŸ¥æƒé™
                            if (currentUser && reply.user_id === currentUser.id) {
                                return reply;
                            }
                            return null;
                        }
                    }
                }
            }
            return null;
        }

        function formatCommentTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;

            return date.toLocaleDateString('zh-CN');
        }

        function updateCommentCount() {
            const badge = document.getElementById('commentCountBadge');
            const totalComments = comments.reduce((total, comment) => {
                return total + 1 + (comment.replies ? comment.replies.length : 0);
            }, 0);

            if (totalComments > 0) {
                badge.textContent = totalComments;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, '<br>');
        }
























        /* é€€å‡º */
        async function logout() {
            await fetch('/api/logout', {method: 'POST', credentials: 'include'});
            location.href = 'login.html';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'newModal') {
                document.getElementById('mName').value = '';
                document.getElementById('mTopic').value = '';
            }
        }

    </script>
</body>
</html>
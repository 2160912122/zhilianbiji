<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºè”ç¬”è®° - ç®¡ç†åå°</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='all.min.css') }}">
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei"}
        body{display:flex;flex-direction:column;height:100vh;background:#f5f7fa}
        header{height:56px;background:#409eff;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 24px}
        header .btn{padding:6px 14px;border:none;border-radius:4px;background:#fff;color:#409eff;cursor:pointer;font-size:14px}
        .container{display:flex;flex:1;overflow:hidden}
        .sidebar{width:240px;background:#fff;border-right:1px solid #e4e7ed;padding:20px 0}
        .sidebar-item{padding:12px 24px;cursor:pointer;transition:background .3s;display:flex;align-items:center;gap:10px}
        .sidebar-item:hover{background:#f0f9ff}
        .sidebar-item.active{background:#e6f7ff;color:#409eff;border-right:3px solid #409eff}
        .main-content{flex:1;padding:24px;overflow-y:auto}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .stat-card h3{font-size:14px;color:#909399;margin-bottom:12px}
        .stat-card .value{font-size:32px;font-weight:600;color:#303133}
        .stat-card .trend{font-size:12px;margin-top:8px}
        .trend.up{color:#67c23a}
        .trend.down{color:#f56c6c}
        .content-section{background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:24px;overflow:hidden}
        .section-header{padding:16px 24px;border-bottom:1px solid #e4e7ed;display:flex;justify-content:space-between;align-items:center}
        .section-body{padding:24px}
        .table{width:100%;border-collapse:collapse}
        .table th,.table td{padding:12px;text-align:left;border-bottom:1px solid #e4e7ed}
        .table th{background:#fafafa;font-weight:500;color:#606266}
        .btn{padding:8px 16px;border:1px solid #dcdfe6;background:#fff;border-radius:4px;cursor:pointer;font-size:14px;transition:all .3s}
        .btn.primary{background:#409eff;color:#fff;border-color:#409eff}
        .btn.danger{background:#f56c6c;color:#fff;border-color:#f56c6c}
        .btn.small{padding:4px 8px;font-size:12px}
        .search-box{padding:8px 12px;border:1px solid #dcdfe6;border-radius:4px;font-size:14px;width:200px}
        .pagination{display:flex;gap:8px;justify-content:center;margin-top:20px}
        .pagination .btn{min-width:32px}
        .pagination .btn.active{background:#409eff;color:#fff}
        .badge{padding:4px 8px;border-radius:10px;font-size:12px;font-weight:500}
        .badge.success{background:#f0f9ff;color:#409eff}
        .badge.warning{background:#fdf6ec;color:#e6a23c}
        .badge.danger{background:#fef0f0;color:#f56c6c}
    </style>
</head>
<body>
    <header>
        <span style="font-size:18px;font-weight:500">ğŸ§  æ™ºè”ç¬”è®° - ç®¡ç†åå°</span>
        <div>
            <span id="adminInfo" style="margin-right:12px"></span>
            <button class="btn" onclick="logout()">é€€å‡º</button>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-item active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>ç³»ç»Ÿæ¦‚è§ˆ</span>
            </div>
            <div class="sidebar-item" onclick="showSection('users')">
                <i class="fas fa-users"></i>
                <span>ç”¨æˆ·ç®¡ç†</span>
            </div>
            <div class="sidebar-item" onclick="showSection('mindmaps')">
                <i class="fas fa-project-diagram"></i>
                <span>è„‘å›¾ç®¡ç†</span>
            </div>
            <div class="sidebar-item" onclick="showSection('logs')">
                <i class="fas fa-clipboard-list"></i>
                <span>ç³»ç»Ÿæ—¥å¿—</span>
            </div>
        </div>

        <div class="main-content">
            <!-- ç³»ç»Ÿæ¦‚è§ˆ -->
            <div id="dashboard-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æ€»ç”¨æˆ·æ•°</h3>
                        <div class="value" id="totalUsers">0</div>
                        <div class="trend up" id="activeUsersTrend">æ´»è·ƒç”¨æˆ·: 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ€»è„‘å›¾æ•°</h3>
                        <div class="value" id="totalMindmaps">0</div>
                        <div class="trend up" id="recentMindmapsTrend">è¿‘7å¤©æ–°å¢: 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ ‡ç­¾æ•°é‡</h3>
                        <div class="value" id="totalTags">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>å­˜å‚¨ä½¿ç”¨</h3>
                        <div class="value" id="totalStorage">0 MB</div>
                        <div class="trend">å…±äº«è„‘å›¾: <span id="sharedMindmaps">0</span></div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h3>æœ€è¿‘æ´»åŠ¨</h3>
                    </div>
                    <div class="section-body">
                        <div id="recentActivity">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="users-section" style="display:none">
                <div class="content-section">
                    <div class="section-header">
                        <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                        <div>
                            <input type="text" id="userSearch" class="search-box" placeholder="æœç´¢ç”¨æˆ·..." oninput="searchUsers()">
                        </div>
                    </div>
                    <div class="section-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è„‘å›¾æ•°é‡</th>
                                    <th>æ ‡ç­¾æ•°é‡</th>
                                    <th>æœ€åæ´»è·ƒ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                        <div class="pagination" id="usersPagination"></div>
                    </div>
                </div>
            </div>

            <!-- è„‘å›¾ç®¡ç† -->
            <div id="mindmaps-section" style="display:none">
                <div class="content-section">
                    <div class="section-header">
                        <h3>è„‘å›¾åˆ—è¡¨</h3>
                        <div>
                            <input type="text" id="mindmapSearch" class="search-box" placeholder="æœç´¢è„‘å›¾..." oninput="searchMindmaps()">
                        </div>
                    </div>
                    <div class="section-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>åç§°</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>èŠ‚ç‚¹æ•°</th>
                                    <th>åˆ†äº«çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="mindmapsTableBody"></tbody>
                        </table>
                        <div class="pagination" id="mindmapsPagination"></div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿæ—¥å¿— -->
            <div id="logs-section" style="display:none">
                <div class="content-section">
                    <div class="section-header">
                        <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                    </div>
                    <div class="section-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>çº§åˆ«</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ¶ˆæ¯</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'dashboard';
        let currentUserPage = 1;
        let currentMindmapPage = 1;

        // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
        (async function checkAdminLogin() {
            try {
                const res = await fetch('/api/admin/me', {credentials: 'include'});
                if (!res.ok) {
                    location.href = '/admin/login.html';
                    return;
                }
                const admin = await res.json();
                document.getElementById('adminInfo').textContent =
                    `${admin.username} (${admin.role === 'super_admin' ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'})`;
                loadDashboard();
            } catch (error) {
                location.href = '/admin/login.html';
            }
        })();

        // æ˜¾ç¤ºä¸åŒéƒ¨åˆ†
        function showSection(section) {
            document.getElementById(currentSection + '-section').style.display = 'none';
            document.querySelector(`.sidebar-item[onclick="showSection('${currentSection}')"]`).classList.remove('active');

            currentSection = section;
            document.getElementById(section + '-section').style.display = 'block';
            document.querySelector(`.sidebar-item[onclick="showSection('${section}')"]`).classList.add('active');

            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'mindmaps':
                    loadMindmaps();
                    break;
                case 'logs':
                    loadLogs();
                    break;
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿
        async function loadDashboard() {
            try {
                const res = await fetch('/api/admin/stats', {credentials: 'include'});
                const stats = await res.json();

                document.getElementById('totalUsers').textContent = stats.users.total;
                document.getElementById('activeUsersTrend').textContent =
                    `æ´»è·ƒç”¨æˆ·: ${stats.users.active}`;
                document.getElementById('totalMindmaps').textContent = stats.mindmaps.total;
                document.getElementById('recentMindmapsTrend').textContent =
                    `è¿‘7å¤©æ–°å¢: ${stats.mindmaps.recent_7_days}`;
                document.getElementById('totalTags').textContent = stats.tags.total;
                document.getElementById('totalStorage').textContent = stats.storage.total_mb + ' MB';
                document.getElementById('sharedMindmaps').textContent = stats.mindmaps.shared;

                // åŠ è½½æœ€è¿‘æ´»åŠ¨
                const activityRes = await fetch('/api/admin/mindmaps?per_page=5', {credentials: 'include'});
                const activityData = await activityRes.json();

                const activityHtml = activityData.mindmaps.map(m => `
                    <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="font-weight: 500;">${m.name}</div>
                        <div style="font-size: 12px; color: #909399;">
                            ç”¨æˆ·: ${m.username} | åˆ›å»º: ${new Date(m.created_at).toLocaleString()}
                        </div>
                    </div>
                `).join('');

                document.getElementById('recentActivity').innerHTML = activityHtml || 'æš‚æ— æ´»åŠ¨';
            } catch (error) {
                console.error('Load dashboard error:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers(page = 1) {
            try {
                const search = document.getElementById('userSearch').value;
                const res = await fetch(`/api/admin/users?page=${page}&search=${search}`, {credentials: 'include'});
                const data = await res.json();

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.mindmaps_count}</td>
                        <td>${user.tags_count}</td>
                        <td>${user.last_active ? new Date(user.last_active).toLocaleDateString() : 'ä»æœªæ´»è·ƒ'}</td>
                        <td>
                            <button class="btn danger small" onclick="deleteUser(${user.id})" ${user.mindmaps_count > 0 ? 'title="è¯¥ç”¨æˆ·æœ‰è„‘å›¾æ•°æ®ï¼Œæ— æ³•åˆ é™¤"' : ''} ${user.mindmaps_count > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `).join('');

                renderPagination('usersPagination', data, page, loadUsers);
            } catch (error) {
                console.error('Load users error:', error);
            }
        }

        // åŠ è½½è„‘å›¾åˆ—è¡¨
        async function loadMindmaps(page = 1) {
            try {
                const search = document.getElementById('mindmapSearch').value;
                const res = await fetch(`/api/admin/mindmaps?page=${page}&search=${search}`, {credentials: 'include'});
                const data = await res.json();

                const tbody = document.getElementById('mindmapsTableBody');
                tbody.innerHTML = data.mindmaps.map(mindmap => `
                    <tr>
                        <td>${mindmap.id}</td>
                        <td>${mindmap.name}</td>
                        <td>${mindmap.username}</td>
                        <td>${mindmap.nodes_count}</td>
                        <td>
                            ${mindmap.is_shared ?
                                `<span class="badge ${mindmap.share_permission === 'editable' ? 'warning' : 'success'}">
                                    ${mindmap.share_permission === 'editable' ? 'å¯ç¼–è¾‘' : 'åªè¯»'}
                                </span>` :
                                '<span class="badge">æœªåˆ†äº«</span>'
                            }
                        </td>
                        <td>${new Date(mindmap.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn danger small" onclick="deleteMindmap(${mindmap.id})">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `).join('');

                renderPagination('mindmapsPagination', data, page, loadMindmaps);
            } catch (error) {
                console.error('Load mindmaps error:', error);
            }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const res = await fetch('/api/admin/logs', {credentials: 'include'});
                const data = await res.json();

                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = data.logs.map(log => `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td>
                            <span class="badge ${log.level === 'ERROR' ? 'danger' : log.level === 'WARN' ? 'warning' : 'success'}">
                                ${log.level}
                            </span>
                        </td>
                        <td>${log.user}</td>
                        <td>${log.message}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load logs error:', error);
            }
        }

        // åˆ†é¡µç»„ä»¶
        function renderPagination(containerId, data, currentPage, callback) {
            const container = document.getElementById(containerId);
            if (data.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= data.pages; i++) {
                html += `<button class="btn small ${i === currentPage ? 'active' : ''}" onclick="${callback.name}(${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }

        // æœç´¢åŠŸèƒ½
        function searchUsers() {
            loadUsers(1);
        }

        function searchMindmaps() {
            loadMindmaps(1);
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const res = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    alert('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
                    loadUsers(currentUserPage);
                } else {
                    const data = await res.json();
                    alert('åˆ é™¤å¤±è´¥: ' + data.msg);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤è„‘å›¾
        async function deleteMindmap(mindmapId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªè„‘å›¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const res = await fetch(`/api/admin/mindmaps/${mindmapId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œè·å–åŸå§‹æ–‡æœ¬
                    const text = await res.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 100)}`);
                }

                const data = await res.json();

                if (res.ok) {
                    alert('è„‘å›¾åˆ é™¤æˆåŠŸ');
                    loadMindmaps(currentMindmapPage);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.msg);
                }
            } catch (error) {
                console.error('Delete mindmap error:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            await fetch('/api/admin/logout', {method: 'POST', credentials: 'include'});
            location.href = '/admin/login.html';
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>笔记系统（含分类/标签）</title>
    <!-- 第三方样式 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/base16-light.min.css" rel="stylesheet">
    <style>
        /* ---------- 基础布局（原有） ---------- */
        body{margin:0;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;background:#f5f5f5;}
        #app{display:flex;height:100vh;overflow:hidden;}
        #sidebar{width:280px;background:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;}
        #notes-list{flex:1;overflow-y:auto;padding:0;margin:0;list-style:none;}
        .note-item{padding:12px 16px;border-bottom:1px solid #eee;cursor:pointer;display:flex;flex-direction:column;}
        .note-item.active{background:#e8f0fe;}
        .note-title{font-size:14px;color:#333;display:flex;align-items:center;}
        .note-title i{margin-right:6px;}
        .note-meta{font-size:12px;color:#999;margin-top:4px;}
        #create-note-btn{margin:12px;background:#1976d2;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;}
        #create-note-btn:hover{background:#1565c0;}

        /* ---------- 编辑区（原有） ---------- */
        #editor{flex:1;display:flex;flex-direction:column;background:#fff;}
        .editor-toolbar{display:flex;justify-content:space-between;background:#fafafa;border-bottom:1px solid #e0e0e0;padding:8px 12px;}
        .editor-type button,.editor-actions button{background:none;border:none;padding:6px 10px;margin-right:6px;cursor:pointer;border-radius:4px;}
        .editor-type button.active,.editor-actions button.active{background:#1976d2;color:#fff;}
        .editor-type button:hover,.editor-actions button:hover{background:#e0e0e0;}
        #richtext-container,#markdown-container{flex:1;display:none;overflow:auto;padding:12px;}
        #richtext-container{height:100%;}
        #markdown-container{display:flex;flex-direction:column;}
        #markdown-toolbar{display:flex;border-bottom:1px solid #e0e0e0;padding:4px;background:#fafafa;}
        #markdown-toolbar button{background:none;border:none;padding:4px 6px;margin-right:4px;cursor:pointer;}
        #markdown-editor{flex:1;height:0;}
        #markdown-preview{flex:1;overflow:auto;padding:12px;background:#fafafa;border-left:1px solid #e0e0e0;}
        .editor-section{display:flex;height:100%;}
        #empty-state{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#777;}
        #empty-state button{margin-top:12px;background:#1976d2;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;}
        #empty-state button:hover{background:#1565c0;}

        /* ---------- Markdown 编辑器布局（原有） ---------- */
        #markdown-container {display: flex;flex-direction: column;width: 100%;height: 100%;}
        #markdown-editor-wrapper {display: flex;flex: 1;height: 0;}
        #markdown-editor-wrapper > div {flex: 1;height: 100%;}

        /* ---------- 弹窗（原有） ---------- */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;justify-content:center;align-items:center;z-index:1000;}
        .modal-content{background:#fff;padding:20px;border-radius:6px;width:320px;position:relative;}
        .modal-content h3{margin-top:0;}
        .modal-content input[type="text"]{width:100%;padding:6px;margin-top:8px;border:1px solid #ccc;border-radius:4px;}
        .modal-content button{margin-top:12px;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;}
        .modal-content .close{position:absolute;top:8px;right:12px;font-size:18px;cursor:pointer;}
        .modal-content button.confirm{background:#1976d2;color:#fff;}
        .modal-content button.confirm:hover{background:#1565c0;}
        .modal-content button.cancel{background:#e0e0e0;margin-left:8px;}
        .modal-content button.cancel:hover{background:#c0c0c0;}

        /* ---------- Toast（原有） ---------- */
        #toast{visibility:hidden;min-width:200px;background:#333;color:#fff;text-align:center;border-radius:4px;padding:12px;position:fixed;z-index:2000;left:50%;bottom:30px;transform:translateX(-50%);font-size:14px;}
        #toast.show{visibility:visible;animation:fadein 0.5s,fadeout 0.5s 2.5s;}
        @keyframes fadein{from{bottom:0;opacity:0;}to{bottom:30px;opacity:1;}}
        @keyframes fadeout{from{bottom:30px;opacity:1;}to{bottom:0;opacity:0;}}

        /* ---------- 搜索框（原有） ---------- */
        .search-box {padding: 0 12px; margin: 0 12px 12px;}
        .search-box input {width: 100%;padding: 6px 8px;border: 1px solid #e0e0e0;border-radius: 4px;font-size: 14px;box-sizing: border-box;}
        .search-box input:focus {outline: none;border-color: #1976d2;}

        /* ================================== 新增：分类/标签样式 ================================== */
        /* 分类筛选栏 */
        #category-filter {padding: 0 12px 12px;border-bottom: 1px solid #e0e0e0;}
        .filter-title {font-size: 13px; color: #666; margin: 8px 0 6px; display: flex; justify-content: space-between; align-items: center;}
        .category-item {display: inline-block;padding: 4px 8px;margin: 0 4px 4px 0;background: #f0f0f0;border-radius: 4px;font-size: 12px;cursor: pointer;}
        .category-item.active {background: #1976d2; color: white;}
        .add-filter-btn {font-size: 12px; color: #1976d2; cursor: pointer; background: none; border: none; padding: 0;}

        /* 标签云 */
        #tag-cloud {padding: 0 12px 12px;border-bottom: 1px solid #e0e0e0;}
        .tag-item {display: inline-block;padding: 3px 8px;margin: 0 6px 6px 0;background: #f5f5f5;border-radius: 12px;font-size: 12px;cursor: pointer;}
        .tag-item.active {background: #4caf50; color: white;}

        /* 新建笔记弹窗：分类选择 */
        .modal-category-select {width: 100%;padding: 6px;margin: 8px 0 12px;border: 1px solid #ccc;border-radius: 4px;box-sizing: border-box;}

        /* 新建笔记弹窗：标签选择 */
        .tag-input-group {margin: 8px 0 12px;}
        .tag-input-wrapper {display: flex; gap: 5px; margin-bottom: 6px;}
        .tag-input {flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px;}
        .add-tag-btn {padding: 6px 10px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;}
        .selected-tags {display: flex; flex-wrap: wrap; gap: 5px;}
        .selected-tag {background: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center;}
        .remove-tag {margin-left: 5px; cursor: pointer; font-weight: bold; color: #e74c3c;}

        /* 分类/标签管理弹窗 */
        .manage-list {max-height: 200px; overflow-y: auto; margin: 10px 0;}
        .manage-item {display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #eee;}
        .delete-item-btn {border: none; background: none; color: #e74c3c; cursor: pointer;}
    </style>
</head>
<body>
<div id="app">
    <!-- 侧边栏（新增分类/标签筛选） -->
    <div id="sidebar">
        <!-- 新增：用户信息 -->
    <div id="user-info" style="padding: 12px; border-bottom: 1px solid #e0e0e0; background: #f8f9fa;">
        <div style="font-size: 14px; font-weight: bold; color: #333;">{{ current_user.username }}</div>
        <a href="/logout" style="font-size: 12px; color: #1976d2; text-decoration: none;">退出登录</a>
    </div>

    <button id="create-note-btn"><i class="fa fa-plus"></i> 新建笔记</button>

        <!-- 新增：分类筛选栏 -->
        <div id="category-filter">
            <div class="filter-title">
                <span>分类</span>
                <button class="add-filter-btn" id="add-category-btn"><i class="fa fa-plus"></i> 新增</button>
            </div>
            <div class="category-item active" data-id="all">全部</div>
            <div class="category-item" data-id="none">未分类</div>
            <div id="category-list"></div> <!-- 动态渲染分类 -->
        </div>

        <!-- 新增：标签云 -->
        <div id="tag-cloud">
            <div class="filter-title">
                <span>标签</span>
                <button class="add-filter-btn" id="add-tag-btn"><i class="fa fa-plus"></i> 新增</button>
            </div>
            <div class="tag-item active" data-id="all">全部</div>
            <div id="tag-list"></div> <!-- 动态渲染标签 -->
        </div>

        <!-- 搜索框（原有） -->
        <div class="search-box">
            <input type="text" id="search-input" placeholder="搜索笔记标题…">
        </div>

        <!-- 笔记列表（原有） -->
        <div id="notes-list"></div>
    </div>

    <!-- 编辑区（原有） -->
    <div id="editor">
        <div class="editor-toolbar">
            <div class="editor-type">
                <button class="type-btn" id="richtext-btn" data-type="richtext"><i class="fa fa-file-text-o"></i> 富文本</button>
                <button class="type-btn" id="markdown-btn" data-type="markdown"><i class="fa fa-markdown"></i> Markdown</button>
            </div>
            <div class="editor-actions">
                <button class="action-btn" id="save-btn"><i class="fa fa-save"></i> 保存</button>
                <button class="action-btn" id="version-history-btn">
    <i class="fa fa-history"></i> 版本历史
</button>
                <button class="action-btn" id="delete-btn"><i class="fa fa-trash-o"></i> 删除</button>
                <button class="action-btn" id="share-btn"><i class="fa fa-share-alt"></i> 分享</button>
                <button class="action-btn" id="export-btn"><i class="fa fa-download"></i> 导出</button>
                <!-- 添加管理员按钮（仅管理员可见） -->
                <button class="action-btn" id="admin-btn" style="display: none;">
                    <i class="fa fa-cogs"></i> 管理
                </button>
                    <!-- 新增AI功能按钮 -->
                <div class="ai-actions" style="display: inline-flex; border-left: 1px solid #ddd; margin-left: 8px; padding-left: 8px;">
                    <button class="action-btn" id="ai-generate-btn"><i class="fa fa-magic"></i> AI生成</button>
                    <button class="action-btn" id="ai-summarize-btn"><i class="fa fa-compress"></i> 总结</button>
                    <button class="action-btn" id="ai-tags-btn"><i class="fa fa-tags"></i> 推荐标签</button>
                </div>

            </div>
        </div>

        <div id="empty-state">
            <p>暂无笔记，点击左侧「新建笔记」开始记录吧！</p>
            <button id="empty-create-btn"><i class="fa fa-plus"></i> 新建笔记</button>
        </div>

        <div id="richtext-container"></div>
        <div id="markdown-container" style="display: none;">
            <div id="markdown-toolbar">
                <button class="md-btn" data-cmd="bold"><i class="fa fa-bold"></i></button>
                <button class="md-btn" data-cmd="italic"><i class="fa fa-italic"></i></button>
                <button class="md-btn" data-cmd="h1">H1</button>
                <button class="md-btn" data-cmd="h2">H2</button>
                <button class="md-btn" data-cmd="ul"><i class="fa fa-list-ul"></i></button>
                <button class="md-btn" data-cmd="code"><i class="fa fa-code"></i></button>
                <button class="md-btn" data-cmd="link"><i class="fa fa-link"></i></button>
            </div>
            <div id="markdown-editor-wrapper">
                <div>
                    <textarea id="markdown-editor" style="display: none;"></textarea>
                </div>
                <div id="markdown-preview"></div>
            </div>
        </div>
    </div>
</div>

<!-- 1. 新建笔记弹窗（修改：新增分类选择和标签输入） -->
<div id="create-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="modal-close">&times;</span>
        <h3>新建笔记</h3>
        <input type="text" id="note-title" placeholder="笔记标题（可留空）">

        <!-- 新增：分类选择 -->
        <select id="note-category-select" class="modal-category-select">
            <option value="">未分类</option>
        </select>

        <!-- 新增：标签输入 -->
        <div class="tag-input-group">
            <div class="tag-input-wrapper">
                <input type="text" id="new-tag-input" class="tag-input" placeholder="输入标签，按回车或点击添加">
                <button id="confirm-add-tag" class="add-tag-btn">添加</button>
            </div>
            <div class="selected-tags" id="selected-tags-container"></div>
        </div>

        <div style="margin-top:12px;">
            <label><input type="radio" name="note-type" value="richtext" checked> 富文本</label>
            <label style="margin-left:12px;"><input type="radio" name="note-type" value="markdown"> Markdown</label>
        </div>
        <button class="confirm" id="confirm-create-btn">创建</button>
        <button class="cancel" id="cancel-btn">取消</button>


    </div>
</div>

<!-- 1. 在create-modal后面新增独立的AI生成弹窗 -->
<div id="ai-generate-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="ai-generate-close">&times;</span>
        <h3>AI生成笔记</h3>
        <input type="text" id="ai-topic-input" placeholder="请输入笔记主题...">
        <button class="confirm" id="ai-generate-confirm">生成内容</button>
        <button class="cancel" id="ai-generate-cancel">取消</button>
    </div>
</div>

<!-- 2. 分类管理弹窗（新增） -->
<div id="category-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="category-modal-close">&times;</span>
        <h3>管理分类</h3>
        <input type="text" id="new-category-name" placeholder="输入新分类名称">
        <button class="confirm" id="confirm-add-category">添加分类</button>
        <div class="manage-list" id="category-manage-list"></div>
    </div>
</div>

<!-- 3. 标签管理弹窗（新增） -->
<div id="tag-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="tag-modal-close">&times;</span>
        <h3>管理标签</h3>
        <input type="text" id="new-tag-name" placeholder="输入新标签名称">
        <button class="confirm" id="confirm-add-tag-modal">添加标签</button>
        <div class="manage-list" id="tag-manage-list"></div>
    </div>
</div>

<!-- 分享弹窗 -->
<div id="share-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="share-close">&times;</span>
        <h3>生成分享链接</h3>

        <div style="margin-bottom: 12px;">
            <label for="share-permission">权限：</label>
            <select id="share-permission" style="width:100%;margin-top:4px;">
                <option value="view">只读（view）</option>
                <option value="edit">可编辑（edit）</option>
            </select>
        </div>

        <div style="margin-bottom: 12px;">
            <label for="share-expires">有效期：</label>
            <select id="share-expires" style="width:100%;margin-top:4px;">
                <option value="1min">1分钟</option>
                <option value="1hour">1小时</option>
                <option value="1day">1天</option>
                <option value="3days">3天</option>
                <option value="7days" selected>7天</option>
                <option value="30days">30天</option>
                <option value="never">永久有效</option>
                <option value="custom">自定义时间</option>
            </select>
        </div>

        <!-- 自定义时间输入（默认隐藏） -->
        <div id="custom-expires-group" style="display: none; margin-bottom: 12px;">
            <label for="share-custom-expires">自定义过期时间：</label>
            <input type="datetime-local" id="share-custom-expires" style="width:100%;padding:6px;margin-top:4px;">
        </div>

        <input type="text" id="share-link" readonly placeholder="生成的链接会显示在这里">
        <div style="margin-top:12px;">
            <button class="confirm" id="generate-link-btn">生成链接</button>
            <button class="cancel" id="copy-link-btn">复制链接</button>
        </div>
    </div>
</div>

<div id="export-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="export-close">&times;</span>
        <h3>选择导出格式</h3>
        <div style="margin-top: 16px; display: flex; gap: 10px;">
            <button class="confirm" id="export-md-btn" style="flex: 1;">
                <i class="fa fa-file-text-o"></i> 导出为 Markdown
            </button>
            <button class="confirm" id="export-pdf-btn" style="flex: 1; background: #e74c3c;">
                <i class="fa fa-file-pdf-o"></i> 导出为 PDF
            </button>
        </div>
    </div>
</div>

<div id="toast"></div>

<!-- 第三方脚本（原有） -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
/* ==================== 原有变量（保留） ==================== */
let currentNoteId = null;
let currentNoteType = null;          // 'richtext' | 'markdown'
let currentNoteData = null;          // 当前笔记完整对象
let quillEditor = null;
let markdownEditor = null;
let allNotes = [];                   // 所有笔记列表（含分类/标签ID）

// 共享模式变量（原有）
const shareToken = "{{ share_token|default('') }}";
const sharePermission = "{{ share_permission|default('') }}";
const sharedNoteId = {{ note_id if note_id is defined else 'null' }};

// 原有DOM元素（保留）
const notesListEl      = document.getElementById('notes-list');
const createNoteBtn    = document.getElementById('create-note-btn');
const emptyCreateBtn   = document.getElementById('empty-create-btn');
const createModal      = document.getElementById('create-modal');
const modalClose       = document.getElementById('modal-close');
const cancelBtn        = document.getElementById('cancel-btn');
const confirmCreateBtn = document.getElementById('confirm-create-btn');
const noteTitleInput   = document.getElementById('note-title');
const richtextContainer = document.getElementById('richtext-container');
const markdownContainer = document.getElementById('markdown-container');
const emptyState        = document.getElementById('empty-state');
const richtextBtn   = document.getElementById('richtext-btn');
const markdownBtn   = document.getElementById('markdown-btn');
const saveBtn       = document.getElementById('save-btn');
const deleteBtn     = document.getElementById('delete-btn');
const shareBtn      = document.getElementById('share-btn');
const exportBtn     = document.getElementById('export-btn');
const toast         = document.getElementById('toast');
const searchInput   = document.getElementById('search-input');
const shareModal          = document.getElementById('share-modal');
const shareClose          = document.getElementById('share-close');
const shareLinkInput      = document.getElementById('share-link');
const copyLinkBtn         = document.getElementById('copy-link-btn');
const generateLinkBtn     = document.getElementById('generate-link-btn');
const sharePermissionSelect = document.getElementById('share-permission');
const exportModal = document.getElementById('export-modal');
const exportClose = document.getElementById('export-close');
const exportMdBtn = document.getElementById('export-md-btn');
const exportPdfBtn = document.getElementById('export-pdf-btn');

/* ==================== 新增：分类/标签变量 ==================== */
let allCategories = [];  // 所有分类列表
let allTags = [];        // 所有标签列表
let currentCategoryFilter = 'all';  // 当前分类筛选状态（all/none/分类ID）
let currentTagFilter = 'all';        // 当前标签筛选状态（all/标签ID）
let selectedTagIds = []; // 新建/编辑笔记时选中的标签ID

// 新增DOM元素（分类/标签相关）
const categoryFilterEl = document.getElementById('category-filter');
const categoryListEl = document.getElementById('category-list');
const addCategoryBtn = document.getElementById('add-category-btn');
const categoryModal = document.getElementById('category-modal');
const categoryModalClose = document.getElementById('category-modal-close');
const newCategoryNameInput = document.getElementById('new-category-name');
const confirmAddCategoryBtn = document.getElementById('confirm-add-category');
const categoryManageList = document.getElementById('category-manage-list');

const tagCloudEl = document.getElementById('tag-cloud');
const tagListEl = document.getElementById('tag-list');
const addTagBtn = document.getElementById('add-tag-btn');
const tagModal = document.getElementById('tag-modal');
const tagModalClose = document.getElementById('tag-modal-close');
const newTagNameInput = document.getElementById('new-tag-name');
const confirmAddTagModalBtn = document.getElementById('confirm-add-tag-modal');
const tagManageList = document.getElementById('tag-manage-list');

const noteCategorySelect = document.getElementById('note-category-select');
const newTagInput = document.getElementById('new-tag-input');
const confirmAddTagBtn = document.getElementById('confirm-add-tag');
const selectedTagsContainer = document.getElementById('selected-tags-container');

// AI生成笔记相关
const aiGenerateModal = document.getElementById('ai-generate-modal');
const aiGenerateClose = document.getElementById('ai-generate-close');
const aiGenerateConfirm = document.getElementById('ai-generate-confirm');
const aiTopicInput = document.getElementById('ai-topic-input');
// 修复：添加缺失的 AI 取消按钮变量
const aiGenerateCancel = document.getElementById('ai-generate-cancel');

if (aiGenerateCancel) {
    aiGenerateCancel.addEventListener('click', () => {
        aiGenerateModal.style.display = 'none';
    });
}



// 在变量定义部分添加
const shareExpirySelect = document.getElementById('share-expires');

// 版本历史按钮事件
document.getElementById('version-history-btn').addEventListener('click', () => {
    if (!currentNoteId) {
        showToast('请先选择笔记');
        return;
    }
    window.open(`/notes/${currentNoteId}/versions`, '_blank');
});
// 打开AI生成弹窗
document.getElementById('ai-generate-btn').addEventListener('click', () => {
    aiGenerateModal.style.display = 'flex';
    aiTopicInput.focus();
});

// 关闭弹窗
aiGenerateClose.addEventListener('click', () => {
    aiGenerateModal.style.display = 'none';
});

// 生成笔记内容
aiGenerateConfirm.addEventListener('click', async () => {
    const topic = aiTopicInput.value.trim();
    if (!topic) {
        showToast('请输入笔记主题');
        return;
    }

    try {
        showToast('AI正在生成内容...');
        const res = await fetch('/api/ai/generate_note', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({topic})
        });

        if (!res.ok) throw new Error('生成失败');
        const data = await res.json();

        // 根据当前编辑器类型填充内容
        if (currentNoteType === 'richtext') {
            quillEditor.root.innerHTML = data.content;
        } else {
            markdownEditor.setValue(data.content);
            updateMarkdownPreview();
        }

        // 如果是新笔记，自动填充标题
        if (!currentNoteId) {
            document.getElementById('note-title').value = data.suggested_title;
        }

        aiGenerateModal.style.display = 'none';
        showToast('AI生成成功');
    } catch (e) {
        console.error(e);
        showToast('生成失败，请重试');
    }
});

// AI总结功能
document.getElementById('ai-summarize-btn').addEventListener('click', async () => {
    if (!currentNoteId) {
        showToast('请先选择或创建笔记');
        return;
    }

    // 获取当前编辑器内容
    const content = currentNoteType === 'richtext'
        ? quillEditor.root.innerText
        : markdownEditor.getValue();

    if (!content.trim()) {
        showToast('笔记内容为空，无法总结');
        return;
    }

    try {
        showToast('AI正在总结...');
        const res = await fetch('/api/ai/summarize', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content})
        });

        if (!res.ok) throw new Error('总结失败');
        const data = await res.json();

        // 在编辑器顶部插入总结
        const summary = `【AI总结】\n${data.summary}\n\n---\n\n`;
        if (currentNoteType === 'richtext') {
            quillEditor.insertText(0, summary);
        } else {
            markdownEditor.setValue(summary + content);
            updateMarkdownPreview();
        }

        showToast('总结完成');
    } catch (e) {
        console.error(e);
        showToast('总结失败，请重试');
    }
});

// AI推荐标签功能 - 修复版
document.getElementById('ai-tags-btn').addEventListener('click', async () => {
    if (!currentNoteId) {
        showToast('请先选择或创建笔记');
        return;
    }

    const content = currentNoteType === 'richtext'
        ? quillEditor.root.innerText
        : markdownEditor.getValue();

    if (!content.trim()) {
        showToast('笔记内容为空，无法推荐标签');
        return;
    }

    try {
        showToast('AI正在推荐标签...');
        const res = await fetch('/api/ai/suggest_tags', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content})
        });

        if (!res.ok) throw new Error('推荐标签失败');
        const data = await res.json();

        let addedCount = 0;

        // 自动添加标签（如果标签不存在则创建）
        if (data.tags && data.tags.length) {
            for (const tagName of data.tags) {
                // 检查标签是否已存在
                const existingTag = allTags.find(t => t.name.toLowerCase() === tagName.toLowerCase());
                if (existingTag) {
                    // 检查是否已选中
                    if (!selectedTagIds.includes(existingTag.id)) {
                        selectedTagIds.push(existingTag.id);
                        addedCount++;
                    }
                } else {
                    // 创建新标签并添加到选中列表
                    try {
                        const createRes = await fetch('/api/tags', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ name: tagName })
                        });

                        if (createRes.ok) {
                            const newTag = await createRes.json();
                            allTags.push(newTag);
                            selectedTagIds.push(newTag.id);
                            addedCount++;

                            // 更新标签云
                            renderTagCloud();
                        }
                    } catch (createErr) {
                        console.error(`创建标签失败: ${tagName}`, createErr);
                    }
                }
            }

            // 更新标签显示
            renderSelectedTags();

            if (addedCount > 0) {
                showToast(`已成功添加 ${addedCount} 个标签`);
                // 自动保存标签到当前笔记
                await saveCurrentNote();
            } else {
                showToast('所有推荐的标签都已存在');
            }
        } else {
            showToast('未找到合适的标签');
        }
    } catch (e) {
        console.error(e);
        showToast('推荐标签失败，请重试');
    }
});



/* ==================== 初始化（修改：新增分类/标签加载） ==================== */
function init() {
    initEditors();
    bindEvents();
    loadNotes();
    loadCategories();
    loadTags();
    checkAdminStatus(); // 新增：检查管理员状态

    // 新增：检查是否是共享模式，并设置相应权限
    if (shareToken) {
        handleSharedMode();
    }
}

// 添加管理员按钮事件
document.getElementById('admin-btn').addEventListener('click', function() {
    window.open('/admin', '_blank');
});

// 新增：处理共享模式的函数
function handleSharedMode() {
    // 隐藏不需要的元素
    document.getElementById('sidebar').style.display = 'none';
    document.getElementById('create-note-btn').style.display = 'none';

    // 根据权限设置编辑器状态
    if (sharePermission === 'view') {
        // 只读模式
        disableEditors();
        showToast('您正在以只读模式查看此笔记');
    } else if (sharePermission === 'edit') {
        // 可编辑模式
        enableEditors();
        showToast('您正在以可编辑模式查看此笔记');
    }

    // 加载共享的笔记
    if (sharedNoteId) {
        openNote(sharedNoteId, null);
    }
}

// 新增：禁用编辑器（只读模式）
function disableEditors() {
    // 禁用富文本编辑器
    if (quillEditor) {
        quillEditor.disable();
    }

    // 禁用 Markdown 编辑器
    if (markdownEditor) {
        markdownEditor.setOption('readOnly', true);
    }

    // 隐藏保存按钮
    saveBtn.style.display = 'none';

    // 隐藏分类和标签选择（在共享模式下）
    document.querySelector('.tag-input-group').style.display = 'none';
    document.querySelector('.modal-category-select').style.display = 'none';
}

// 新增：启用编辑器（可编辑模式）
function enableEditors() {
    // 启用富文本编辑器
    if (quillEditor) {
        quillEditor.enable();
    }

    // 启用 Markdown 编辑器
    if (markdownEditor) {
        markdownEditor.setOption('readOnly', false);
    }

    // 显示保存按钮
    saveBtn.style.display = 'block';
}

/* ==================== 原有编辑器初始化（保留） ==================== */
function initEditors() {
    // 富文本编辑器
    quillEditor = new Quill('#richtext-container', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'header': [1,2,3,4,5,6,false] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ],
                handlers: {
                    image: function() {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        input.onchange = async () => {
                            const file = input.files[0];
                            if (!file) return;
                            const fd = new FormData();
                            fd.append('file', file);
                            try {
                                const resp = await fetch('/api/upload', {
                                    method: 'POST',
                                    body: fd
                                });
                                if (!resp.ok) throw new Error('上传失败');
                                const data = await resp.json();
                                const range = quillEditor.getSelection(true);
                                quillEditor.insertEmbed(range.index, 'image', data.url);
                            } catch (e) {
                                console.error(e);
                                showToast('图片上传失败');
                            }
                        };
                    }
                }
            }
        },
        placeholder: '请输入富文本内容...'
    });

    // Markdown 编辑器
    markdownEditor = CodeMirror.fromTextArea(
        document.getElementById('markdown-editor'), {
            mode: 'markdown',
            lineNumbers: true,
            lineWrapping: true,
            theme: 'base16-light',
            indentUnit: 4,
            tabSize: 4
        });
    markdownEditor.setSize('100%', '100%');
    markdownEditor.on('change', updateMarkdownPreview);

    // Markdown 工具栏按钮（原有）
    document.querySelectorAll('.md-btn').forEach(btn => {
        btn.addEventListener('click', () => handleMarkdownCmd(btn.dataset.cmd));
    });
}

/* ==================== 事件绑定（修改：新增分类/标签事件） ==================== */
function bindEvents() {
    // 原有事件（保留）
    createNoteBtn.addEventListener('click', openCreateModal);
    emptyCreateBtn.addEventListener('click', openCreateModal);
    modalClose.addEventListener('click', closeCreateModal);
    cancelBtn.addEventListener('click', closeCreateModal);
    confirmCreateBtn.addEventListener('click', confirmCreateNote);
    richtextBtn.addEventListener('click', () => switchEditor('richtext'));
    markdownBtn.addEventListener('click', () => switchEditor('markdown'));
    saveBtn.addEventListener('click', saveCurrentNote);
    deleteBtn.addEventListener('click', deleteCurrentNote);
    shareBtn.addEventListener('click', openShareModal);
    shareClose.addEventListener('click', () => shareModal.style.display = 'none');
    generateLinkBtn.addEventListener('click', generateShareLink);
    copyLinkBtn.addEventListener('click', copyShareLink);
    exportBtn.addEventListener('click', openExportModal);
    exportClose.addEventListener('click', () => exportModal.style.display = 'none');
    exportMdBtn.addEventListener('click', () => exportNote('md'));
    exportPdfBtn.addEventListener('click', () => exportNote('pdf'));
    searchInput.addEventListener('input', filterNotes);

    // 新增：分类相关事件
    addCategoryBtn.addEventListener('click', () => categoryModal.style.display = 'flex');
    categoryModalClose.addEventListener('click', () => categoryModal.style.display = 'none');
    confirmAddCategoryBtn.addEventListener('click', createCategory);
    // 分类筛选点击
    document.querySelector('.category-item[data-id="all"]').addEventListener('click', () => filterByCategory('all'));
    document.querySelector('.category-item[data-id="none"]').addEventListener('click', () => filterByCategory('none'));

    // 新增：分类相关事件（避免重复，保留一个）
    addCategoryBtn.addEventListener('click', () => categoryModal.style.display = 'flex');
    categoryModalClose.addEventListener('click', () => categoryModal.style.display = 'none');
    confirmAddCategoryBtn.addEventListener('click', createCategory);
    document.querySelector('.category-item[data-id="all"]').addEventListener('click', () => filterByCategory('all'));
    document.querySelector('.category-item[data-id="none"]').addEventListener('click', () => filterByCategory('none'));

   // 新增：分享弹窗有效期选择事件
    const expiresSelect = document.getElementById('share-expires');
    const customExpiresGroup = document.getElementById('custom-expires-group');

    if (expiresSelect && customExpiresGroup) {
        expiresSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customExpiresGroup.style.display = 'block';
                // 设置默认自定义时间为明天同一时间
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                // 使用本地时间格式
                const year = tomorrow.getFullYear();
                const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const day = String(tomorrow.getDate()).padStart(2, '0');
                const hours = String(tomorrow.getHours()).padStart(2, '0');
                const minutes = String(tomorrow.getMinutes()).padStart(2, '0');

                document.getElementById('share-custom-expires').value =
                    `${year}-${month}-${day}T${hours}:${minutes}`;
            } else {
                customExpiresGroup.style.display = 'none';
            }
        });
    }

    // 新增：标签相关事件
    addTagBtn.addEventListener('click', () => tagModal.style.display = 'flex');
    tagModalClose.addEventListener('click', () => tagModal.style.display = 'none');
    confirmAddTagModalBtn.addEventListener('click', createTag);
    // 标签筛选点击
    document.querySelector('.tag-item[data-id="all"]').addEventListener('click', () => filterByTag('all'));
    // 新建笔记时添加标签
    confirmAddTagBtn.addEventListener('click', addTagToSelection);
    newTagInput.addEventListener('keypress', (e) => e.key === 'Enter' && addTagToSelection());
}

// 检查是否是管理员并显示管理按钮
async function checkAdminStatus() {
    try {
        const response = await fetch('/api/admin/stats');
        if (response.ok) {
            document.getElementById('admin-btn').style.display = 'block';
        }
    } catch (error) {
        // 不是管理员，隐藏按钮
        document.getElementById('admin-btn').style.display = 'none';
    }
}

/* ==================== 新增：分类/标签核心功能 ==================== */
// 1. 加载分类
async function loadCategories() {
    try {
        const res = await fetch('/api/categories');
        if (!res.ok) throw new Error('加载分类请求失败');
        allCategories = await res.json();
        renderCategoryFilter();
        populateCategorySelect();
        renderCategoryManageList();
    } catch (e) { // 必须有catch
        console.error('加载分类失败：', e);
        showToast('加载分类失败');
    }
}

// 2. 加载标签
async function loadTags() {
    try {
        const res = await fetch('/api/tags');
        if (!res.ok) throw new Error('加载标签失败');
        allTags = await res.json();
        renderTagCloud();        // 渲染标签云
        renderTagManageList();   // 渲染标签管理列表
    } catch (e) {
        console.error(e);
        showToast('加载标签失败');
    }
}

// 3. 渲染分类筛选栏
function renderCategoryFilter() {
    categoryListEl.innerHTML = '';
    allCategories.forEach(category => {
        const el = document.createElement('div');
        el.className = `category-item ${currentCategoryFilter == category.id ? 'active' : ''}`;
        el.dataset.id = category.id;
        el.textContent = category.name;
        el.addEventListener('click', () => filterByCategory(category.id));
        categoryListEl.appendChild(el);
    });
}

// 4. 渲染标签云
function renderTagCloud() {
    tagListEl.innerHTML = '';
    allTags.forEach(tag => {
        const el = document.createElement('div');
        el.className = `tag-item ${currentTagFilter == tag.id ? 'active' : ''}`;
        el.dataset.id = tag.id;
        el.textContent = tag.name;
        el.addEventListener('click', () => filterByTag(tag.id));
        tagListEl.appendChild(el);
    });
}

// 5. 填充新建笔记的分类下拉框
function populateCategorySelect() {
    const currentValue = noteCategorySelect.value;
    // 清空现有选项（保留"未分类"）
    while (noteCategorySelect.options.length > 1) {
        noteCategorySelect.remove(1);
    }
    // 添加分类选项
    allCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        noteCategorySelect.appendChild(option);
    });
    // 恢复之前的选中值
    if (currentValue) noteCategorySelect.value = currentValue;
}

// 6. 创建分类
async function createCategory() {
    const name = newCategoryNameInput.value.trim();
    if (!name) {
        showToast('请输入分类名称');
        return;
    }
    try {
        const res = await fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || '创建分类失败');
        }
        newCategoryNameInput.value = '';
        await loadCategories();
        showToast('分类创建成功');
    } catch (e) {
        console.error(e);
        showToast(e.message);
    }
}

// 7. 创建标签
async function createTag() {
    const name = newTagNameInput.value.trim();
    if (!name) {
        showToast('请输入标签名称');
        return;
    }
    try {
        const res = await fetch('/api/tags', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || '创建标签失败');
        }
        newTagNameInput.value = '';
        await loadTags();
        showToast('标签创建成功');
    } catch (e) {
        console.error(e);
        showToast(e.message);
    }
}

// 渲染分类管理列表（完整无错版）
function renderCategoryManageList() {
    categoryManageList.innerHTML = '';
    allCategories.forEach(category => {
        const el = document.createElement('div');
        el.className = 'manage-item';
        el.innerHTML = `
            <span>${category.name}</span>
            <button class="delete-item-btn" data-id="${category.id}">
                <i class="fa fa-trash-o"></i> 删除
            </button>
        `;
        categoryManageList.appendChild(el);
        // 绑定删除事件（确保try-catch完整）
        el.querySelector('.delete-item-btn').addEventListener('click', async (e) => {
            const categoryId = e.target.dataset.id;
            if (!confirm('确定删除该分类吗？分类下的笔记会变为"未分类"')) return;

            try {
                const res = await fetch(`/api/categories/${categoryId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('删除分类请求失败');
                await loadCategories();
                showToast('分类已删除');
            } catch (e) { // 关键：补充catch
                console.error('删除分类失败：', e);
                showToast('删除分类失败');
            }
        });
    });
}

// 渲染标签管理列表（完整无错版）
function renderTagManageList() {
    tagManageList.innerHTML = '';
    allTags.forEach(tag => {
        const el = document.createElement('div');
        el.className = 'manage-item';
        el.innerHTML = `
            <span>${tag.name}</span>
            <button class="delete-item-btn" data-id="${tag.id}">
                <i class="fa fa-trash-o"></i> 删除
            </button>
        `;
        tagManageList.appendChild(el);
        // 绑定删除事件（确保try-catch完整）
        el.querySelector('.delete-item-btn').addEventListener('click', async (e) => {
            const tagId = e.target.dataset.id;
            if (!confirm('确定删除该标签吗？')) return;

            try {
                const res = await fetch(`/api/tags/${tagId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('删除标签请求失败');
                await loadTags();
                showToast('标签已删除');
            } catch (e) { // 关键：补充catch
                console.error('删除标签失败：', e);
                showToast('删除标签失败');
            }
        });
    });
}

// 10. 新建笔记时添加标签到选中列表
function addTagToSelection() {
    const tagName = newTagInput.value.trim();
    if (!tagName) return;

    // 检查标签是否已存在
    let tag = allTags.find(t => t.name.toLowerCase() === tagName.toLowerCase());
    if (tag) {
        // 检查是否已选中
        if (selectedTagIds.includes(tag.id)) {
            showToast('该标签已选中');
            newTagInput.value = '';
            return;
        }
        // 添加到选中列表
        selectedTagIds.push(tag.id);
        renderSelectedTags();
        newTagInput.value = '';
        return;
    }

    // 标签不存在：提示先创建
    if (confirm(`标签"${tagName}"不存在，是否创建并添加？`)) {
        createTagAndAdd(tagName);
    }
}

// 11. 创建标签并添加到选中列表
async function createTagAndAdd(tagName) {
    try {
        const res = await fetch('/api/tags', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: tagName })
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error);
        }
        const newTag = await res.json();
        allTags.push(newTag);
        selectedTagIds.push(newTag.id);
        renderTagCloud();
        renderSelectedTags();
        newTagInput.value = '';
        showToast('标签创建并添加成功');
    } catch (e) {
        console.error(e);
        showToast(e.message);
    }
}

// 12. 渲染选中的标签（新建/编辑笔记时）
function renderSelectedTags() {
    selectedTagsContainer.innerHTML = '';
    console.log('渲染选中的标签，数量:', selectedTagIds.length); // 调试

    selectedTagIds.forEach(tagId => {
        const tag = allTags.find(t => t.id === tagId);
        if (tag) {
            const el = document.createElement('div');
            el.className = 'selected-tag';
            el.innerHTML = `
                ${tag.name}
                <span class="remove-tag" data-id="${tag.id}">&times;</span>
            `;
            selectedTagsContainer.appendChild(el);

            // 绑定删除事件
            el.querySelector('.remove-tag').addEventListener('click', (e) => {
                const id = parseInt(e.target.dataset.id);
                selectedTagIds = selectedTagIds.filter(tid => tid !== id);
                renderSelectedTags();
            });
        }
    });

    // 如果没有选中的标签，显示提示
    if (selectedTagIds.length === 0) {
        selectedTagsContainer.innerHTML = '<div style="color:#999;font-size:12px;">暂无标签</div>';
    }
}

/* ==================== 原有笔记功能（修改：支持分类/标签） ==================== */
// 1. 加载笔记（原有：保留）
async function loadNotes() {
    if (sharePermission) {
        document.getElementById('sidebar').style.display = 'none';
        if (sharedNoteId) await openNote(sharedNoteId, null);
        return;
    }
    try {
        const res = await fetch('/api/notes');
        if (!res.ok) throw new Error('加载失败');
        allNotes = await res.json();
        renderNotesList(allNotes);
    } catch (e) {
        console.error(e);
        showToast('加载笔记失败');
    }
}

// 2. 渲染笔记列表（原有：支持分类/标签筛选后的列表）
function renderNotesList(notes) {
    notesListEl.innerHTML = '';
    notes.forEach(note => {
        const el = document.createElement('div');
        el.className = `note-item ${currentNoteId === note.id ? 'active' : ''}`;
        el.dataset.id = note.id;
        el.dataset.type = note.type;
        const icon = note.type === 'richtext' ? 'fa-file-text-o' : 'fa-markdown';
        const updated = new Date(note.updated_at).toLocaleString();
        el.innerHTML = `
            <div class="note-title"><i class="fa ${icon}"></i><span>${note.title}</span></div>
            <div class="note-meta">
                <span>更新于 ${updated}</span>
                ${note.category_id ? `<span style="margin-left:8px;">${allCategories.find(c => c.id === note.category_id)?.name}</span>` : ''}
                ${note.tag_ids.length ? `<span style="margin-left:8px;">${note.tag_ids.map(id => allTags.find(t => t.id === id)?.name).join(',')}</span>` : ''}
            </div>
        `;
        el.addEventListener('click', () => openNote(note.id, note.type));
        notesListEl.appendChild(el);
    });
}

// 3. 打开新建笔记弹窗（修改：重置分类和标签选中状态）
function openCreateModal() {
    createModal.style.display = 'flex';
    noteTitleInput.focus();
    noteTitleInput.value = '';
    noteCategorySelect.value = '';
    selectedTagIds = [];
    renderSelectedTags();
}

// 4. 关闭新建笔记弹窗（原有：保留）
function closeCreateModal() {
    createModal.style.display = 'none';
}

// 5. 新建笔记（修改：传递分类和标签）
async function confirmCreateNote() {
    const title = noteTitleInput.value.trim() || '无标题笔记';
    const type = document.querySelector('input[name="note-type"]:checked').value;
    const categoryId = noteCategorySelect.value || null;  // 新增：分类ID

    try {
        const res = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title,
                type,
                category_id: categoryId,  // 新增：传递分类ID
                tag_ids: selectedTagIds    // 新增：传递选中的标签ID
            })
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || '创建笔记失败');
        }
        const newNote = await res.json();
        allNotes.unshift(newNote);
        renderNotesList(allNotes);
        openNote(newNote.id, newNote.type);
        closeCreateModal();
        showToast('笔记创建成功');
    } catch (e) {
        console.error(e);
        showToast(e.message);
    }
}

// 6. 打开笔记（修改：加载笔记的分类和标签）
async function openNote(id, type) {
    try {
        const res = await fetch(`/api/notes/${id}`);
        if (!res.ok) throw new Error('打开失败');
        const note = await res.json();
        currentNoteId = id;
        currentNoteType = type || note.type;
        currentNoteData = note;

        // 高亮选中笔记
        document.querySelectorAll('.note-item').forEach(el =>
            el.classList.toggle('active', el.dataset.id == id));

        // 显示对应编辑器（调用修改后的switchEditor）
        switchEditor(currentNoteType);

        // 填充内容
        if (currentNoteType === 'richtext') {
            quillEditor.root.innerHTML = note.content || '';
        } else {
            const defaultContent = note.content || '# 请输入 Markdown 内容\n\n- 支持粗体 **bold**\n- 支持斜体 *italic*\n- 支持标题 # H1';
            markdownEditor.setValue(defaultContent);
            updateMarkdownPreview();
        }

        // 加载笔记的分类和标签（仅在非共享模式下显示）
        if (!shareToken) {
            noteCategorySelect.value = note.category_id || '';
            selectedTagIds = note.tag_ids || [];
            renderSelectedTags();
        }

        emptyState.style.display = 'none';

        // 如果是共享模式，根据权限设置编辑器状态
        if (shareToken) {
            if (sharePermission === 'view') {
                disableEditors();
            } else if (sharePermission === 'edit') {
                enableEditors();
            }
        }
    } catch (e) {
        console.error(e);
        showToast('打开笔记失败');
    }
}

// 7. 保存笔记（修改：保存分类和标签）
async function saveCurrentNote() {
    if (!currentNoteId) {
        showToast('请先选择或创建笔记');
        return;
    }

    // 获取编辑器内容
    const content = currentNoteType === 'richtext'
        ? quillEditor.root.innerHTML
        : markdownEditor.getValue();

    // 构造请求头（支持共享模式）
    const headers = {'Content-Type': 'application/json'};
    if (shareToken) {
        headers['X-Share-Token'] = shareToken;

        // 在共享模式下，只能保存内容，不能修改分类和标签
        const res = await fetch(`/api/notes/${currentNoteId}`, {
            method: 'PUT',
            headers,
            body: JSON.stringify({
                content: content
            })
        });

        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || '保存失败');
        }

        showToast('笔记保存成功');
        return;
    }

    // 正常模式下的保存（包含分类和标签）
    try {
        const res = await fetch(`/api/notes/${currentNoteId}`, {
            method: 'PUT',
            headers,
            body: JSON.stringify({
                title: currentNoteData.title,
                type: currentNoteType,
                content,
                category_id: noteCategorySelect.value || null,
                tag_ids: selectedTagIds
            })
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || '保存失败');
        }

        currentNoteData.content = content;
        currentNoteData.updated_at = new Date().toISOString();
        currentNoteData.category_id = noteCategorySelect.value || null;
        currentNoteData.tag_ids = selectedTagIds;
        await loadNotes();
        showToast('笔记保存成功');
    } catch (e) {
        console.error(e);
        showToast(e.message || '保存笔记失败');
    }
}

// 8. 筛选笔记（修改：支持分类+标签+搜索组合筛选）
function filterNotes() {
    let filtered = [...allNotes];
    const keyword = searchInput.value.trim().toLowerCase();

    // 1. 分类筛选
    if (currentCategoryFilter !== 'all') {
        filtered = filtered.filter(note =>
            currentCategoryFilter === 'none'
                ? !note.category_id  // 未分类
                : note.category_id == currentCategoryFilter  // 指定分类
        );
    }

    // 2. 标签筛选
    if (currentTagFilter !== 'all') {
        filtered = filtered.filter(note =>
            note.tag_ids && note.tag_ids.includes(parseInt(currentTagFilter))
        );
    }

    // 3. 关键词搜索（原有）
    if (keyword) {
        filtered = filtered.filter(note =>
            note.title.toLowerCase().includes(keyword)
        );
    }

    renderNotesList(filtered);
}

// 9. 按分类筛选
function filterByCategory(categoryId) {
    currentCategoryFilter = categoryId;
    // 更新分类筛选按钮的激活状态
    document.querySelectorAll('.category-item').forEach(el =>
        el.classList.toggle('active', el.dataset.id == categoryId)
    );
    filterNotes();  // 触发筛选
}

// 10. 按标签筛选
function filterByTag(tagId) {
    currentTagFilter = tagId;
    // 更新标签筛选按钮的激活状态
    document.querySelectorAll('.tag-item').forEach(el =>
        el.classList.toggle('active', el.dataset.id == tagId)
    );
    filterNotes();  // 触发筛选
}

/* ==================== 核心修改：双向限制的编辑器切换函数 ==================== */
function switchEditor(targetType) {
    // 1. 未打开任何笔记（新建状态）：允许自由切换，不提示
    if (!currentNoteId) {
        currentNoteType = targetType;
        updateEditorDisplay(targetType);
        return;
    }

    // 2. 已打开笔记：判断当前类型与目标类型是否一致
    const currentType = currentNoteType;
    if (currentType !== targetType) {
        // 类型不一致：提示并阻止切换
        const currentTypeName = currentType === 'richtext' ? '富文本' : 'Markdown';
        const targetTypeName = targetType === 'richtext' ? '富文本' : 'Markdown';
        showToast(`当前为${currentTypeName}文档，不支持切换到${targetTypeName}模式`);
        return;
    }

    // 3. 类型一致：正常切换编辑器显示
    updateEditorDisplay(targetType);
}

// 辅助函数：更新编辑器显示状态（原有逻辑提取，避免重复代码）
function updateEditorDisplay(targetType) {
    // 切换编辑器容器显示
    if (targetType === 'richtext') {
        richtextContainer.style.display = 'block';
        markdownContainer.style.display = 'none';
    } else {
        richtextContainer.style.display = 'none';
        markdownContainer.style.display = 'flex';
        updateMarkdownPreview(); // Markdown模式需刷新预览
    }

    // 更新按钮激活状态
    richtextBtn.classList.toggle('active', targetType === 'richtext');
    markdownBtn.classList.toggle('active', targetType === 'markdown');
}

/* ==================== 原有辅助功能（保留） ==================== */
// Markdown 工具栏命令（原有）
function handleMarkdownCmd(cmd) {
    const cm = markdownEditor;
    const doc = cm.getDoc();
    const sel = doc.getSelection();
    let replaceText = '';

    switch (cmd) {
        case 'bold':   replaceText = `**${sel || '粗体文字'}**`; break;
        case 'italic': replaceText = `*${sel || '斜体文字'}*`; break;
        case 'h1':     replaceText = `# ${sel || '标题 1'}`; break;
        case 'h2':     replaceText = `## ${sel || '标题 2'}`; break;
        case 'ul':     replaceText = sel ? sel.split('\n').map(l => `- ${l}`).join('\n') : '- 列表项'; break;
        case 'code':   replaceText = `\`\`\`\n${sel || '代码块'}\n\`\`\``; break;
        case 'link':   replaceText = `[${sel || '链接文字'}](http://)`; break;
        default:       replaceText = sel;
    }

    doc.replaceSelection(replaceText);
    cm.focus();
}

// 更新 Markdown 预览（原有）
function updateMarkdownPreview() {
    const md = markdownEditor.getValue();
    document.getElementById('markdown-preview').innerHTML = marked.parse(md);
    if (currentNoteData) currentNoteData.content = md;
}

// 在分享弹窗中添加有效期选择
function openShareModal() {
    if (!currentNoteId) {
        showToast('请先选择笔记');
        return;
    }
    shareLinkInput.value = '';

    // 重置选择
    document.getElementById('share-expires').value = '7days';
    document.getElementById('share-custom-expires').value = '';
    document.getElementById('custom-expires-group').style.display = 'none';

    shareModal.style.display = 'flex';
}

// 修改生成分享链接函数，支持自定义有效期
async function generateShareLink() {
    if (!currentNoteId) return;
    const permission = sharePermissionSelect.value;
    const expiresSelect = document.getElementById('share-expires');
    const customExpiresInput = document.getElementById('share-custom-expires');

    let expire_at = null;
    const expiresValue = expiresSelect.value;

    if (expiresValue === 'custom' && customExpiresInput.value) {
        // 自定义时间 - 直接使用用户选择的时间
        expire_at = customExpiresInput.value + ':00'; // 添加秒数
    } else if (expiresValue && expiresValue !== 'never') {
        // 预设时间 - 使用当前本地时间计算
        const now = new Date();
        switch (expiresValue) {
            case '1min':
                now.setMinutes(now.getMinutes() + 1);
                break;
            case '1hour':
                now.setHours(now.getHours() + 1);
                break;
            case '1day':
                now.setDate(now.getDate() + 1);
                break;
            case '3days':
                now.setDate(now.getDate() + 3);
                break;
            case '7days':
                now.setDate(now.getDate() + 7);
                break;
            case '30days':
                now.setDate(now.getDate() + 30);
                break;
        }
        // 转换为 ISO 字符串，但保持本地时间
        expire_at = formatLocalToISO(now);
    }

    try {
        const res = await fetch('/api/share', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                note_id: currentNoteId,
                permission,
                expires_at: expire_at
            })
        });
        if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || '生成链接失败');
        }
        const data = await res.json();
        shareLinkInput.value = data.share_url;

        // 显示有效期信息 - 使用后端返回的时间
        let expiresText = ' - 权限：' + (permission === 'edit' ? '可编辑' : '只读');
        if (data.expire_at) {
            const expireDate = new Date(data.expire_at);
            // 直接显示本地时间，避免时区转换问题
            const localDateStr = expireDate.toLocaleDateString('zh-CN');
            const localTimeStr = expireDate.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            expiresText = `（将在 ${localDateStr} ${localTimeStr} 过期）` + expiresText;
        } else {
            expiresText = '（永久有效）' + expiresText;
        }
        showToast('链接生成成功' + expiresText);
    } catch (e) {
        console.error('生成分享链接失败：', e);
        showToast(e.message || '生成链接失败');
    }
}

// 辅助函数：将本地时间转换为 ISO 格式字符串（不带时区）
function formatLocalToISO(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
}

// 复制分享链接（原有）
function copyShareLink() {
    const link = shareLinkInput.value;
    if (!link) {
        showToast('请先生成链接');
        return;
    }
    navigator.clipboard.writeText(link).then(() => {
        showToast('链接已复制');
    }).catch(() => {
        // 降级处理：创建临时输入框复制
        const input = document.createElement('input');
        input.value = link;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('链接已复制（兼容模式）');
    });
}

// 删除当前笔记（原有）
async function deleteCurrentNote() {
    if (!currentNoteId) {
        showToast('请先选择笔记');
        return;
    }
    if (!confirm('确定要删除这篇笔记吗？删除后无法恢复！')) return;

    try {
        const res = await fetch(`/api/notes/${currentNoteId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('删除失败');

        // 重置状态并重新加载笔记
        currentNoteId = null;
        currentNoteType = null;
        currentNoteData = null;
        selectedTagIds = [];
        await loadNotes();
        showEmptyState();
        showToast('笔记已删除');
    } catch (e) {
        console.error(e);
        showToast('删除笔记失败');
    }
}

// 打开导出弹窗（原有）
function openExportModal() {
    if (!currentNoteId) {
        showToast('请先选择笔记');
        return;
    }
    exportModal.style.display = 'flex';
}

// 导出笔记（原有）
function exportNote(format) {
    if (!currentNoteId) return;
    const exportUrl = `/api/notes/${currentNoteId}/export?format=${format}`;
    // 新窗口打开导出链接（触发下载）
    window.open(exportUrl, '_blank');
    exportModal.style.display = 'none';
    showToast(`正在导出为 ${format.toUpperCase()} 文件`);
}

// 显示空状态（原有）
function showEmptyState() {
    richtextContainer.style.display = 'none';
    markdownContainer.style.display = 'none';
    emptyState.style.display = 'flex';
}

// 显示提示（原有）
function showToast(message) {
    toast.textContent = message;
    toast.className = 'show';
    setTimeout(() => {
        toast.className = '';
    }, 3000);
}

// 初始化应用（必须调用，确保所有功能启动）
init();
</script>
</body>
</html>